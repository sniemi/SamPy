

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>SamPy.stis.STISCCDSpectroscopyFlat &mdash; SamPy v0.1 documentation</title>
    <link rel="stylesheet" href="../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="SamPy v0.1 documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body>

<div style="background-color: white; text-align: left; padding: 10px 10px 15px 15px">
</div>

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">home</a>|&nbsp;</li>
        <li><a href="../../../search.html">search</a>|&nbsp;</li>

          <li><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>

      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" size="18" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for SamPy.stis.STISCCDSpectroscopyFlat</h1><div class="highlight"><pre>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Creates STIS Spectroscopic pixel-to-pixel flat fields from RAW data.</span>
<span class="sd">Uses spline fits after dust motes, bad pixels, etc. have been masked</span>
<span class="sd">to fit and to remove the low frequency structure. The data are divided</span>
<span class="sd">by each fit to normalize the data before it is combined and co-added with</span>
<span class="sd">appropriate weighting of flux errors.</span>

<span class="sd">Both 50CCD and 52x2 data can be used. For 52x2 row fitting is not</span>
<span class="sd">done currently due to emission lines in the lamp spectrum.</span>

<span class="sd">For more information see STIS ISR 1999-06 by Bohlin and TIR 2010 by Niemi.</span>

<span class="sd">:requires: Python 2.5 or later (not 3.x compatible however)</span>
<span class="sd">:requires: NumPy</span>
<span class="sd">:requires: PyFITS</span>
<span class="sd">:requires: SciPy</span>
<span class="sd">:requires: matplotlib</span>

<span class="sd">TESTED:</span>
<span class="sd">Python 2.5.4</span>
<span class="sd">NumPy 1.4.0.dev7576</span>
<span class="sd">SciPy</span>
<span class="sd">PyFITS 2.2.2</span>
<span class="sd">matplotlib 1.0.svn</span>

<span class="sd">:date: created on November 23, 2009</span>

<span class="sd">:version: 0.6</span>
<span class="sd">VERSION HISTORY:</span>
<span class="sd">0.1: testing version (SMN)</span>
<span class="sd">0.2: test release (SMN)</span>
<span class="sd">0.3: first full working version (SMN)</span>
<span class="sd">0.4: modified FITS output to comply with CDBS rules (SMN)</span>
<span class="sd">0.5: improved documentation (SMN)</span>
<span class="sd">0.6: fixed and imporved _badspot function (SMN)</span>

<span class="sd">:author: Sami-Matias Niemi</span>
<span class="sd">:organization: STScI</span>
<span class="sd">:contact: niemi@stsci.edu</span>

<span class="sd">:todo: For improved median filter, one could use scipy.ndimage.filters.median_filter</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="kn">import</span> <span class="nn">matplotlib</span>

<span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s">&#39;PDF&#39;</span><span class="p">)</span>
<span class="n">matplotlib</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s">&#39;legend.fontsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">9</span>
<span class="kn">import</span> <span class="nn">pyfits</span> <span class="kn">as</span> <span class="nn">PF</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">N</span>
<span class="kn">import</span> <span class="nn">pylab</span> <span class="kn">as</span> <span class="nn">PL</span>
<span class="kn">import</span> <span class="nn">scipy.signal</span> <span class="kn">as</span> <span class="nn">SS</span>
<span class="kn">import</span> <span class="nn">scipy.interpolate</span> <span class="kn">as</span> <span class="nn">I</span>
<span class="kn">import</span> <span class="nn">scipy.optimize</span> <span class="kn">as</span> <span class="nn">O</span>
<span class="kn">import</span> <span class="nn">glob</span> <span class="kn">as</span> <span class="nn">G</span>
<span class="kn">import</span> <span class="nn">datetime</span> <span class="kn">as</span> <span class="nn">D</span>
<span class="kn">from</span> <span class="nn">pyraf.iraf</span> <span class="kn">import</span> <span class="n">stsdas</span><span class="p">,</span> <span class="n">hst_calib</span><span class="p">,</span> <span class="n">stis</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">cm</span>
<span class="kn">from</span> <span class="nn">matplotlib.patches</span> <span class="kn">import</span> <span class="n">Circle</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">os.path</span><span class="o">,</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">shutil</span>

<span class="n">__author__</span> <span class="o">=</span> <span class="s">&#39;Sami-Matias Niemi&#39;</span>
<span class="n">__version__</span> <span class="o">=</span> <span class="s">&#39;0.5&#39;</span>

<div class="viewcode-block" id="Findfiles"><a class="viewcode-back" href="../../../SamPy.stis.html#SamPy.stis.STISCCDSpectroscopyFlat.Findfiles">[docs]</a><span class="k">class</span> <span class="nc">Findfiles</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Finds all files that are suitable for making a STIS CCD</span>
<span class="sd">    spectroscopy flat field. Searches from input directory</span>
<span class="sd">    all files that math the extension.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">extension</span><span class="o">=</span><span class="s">&#39;_raw&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Note that the detector (CCD) and optical element (G430M)</span>
<span class="sd">        has been hard coded to the self.obsmode dictionary.</span>
<span class="sd">        :param input: an input directory</span>
<span class="sd">        :param output: an output directory</span>
<span class="sd">        :param extension: an extension that used used to identify files  </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span> <span class="nb">input</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="n">output</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extension</span> <span class="o">=</span> <span class="n">extension</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obsmode</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;DETECTOR&#39;</span><span class="p">:</span> <span class="s">&#39;CCD&#39;</span><span class="p">,</span> <span class="s">&#39;OPT_ELEM&#39;</span><span class="p">:</span> <span class="s">&#39;G430M&#39;</span><span class="p">}</span>

<div class="viewcode-block" id="Findfiles.obsMode"><a class="viewcode-back" href="../../../SamPy.stis.html#SamPy.stis.STISCCDSpectroscopyFlat.Findfiles.obsMode">[docs]</a>    <span class="k">def</span> <span class="nf">obsMode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filelist</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Checks that the observation mode matches.</span>
<span class="sd">        Uses the hard coded self.obsmode dictionary.</span>
<span class="sd">        :param filelist: a list of file names to be tested.</span>
<span class="sd">        :return: a list of file names that are of right obsmode.  </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="nb">file</span> <span class="ow">in</span> <span class="n">filelist</span><span class="p">:</span>
            <span class="n">hdr</span> <span class="o">=</span> <span class="n">PF</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="nb">file</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">obsmode</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">obsmode</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">!=</span> <span class="n">hdr</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                    <span class="n">ok</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>
</div>
<div class="viewcode-block" id="Findfiles.gain"><a class="viewcode-back" href="../../../SamPy.stis.html#SamPy.stis.STISCCDSpectroscopyFlat.Findfiles.gain">[docs]</a>    <span class="k">def</span> <span class="nf">gain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filelist</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Checks that gain equals the given value.</span>
<span class="sd">        :param filelist: a list of file names to be tested</span>
<span class="sd">        :param value: a gain value that the gain have to match</span>
<span class="sd">        :return: a list of file names that match the gain value</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="nb">file</span> <span class="ow">in</span> <span class="n">filelist</span><span class="p">:</span>
            <span class="n">hdr</span> <span class="o">=</span> <span class="n">PF</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input</span> <span class="o">+</span> <span class="nb">file</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
            <span class="k">if</span> <span class="n">hdr</span><span class="p">[</span><span class="s">&#39;CCDGAIN&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">value</span><span class="p">:</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>
</div>
<div class="viewcode-block" id="Findfiles.apertureFilter"><a class="viewcode-back" href="../../../SamPy.stis.html#SamPy.stis.STISCCDSpectroscopyFlat.Findfiles.apertureFilter">[docs]</a>    <span class="k">def</span> <span class="nf">apertureFilter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filelist</span><span class="p">,</span> <span class="n">aperture</span><span class="o">=</span><span class="s">&#39;50CCD&#39;</span><span class="p">,</span> <span class="nb">filter</span><span class="o">=</span><span class="s">&#39;Clear&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Checks that the aperture and filer matches the given ones.</span>
<span class="sd">        :param filelist: a list of file names to be tested.</span>
<span class="sd">        :param aperture: an aperture that the tested file must match.</span>
<span class="sd">        :param filter: a filter that the tested file must match.</span>
<span class="sd">        :return: a list of file names that match the aperture and filter.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c">#another possibility could be:</span>
        <span class="c">#APER_FOV= &#39;50x50           &#39;   / aperture field of view</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="nb">file</span> <span class="ow">in</span> <span class="n">filelist</span><span class="p">:</span>
            <span class="n">hdr</span> <span class="o">=</span> <span class="n">PF</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input</span> <span class="o">+</span> <span class="nb">file</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
            <span class="k">if</span> <span class="n">hdr</span><span class="p">[</span><span class="s">&#39;APERTURE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="n">aperture</span> <span class="ow">and</span>\
               <span class="n">hdr</span><span class="p">[</span><span class="s">&#39;FILTER&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="nb">filter</span><span class="p">:</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>
</div>
<div class="viewcode-block" id="Findfiles.cenwave"><a class="viewcode-back" href="../../../SamPy.stis.html#SamPy.stis.STISCCDSpectroscopyFlat.Findfiles.cenwave">[docs]</a>    <span class="k">def</span> <span class="nf">cenwave</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filelist</span><span class="p">,</span> <span class="n">cenwave</span><span class="o">=</span><span class="mi">5216</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Checks that the central wavelength matches.</span>
<span class="sd">        :param filelist: a list of file names to be tested.</span>
<span class="sd">        :param cenwave: a central wavelength that the test file must match.</span>
<span class="sd">        :return a list of file names that match the aperture and filter.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="nb">file</span> <span class="ow">in</span> <span class="n">filelist</span><span class="p">:</span>
            <span class="n">hdr</span> <span class="o">=</span> <span class="n">PF</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input</span> <span class="o">+</span> <span class="nb">file</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
            <span class="k">if</span> <span class="n">hdr</span><span class="p">[</span><span class="s">&#39;CENWAVE&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cenwave</span><span class="p">:</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>
</div>
<div class="viewcode-block" id="Findfiles.slitwheelPos"><a class="viewcode-back" href="../../../SamPy.stis.html#SamPy.stis.STISCCDSpectroscopyFlat.Findfiles.slitwheelPos">[docs]</a>    <span class="k">def</span> <span class="nf">slitwheelPos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filelist</span><span class="p">,</span> <span class="n">positions</span><span class="p">,</span> <span class="n">nominal</span><span class="p">,</span> <span class="n">tolerance</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Finds and matches all slit wheel positions present in files listed in</span>
<span class="sd">        the filelist variable.</span>
<span class="sd">        :param filelist: a list of file names to be tested.</span>
<span class="sd">        :param positions: a list of positions that are used for matching.</span>
<span class="sd">        :param nominal: the nominal slit wheel position.      </span>
<span class="sd">        :param tolerance: tolerance of slit wheel steps.</span>
<span class="sd">        :return: dictionary of slit wheel positions and file names  </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c">#find all OSWABPS</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="nb">file</span> <span class="ow">in</span> <span class="n">filelist</span><span class="p">:</span>
            <span class="n">hdr1</span> <span class="o">=</span> <span class="n">PF</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input</span> <span class="o">+</span> <span class="nb">file</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
            <span class="n">tmp</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">file</span><span class="p">,</span> <span class="n">hdr1</span><span class="p">[</span><span class="s">&#39;OSWABSP&#39;</span><span class="p">]])</span>

        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">positions</span><span class="p">:</span>
            <span class="n">pos</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">tmp</span> <span class="k">if</span>
                      <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">nominal</span> <span class="o">+</span> <span class="n">a</span> <span class="o">-</span> <span class="n">tolerance</span> <span class="ow">and</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">nominal</span> <span class="o">+</span> <span class="n">a</span> <span class="o">+</span> <span class="n">tolerance</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">pos</span>
</div>
<div class="viewcode-block" id="Findfiles.writeToASCIIFile"><a class="viewcode-back" href="../../../SamPy.stis.html#SamPy.stis.STISCCDSpectroscopyFlat.Findfiles.writeToASCIIFile">[docs]</a>    <span class="k">def</span> <span class="nf">writeToASCIIFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">outputfile</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Writes file lists to an ASCII file. Each line contains one filename.</span>
<span class="sd">        :param data: data that is written to the ascii file.</span>
<span class="sd">        :param outputfile: the name of the output file.</span>
<span class="sd">        :param header: header that is included to the beginning of the ascii file.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input</span> <span class="o">+</span> <span class="n">outputfile</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;Problem while opening file </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">outputfile</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span> <span class="k">pass</span>

</div></div>
<div class="viewcode-block" id="PrepareFiles"><a class="viewcode-back" href="../../../SamPy.stis.html#SamPy.stis.STISCCDSpectroscopyFlat.PrepareFiles">[docs]</a><span class="k">class</span> <span class="nc">PrepareFiles</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Prepares files; modified header keywords.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="n">output</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Note that switches dictionary has been hard coded.</span>
<span class="sd">        It currently only changes the CRCORR keyword.</span>
<span class="sd">        :param input: an input directory</span>
<span class="sd">        :param output: an output directory</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span> <span class="nb">input</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="n">output</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">switches</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;CRCORR&#39;</span><span class="p">:</span> <span class="s">&#39;PERFORM&#39;</span><span class="p">}</span>

<div class="viewcode-block" id="PrepareFiles.changeKeywords"><a class="viewcode-back" href="../../../SamPy.stis.html#SamPy.stis.STISCCDSpectroscopyFlat.PrepareFiles.changeKeywords">[docs]</a>    <span class="k">def</span> <span class="nf">changeKeywords</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filelist</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Modifies header keywords of FITS files.</span>
<span class="sd">        Switches self.switches keywords.</span>
<span class="sd">        :param filelist: a list of filenames </span>
<span class="sd">        :todo: This will now crash if the keyword is not present...</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">for</span> <span class="nb">file</span> <span class="ow">in</span> <span class="n">filelist</span><span class="p">:</span>
            <span class="n">fh</span> <span class="o">=</span> <span class="n">PF</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="s">&#39;update&#39;</span><span class="p">)</span>
            <span class="n">hdr0</span> <span class="o">=</span> <span class="n">fh</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">switches</span><span class="p">:</span>
                <span class="n">hdr0</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">switches</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

</div></div>
<div class="viewcode-block" id="MakeFlat"><a class="viewcode-back" href="../../../SamPy.stis.html#SamPy.stis.STISCCDSpectroscopyFlat.MakeFlat">[docs]</a><span class="k">class</span> <span class="nc">MakeFlat</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This class can be used to generate a pixel-to-pixel flat field </span>
<span class="sd">    from given data files.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="n">output</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        :param input: an input directory</span>
<span class="sd">        :param output: an output directory  </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span> <span class="nb">input</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="n">output</span>

    <span class="k">def</span> <span class="nf">_plot50</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flat</span><span class="p">,</span> <span class="n">xcen</span><span class="p">,</span> <span class="n">ycen</span><span class="p">,</span> <span class="n">rad</span><span class="p">,</span> <span class="n">fname</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        This function can be used to plot flat file images where</span>
<span class="sd">        dust motes have been circled. Will save the output figure</span>
<span class="sd">        to fname.pdf.</span>
<span class="sd">        :param flat: flat field array</span>
<span class="sd">        :param xcen: a list of x central coordinates for dust motes</span>
<span class="sd">        :param ycen: a list of y central coordinates for dust motes</span>
<span class="sd">        :param rad: a list of radius for dust motest   </span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">ax</span> <span class="o">=</span> <span class="n">PL</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">PL</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="c">#P.title(fname)</span>

        <span class="n">ims</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">flat</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s">&#39;lower&#39;</span><span class="p">,</span>
                        <span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">gray</span><span class="p">,</span>
                        <span class="n">interpolation</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                        <span class="n">vmin</span><span class="o">=</span><span class="mf">0.98</span><span class="p">,</span>
                        <span class="n">vmax</span><span class="o">=</span><span class="mf">1.02</span><span class="p">)</span>
        <span class="n">cb</span> <span class="o">=</span> <span class="n">PL</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">ims</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s">&#39;vertical&#39;</span><span class="p">)</span>
        <span class="n">cb</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s">&#39;Normalized Counts&#39;</span><span class="p">)</span>

        <span class="c">#loop over xcen and ycen and ratio and draw circles</span>
        <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">xcen</span><span class="p">,</span> <span class="n">ycen</span><span class="p">,</span> <span class="n">rad</span><span class="p">):</span>
            <span class="n">cir</span> <span class="o">=</span> <span class="n">Circle</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">radius</span><span class="o">=</span><span class="n">r</span><span class="p">,</span> <span class="n">fc</span><span class="o">=</span><span class="s">&#39;none&#39;</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="s">&#39;r&#39;</span><span class="p">)</span>
            <span class="n">b</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">cir</span><span class="p">)</span>

        <span class="c">#PL.show()         </span>
        <span class="n">PL</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fname</span> <span class="o">+</span> <span class="s">&#39;.pdf&#39;</span><span class="p">)</span>
        <span class="n">PL</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_plotFit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xpx</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">fit</span><span class="p">,</span> <span class="n">good</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">xnod</span><span class="p">,</span> <span class="n">ynod</span><span class="p">,</span> <span class="n">fitynods</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="nb">file</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Plot Spline fit and the data for comparison for ith row or column.</span>
<span class="sd">        Will also plot median filtered data for columns. The plot is saved </span>
<span class="sd">        to file_tmp_Fit.pdf</span>
<span class="sd">        :param xpx: x pixels</span>
<span class="sd">        :param img: y (counts) values</span>
<span class="sd">        :param fit: fitted y values</span>
<span class="sd">        :param good: mask that specifies good pixels</span>
<span class="sd">        :param i: the ith row or column</span>
<span class="sd">        :param xnod: a list of x node positions</span>
<span class="sd">        :param ynod: a list of original y node positions</span>
<span class="sd">        :param fitynods: a list of fitted y node positions</span>
<span class="sd">        :param tmp: median filtered count values</span>
<span class="sd">        :param file: the name of the file that is being plotted</span>
<span class="sd">        :param column: Boolean to define whether this is a column or row fit plot        </span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">PL</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="c">#P.title(file)</span>

        <span class="n">left</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.8</span>
        <span class="n">rect1</span> <span class="o">=</span> <span class="p">[</span><span class="n">left</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="mf">0.65</span><span class="p">]</span>
        <span class="n">rect2</span> <span class="o">=</span> <span class="p">[</span><span class="n">left</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">]</span>

        <span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">(</span><span class="n">rect2</span><span class="p">)</span>  <span class="c">#left, bottom, width, height</span>
        <span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">(</span><span class="n">rect1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">column</span><span class="p">:</span> <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xpx</span><span class="p">,</span> <span class="n">img</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="s">&#39;b-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&#39;Data&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xpx</span><span class="p">,</span> <span class="n">img</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:],</span> <span class="s">&#39;b-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&#39;Data&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">column</span><span class="p">:</span> <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xpx</span><span class="p">[</span><span class="n">good</span><span class="p">],</span> <span class="n">tmp</span><span class="p">[</span><span class="n">good</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="s">&#39;y-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&#39;Median Filtered&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">column</span><span class="p">:</span> <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xpx</span><span class="p">,</span> <span class="n">fit</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="s">&#39;r-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&#39;Spline Fit&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xpx</span><span class="p">,</span> <span class="n">fit</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:],</span> <span class="s">&#39;r-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&#39;Spline Fit&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xpx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cspline</span><span class="p">(</span><span class="n">xnod</span><span class="p">,</span> <span class="n">ynod</span><span class="p">,</span> <span class="n">xpx</span><span class="p">),</span> <span class="s">&#39;m-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&#39;Original Spline&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xnod</span><span class="p">,</span> <span class="n">ynod</span><span class="p">,</span> <span class="s">&#39;ms&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&#39;Original Nods&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xnod</span><span class="p">,</span> <span class="n">fitynods</span><span class="p">,</span> <span class="s">&#39;ro&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&#39;Fitted Nods&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">column</span><span class="p">:</span> <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xpx</span><span class="p">,</span> <span class="n">fit</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">img</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="s">&#39;r-&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xpx</span><span class="p">,</span> <span class="n">fit</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">/</span> <span class="n">img</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:],</span> <span class="s">&#39;r-&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

        <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1025</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1025</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mf">0.98</span> <span class="o">*</span> <span class="n">N</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="n">good</span><span class="p">,</span> <span class="n">i</span><span class="p">]),</span> <span class="mf">1.02</span> <span class="o">*</span> <span class="n">N</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="n">good</span><span class="p">,</span> <span class="n">i</span><span class="p">]))</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mf">0.95</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mf">0.95</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">)</span>

        <span class="n">ax2</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">ax2</span><span class="o">.</span><span class="n">get_yticks</span><span class="p">()[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="c">#ax1.set_yticks(ax1.get_yticks()[::2])</span>

        <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">&#39;Fit / Data&#39;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">&#39;Counts&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">column</span><span class="p">:</span> <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">&#39;Column </span><span class="si">%i</span><span class="s"> Pixels&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">&#39;Row </span><span class="si">%i</span><span class="s"> Pixels&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">numpoints</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">shadow</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">fancybox</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s">&#39;best&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s">&#39;best&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">column</span><span class="p">:</span> <span class="n">tmp</span> <span class="o">=</span> <span class="s">&#39;Column&#39;</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">tmp</span> <span class="o">=</span> <span class="s">&#39;Row&#39;</span>

        <span class="n">PL</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="nb">file</span> <span class="o">+</span> <span class="s">&#39;_</span><span class="si">%s</span><span class="s">Fit.pdf&#39;</span> <span class="o">%</span> <span class="n">tmp</span><span class="p">)</span>
        <span class="n">PL</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_badspot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">opt_elem</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Loads SMNdust.stis file that holds information about dust speck</span>
<span class="sd">        locations and sizes. It will return a mask where all dust motes</span>
<span class="sd">        have been marked. The function can be used for both L and M-modes</span>
<span class="sd">        as M-modes are shifted 2 pixels to left and their radius is set </span>
<span class="sd">        to 16, except for the first two dust specks which are smaller.</span>
<span class="sd">        :summary: Adds dust motes to bad pixel mask. </span>
<span class="sd">        :param mask: array of the same size as the image that is used to mask</span>
<span class="sd">        areas such as dust motes that should not be used for fitting.</span>
<span class="sd">        :param opt_elem: optical element that was used; L or M -mode</span>
<span class="sd">        :return: updated mask, x_centre, y_centre, radius of dust specks</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c"># mask indices</span>
        <span class="n">y</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">indices</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="c">#read the dust file       </span>
        <span class="n">dust</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s">&#39;SMNdust.stis&#39;</span><span class="p">,</span> <span class="n">comments</span><span class="o">=</span><span class="s">&#39;#&#39;</span><span class="p">)</span>
        <span class="n">xcen</span> <span class="o">=</span> <span class="n">dust</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">ycen</span> <span class="o">=</span> <span class="n">dust</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>

        <span class="c">#first 2 spots on spectrum &amp; are small. cut size</span>
        <span class="n">rad</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">dust</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="mi">12</span>
        <span class="n">rad</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">4</span>
        <span class="c">#; 99jun10 - shift stis medium disp spots left </span>
        <span class="k">if</span> <span class="s">&#39;M&#39;</span> <span class="ow">in</span> <span class="n">opt_elem</span><span class="p">:</span>
            <span class="c">#shifting badspots to left</span>
            <span class="k">print</span><span class="s">&#39;STIS Med resolution grating. Shifting badspots left.&#39;</span>
            <span class="n">xcen</span> <span class="o">-=</span> <span class="mi">2</span>
            <span class="n">rad</span> <span class="o">=</span> <span class="n">rad</span> <span class="o">*</span> <span class="mi">0</span> <span class="o">+</span> <span class="mi">16</span>
            <span class="n">rad</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">4</span>     <span class="c"># 1st 2 spots on spectrum &amp; are small. cut size</span>

        <span class="c">#update the mask</span>
        <span class="k">for</span> <span class="n">xc</span><span class="p">,</span> <span class="n">yc</span><span class="p">,</span> <span class="n">rd</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">xcen</span><span class="p">,</span> <span class="n">ycen</span><span class="p">,</span> <span class="n">rad</span><span class="p">):</span>
            <span class="n">xm</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">xc</span>
            <span class="n">ym</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">yc</span>
            <span class="n">radius</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">xm</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">ym</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">msk</span> <span class="o">=</span> <span class="n">radius</span> <span class="o">&lt;</span> <span class="n">rd</span>
            <span class="n">mask</span><span class="p">[</span><span class="n">msk</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">return</span> <span class="n">mask</span><span class="p">,</span> <span class="n">xcen</span><span class="p">,</span> <span class="n">ycen</span><span class="p">,</span> <span class="n">rad</span>

    <span class="k">def</span> <span class="nf">_fitfunc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">ynodes</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        The function that is being fitted.</span>
<span class="sd">        This can be changed to whatever function if needed.</span>
<span class="sd">        Note that ynodes can then be a list of parameters.</span>
<span class="sd">        k defines the order of the spline fitting, it is hard coded</span>
<span class="sd">        to be 3, but could be changed if needed.</span>

<span class="sd">        :param x: the x position where to evaluate the B-spline</span>
<span class="sd">        :param ynodes: y position of the nodes</span>

<span class="sd">        :return: 1-D evaluated B-spline value at x.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">I</span><span class="o">.</span><span class="n">splev</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">I</span><span class="o">.</span><span class="n">splrep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xnodes</span><span class="p">,</span> <span class="n">ynodes</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_errfunc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ynodes</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Error function; simply _fitfunction - ydata</span>

<span class="sd">        :param ynodes: y position of the nodes to be evaluated</span>
<span class="sd">        :param x: x positions where to evaluate the B-spline</span>
<span class="sd">        :param y: y positions</span>

<span class="sd">        :return: Spline evaluated y positions - ydata</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fitfunc</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ynodes</span><span class="p">)</span> <span class="o">-</span> <span class="n">y</span>

    <span class="k">def</span> <span class="nf">_splinefitScipy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">ynodes</span><span class="p">,</span> <span class="n">xnodes</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Return the point which minimizes the sum of squares of M (non-linear)</span>
<span class="sd">        equations in N unknowns given a starting estimate, x0, using a</span>
<span class="sd">        modification of the Levenberg-Marquardt algorithm.</span>

<span class="sd">        :param x:</span>
<span class="sd">        :param y:</span>
<span class="sd">        :param ynodes:</span>
<span class="sd">        :param xnodes:</span>

<span class="sd">        :return: fitted parameters, error/success message</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xnodes</span> <span class="o">=</span> <span class="n">xnodes</span>
        <span class="k">return</span> <span class="n">O</span><span class="o">.</span><span class="n">leastsq</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_errfunc</span><span class="p">,</span> <span class="n">ynodes</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_cspline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Uses interpolation to find the B-spline representation of 1-D curve.</span>

<span class="sd">        :param x: x position</span>
<span class="sd">        :param y: y position</span>
<span class="sd">        :param t: position in which to evaluate the B-spline</span>
<span class="sd">        </span>
<span class="sd">        :return: interpolated y position of the B-sline</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">tck</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">splrep</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="n">y2</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">splev</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">tck</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">y2</span>

    <span class="k">def</span> <span class="nf">_writeCombinedFits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flat</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">dq</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">raws</span><span class="p">,</span> <span class="n">output</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Writes the combined flat field FITS to a file.</span>
<span class="sd">        Uses old reference files as a template.</span>
<span class="sd">        :param flat: flat field array</span>
<span class="sd">        :param err: error array</span>
<span class="sd">        :param dq: data quality array</span>
<span class="sd">        :param head: header dictionary</span>
<span class="sd">        :param template: template file to be used</span>
<span class="sd">        :param raws: list of raw file names that were used to create the flat</span>
<span class="sd">        :param output: name of the output file      </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c">#output = self.output + output  </span>
        <span class="n">fh</span> <span class="o">=</span> <span class="n">PF</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">template</span><span class="p">)</span>

        <span class="n">fh</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">flat</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">fh</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">err</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">fh</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">dq</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>

        <span class="n">hdu0</span> <span class="o">=</span> <span class="n">fh</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
        <span class="n">hdr1</span> <span class="o">=</span> <span class="n">fh</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
        <span class="n">hdr2</span> <span class="o">=</span> <span class="n">fh</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
        <span class="n">hdr3</span> <span class="o">=</span> <span class="n">fh</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>

        <span class="c">#change 0th header keywords DESCRIP to have right length</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">head</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s">&#39;DESCRIP&#39;</span><span class="p">:</span>
                <span class="c">#weird CDBS rule of 67 chars... </span>
                <span class="n">l</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">head</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">l</span> <span class="o">&lt;=</span> <span class="mi">67</span><span class="p">:</span>
                    <span class="n">pad</span> <span class="o">=</span> <span class="s">&#39;-&#39;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">67</span> <span class="o">-</span> <span class="n">l</span><span class="p">)</span>
                    <span class="n">head</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">head</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+</span> <span class="n">pad</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s">&#39;Problem with DESCRIP keyword, will truncate&#39;</span>
                    <span class="n">head</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">head</span><span class="p">[</span><span class="n">key</span><span class="p">][:</span><span class="mi">68</span><span class="p">]</span>
            <span class="n">hdu0</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">head</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

        <span class="c">#hardcoded changes</span>
        <span class="n">hdu0</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s">&#39;ORIGIN&#39;</span><span class="p">,</span> <span class="s">&#39;PyFITS </span><span class="si">%s</span><span class="s"> version&#39;</span> <span class="o">%</span> <span class="n">PF</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
        <span class="n">hdr1</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s">&#39;ORIGIN&#39;</span><span class="p">,</span> <span class="s">&#39;PyFITS </span><span class="si">%s</span><span class="s"> version&#39;</span> <span class="o">%</span> <span class="n">PF</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
        <span class="n">hdr2</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s">&#39;ORIGIN&#39;</span><span class="p">,</span> <span class="s">&#39;PyFITS </span><span class="si">%s</span><span class="s"> version&#39;</span> <span class="o">%</span> <span class="n">PF</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
        <span class="n">hdr3</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s">&#39;ORIGIN&#39;</span><span class="p">,</span> <span class="s">&#39;PyFITS </span><span class="si">%s</span><span class="s"> version&#39;</span> <span class="o">%</span> <span class="n">PF</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
        <span class="n">hdu0</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s">&#39;FILENAME&#39;</span><span class="p">,</span> <span class="n">output</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">):])</span>
        <span class="c">#the first one makes a default FITS comment, but CDBS wants it with equal sign...</span>
        <span class="c">#hdu0.update(&#39;COMMENT&#39;, &#39;Reference file was created by S.-M. Niemi, %s.&#39; % D.datetime.today().strftime(&#39;%B %Y&#39;))</span>
        <span class="k">del</span> <span class="n">hdu0</span><span class="p">[</span><span class="s">&#39;COMMENT&#39;</span><span class="p">]</span>
        <span class="n">hdu0</span><span class="o">.</span><span class="n">add_comment</span><span class="p">(</span><span class="s">&#39;= Reference file was created by S.-M. Niemi, </span><span class="si">%s</span><span class="s">.&#39;</span> <span class="o">%</span> <span class="n">D</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&#39;%B %Y&#39;</span><span class="p">),</span>
                         <span class="n">before</span><span class="o">=</span><span class="s">&#39;ORIGIN&#39;</span><span class="p">)</span>
        <span class="c">#fix the date</span>
        <span class="n">date</span> <span class="o">=</span> <span class="n">D</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%d</span><span class="s">/%m/%y&#39;</span><span class="p">)</span>
        <span class="n">hdu0</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s">&#39;FITSDATE&#39;</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span>
        <span class="n">hdu0</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s">&#39;DATE&#39;</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span>
        <span class="n">hdr1</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s">&#39;DATE&#39;</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span>
        <span class="n">hdr2</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s">&#39;DATE&#39;</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span>
        <span class="n">hdr3</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s">&#39;DATE&#39;</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span>
        <span class="c">#fix history</span>
        <span class="k">del</span> <span class="n">hdu0</span><span class="p">[</span><span class="s">&#39;HISTORY&#39;</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">hdu0</span><span class="p">[</span><span class="s">&#39;COMMENTS&#39;</span><span class="p">]</span>
        <span class="n">hdu0</span><span class="o">.</span><span class="n">add_history</span><span class="p">(</span><span class="s">&#39;Created on </span><span class="si">%s</span><span class="s">, using the&#39;</span> <span class="o">%</span> <span class="n">D</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&#39;%B </span><span class="si">%d</span><span class="s"> %Y&#39;</span><span class="p">))</span>
        <span class="n">hdu0</span><span class="o">.</span><span class="n">add_history</span><span class="p">(</span><span class="s">&#39;Python script STISCCDSpectroscopyFlat.py.&#39;</span><span class="p">)</span>
        <span class="n">hdu0</span><span class="o">.</span><span class="n">add_history</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="n">hdu0</span><span class="o">.</span><span class="n">add_history</span><span class="p">(</span><span class="s">&#39;The flat field for spectral modes is independent of&#39;</span><span class="p">)</span>
        <span class="n">hdu0</span><span class="o">.</span><span class="n">add_history</span><span class="p">(</span><span class="s">&#39;wavelength but does change with time.  For this reason,&#39;</span><span class="p">)</span>
        <span class="n">hdu0</span><span class="o">.</span><span class="n">add_history</span><span class="p">(</span><span class="s">&#39;all the L-mode gratings have the same flat field, and all&#39;</span><span class="p">)</span>
        <span class="n">hdu0</span><span class="o">.</span><span class="n">add_history</span><span class="p">(</span><span class="s">&#39;the M-mode gratings have the same flat field. An average&#39;</span><span class="p">)</span>
        <span class="n">hdu0</span><span class="o">.</span><span class="n">add_history</span><span class="p">(</span><span class="s">&#39;flat is produced from datawith one to four million&#39;</span><span class="p">)</span>
        <span class="n">hdu0</span><span class="o">.</span><span class="n">add_history</span><span class="p">(</span><span class="s">&#39;electrons/pixel and is applicable to all CCD first order&#39;</span><span class="p">)</span>
        <span class="n">hdu0</span><span class="o">.</span><span class="n">add_history</span><span class="p">(</span><span class="s">&#39;modes after the dust motes are replaced by hose mote regions&#39;</span><span class="p">)</span>
        <span class="n">hdu0</span><span class="o">.</span><span class="n">add_history</span><span class="p">(</span><span class="s">&#39;from separate low or medium dispersion flats. Application of&#39;</span><span class="p">)</span>
        <span class="n">hdu0</span><span class="o">.</span><span class="n">add_history</span><span class="p">(</span><span class="s">&#39;flat to spectra of standard stars produces an rms residual&#39;</span><span class="p">)</span>
        <span class="n">hdu0</span><span class="o">.</span><span class="n">add_history</span><span class="p">(</span><span class="s">&#39;noise level as good as ~0.3%, which is comparable to the&#39;</span><span class="p">)</span>
        <span class="n">hdu0</span><span class="o">.</span><span class="n">add_history</span><span class="p">(</span><span class="s">&#39;residual noise achievable with no flat.&#39;</span><span class="p">)</span>
        <span class="n">hdu0</span><span class="o">.</span><span class="n">add_history</span><span class="p">(</span><span class="s">&#39;New CCD p-flats constructed primarily from G430M spectral&#39;</span><span class="p">)</span>
        <span class="n">hdu0</span><span class="o">.</span><span class="n">add_history</span><span class="p">(</span><span class="s">&#39;flats from program 11852. In L-mode flats, those regions&#39;</span><span class="p">)</span>
        <span class="n">hdu0</span><span class="o">.</span><span class="n">add_history</span><span class="p">(</span><span class="s">&#39;affected by dust motes were replaced by data from&#39;</span><span class="p">)</span>
        <span class="n">hdu0</span><span class="o">.</span><span class="n">add_history</span><span class="p">(</span><span class="s">&#39;the older cycle 7 l-flat file k2910262o_pfl.fits.&#39;</span><span class="p">)</span><span class="c">#k2910262o_pfl.fits </span>
        <span class="n">hdu0</span><span class="o">.</span><span class="n">add_history</span><span class="p">(</span><span class="s">&#39;The following input files were used:&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="nb">file</span> <span class="ow">in</span> <span class="n">raws</span><span class="p">:</span>
            <span class="n">hdu0</span><span class="o">.</span><span class="n">add_history</span><span class="p">(</span><span class="nb">file</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">):])</span>

        <span class="c">#make the file</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">print</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> has been written...&#39;</span> <span class="o">%</span> <span class="n">output</span>

    <span class="k">def</span> <span class="nf">_writeMakeFITS</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">file</span><span class="p">,</span> <span class="n">flat</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">sm</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">output</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Writes the output to a FITS file. This is an intermediate product</span>
<span class="sd">        so the header is not CDBS compatible.</span>
<span class="sd">        :param file: the name of the file that is being used as a template</span>
<span class="sd">        :param flat: flat field array</span>
<span class="sd">        :param err: error array</span>
<span class="sd">        :param eps: eps array</span>
<span class="sd">        :param sm: total number of images</span>
<span class="sd">        :param i: total number of observations</span>
<span class="sd">        :param output: name of the output file name  </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">+</span> <span class="n">output</span>

        <span class="n">ifd</span> <span class="o">=</span> <span class="n">PF</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>
        <span class="n">orghdr0</span> <span class="o">=</span> <span class="n">ifd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>

        <span class="c">#ofd = PF.HDUList(PF.PrimaryHDU(header = orghdr0))</span>
        <span class="n">ofd</span> <span class="o">=</span> <span class="n">PF</span><span class="o">.</span><span class="n">HDUList</span><span class="p">(</span><span class="n">PF</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">())</span>
        <span class="n">ifd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c">#create a new primary header with flat data</span>
        <span class="c">#hdu = PF.ImageHDU(data=flat, header=ifd[1].header, name=&#39;IMAGE&#39;)</span>
        <span class="n">hdu</span> <span class="o">=</span> <span class="n">PF</span><span class="o">.</span><span class="n">ImageHDU</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">flat</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;IMAGE&#39;</span><span class="p">)</span>
        <span class="c">#update(&#39;target&#39;, &#39;NGC1234&#39;, &#39;target name&#39;)</span>
        <span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s">&#39;OPT_ELEM&#39;</span><span class="p">,</span> <span class="n">orghdr0</span><span class="p">[</span><span class="s">&#39;OPT_ELEM&#39;</span><span class="p">])</span>
        <span class="c">#hdu.header.update(&#39;MODE_ID&#39;, orghdr0[&#39;MODE_ID&#39;])</span>
        <span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s">&#39;APERTURE&#39;</span><span class="p">,</span> <span class="n">orghdr0</span><span class="p">[</span><span class="s">&#39;APERTURE&#39;</span><span class="p">])</span>
        <span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s">&#39;CENWAVE&#39;</span><span class="p">,</span> <span class="n">orghdr0</span><span class="p">[</span><span class="s">&#39;CENWAVE&#39;</span><span class="p">])</span>
        <span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s">&#39;DETECTOR&#39;</span><span class="p">,</span> <span class="n">orghdr0</span><span class="p">[</span><span class="s">&#39;DETECTOR&#39;</span><span class="p">])</span>
        <span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s">&#39;CCDGAIN&#39;</span><span class="p">,</span> <span class="n">orghdr0</span><span class="p">[</span><span class="s">&#39;CCDGAIN&#39;</span><span class="p">])</span>
        <span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s">&#39;TOTIMG&#39;</span><span class="p">,</span> <span class="n">sm</span><span class="p">)</span>
        <span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s">&#39;TOTOBS&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
        <span class="c">#add history section</span>
        <span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">add_history</span><span class="p">(</span><span class="s">&#39;Flat Written by STISCCDSpectrscopyFlat.py&#39;</span><span class="p">)</span>
        <span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">add_history</span><span class="p">(</span><span class="s">&#39;at </span><span class="si">%s</span><span class="s"> UTC.&#39;</span> <span class="o">%</span> <span class="n">D</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">())</span>
        <span class="c">#checks that the header follows rules</span>
        <span class="n">hdu</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="s">&#39;fix&#39;</span><span class="p">)</span>
        <span class="c">#appends to the HDUlist</span>
        <span class="n">ofd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hdu</span><span class="p">)</span>

        <span class="c">#create a new extension header with error array</span>
        <span class="c">#hdu2 = PF.ImageHDU(data=err, header=ifd[2].header, name=&#39;ERR&#39;)</span>
        <span class="n">hdu2</span> <span class="o">=</span> <span class="n">PF</span><span class="o">.</span><span class="n">ImageHDU</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">err</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;ERR&#39;</span><span class="p">)</span>
        <span class="n">hdu2</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s">&#39;OPT_ELEM&#39;</span><span class="p">,</span> <span class="n">orghdr0</span><span class="p">[</span><span class="s">&#39;OPT_ELEM&#39;</span><span class="p">])</span>
        <span class="c">#hdu2.header.update(&#39;MODE_ID&#39;, orghdr0[&#39;MODE_ID&#39;])</span>
        <span class="n">hdu2</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s">&#39;APERTURE&#39;</span><span class="p">,</span> <span class="n">orghdr0</span><span class="p">[</span><span class="s">&#39;APERTURE&#39;</span><span class="p">])</span>
        <span class="n">hdu2</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s">&#39;CENWAVE&#39;</span><span class="p">,</span> <span class="n">orghdr0</span><span class="p">[</span><span class="s">&#39;CENWAVE&#39;</span><span class="p">])</span>
        <span class="n">hdu2</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s">&#39;DETECTOR&#39;</span><span class="p">,</span> <span class="n">orghdr0</span><span class="p">[</span><span class="s">&#39;DETECTOR&#39;</span><span class="p">])</span>
        <span class="n">hdu2</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s">&#39;CCDGAIN&#39;</span><span class="p">,</span> <span class="n">orghdr0</span><span class="p">[</span><span class="s">&#39;CCDGAIN&#39;</span><span class="p">])</span>
        <span class="n">hdu2</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s">&#39;TOTIMG&#39;</span><span class="p">,</span> <span class="n">sm</span><span class="p">)</span>
        <span class="n">hdu2</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s">&#39;TOTOBS&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
        <span class="c">#add history section</span>
        <span class="n">hdu2</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">add_history</span><span class="p">(</span><span class="s">&#39;Flat Written by STISCCDSpectrscopyFlat.py&#39;</span><span class="p">)</span>
        <span class="n">hdu2</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">add_history</span><span class="p">(</span><span class="s">&#39;at </span><span class="si">%s</span><span class="s"> UTC.&#39;</span> <span class="o">%</span> <span class="n">D</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">())</span>
        <span class="c">#checks that the header follows rules</span>
        <span class="n">hdu2</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="s">&#39;fix&#39;</span><span class="p">)</span>
        <span class="c">#appends to the HDUlist</span>
        <span class="n">ofd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hdu2</span><span class="p">)</span>

        <span class="c">#create a new extension header with eps array</span>
        <span class="c">#hdu3 = PF.ImageHDU(data=eps, header=ifd[3].header, name=&#39;EPS&#39;)</span>
        <span class="n">hdu3</span> <span class="o">=</span> <span class="n">PF</span><span class="o">.</span><span class="n">ImageHDU</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">eps</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;EPS&#39;</span><span class="p">)</span>
        <span class="n">hdu3</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s">&#39;OPT_ELEM&#39;</span><span class="p">,</span> <span class="n">orghdr0</span><span class="p">[</span><span class="s">&#39;OPT_ELEM&#39;</span><span class="p">])</span>
        <span class="c">#hdu3.header.update(&#39;MODE_ID&#39;, orghdr0[&#39;MODE_ID&#39;])</span>
        <span class="n">hdu3</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s">&#39;APERTURE&#39;</span><span class="p">,</span> <span class="n">orghdr0</span><span class="p">[</span><span class="s">&#39;APERTURE&#39;</span><span class="p">])</span>
        <span class="n">hdu3</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s">&#39;CENWAVE&#39;</span><span class="p">,</span> <span class="n">orghdr0</span><span class="p">[</span><span class="s">&#39;CENWAVE&#39;</span><span class="p">])</span>
        <span class="n">hdu3</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s">&#39;DETECTOR&#39;</span><span class="p">,</span> <span class="n">orghdr0</span><span class="p">[</span><span class="s">&#39;DETECTOR&#39;</span><span class="p">])</span>
        <span class="n">hdu3</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s">&#39;CCDGAIN&#39;</span><span class="p">,</span> <span class="n">orghdr0</span><span class="p">[</span><span class="s">&#39;CCDGAIN&#39;</span><span class="p">])</span>
        <span class="n">hdu3</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s">&#39;TOTIMG&#39;</span><span class="p">,</span> <span class="n">sm</span><span class="p">)</span>
        <span class="n">hdu3</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s">&#39;TOTOBS&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
        <span class="c">#add history section</span>
        <span class="n">hdu3</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">add_history</span><span class="p">(</span><span class="s">&#39;Flat Written by STISCCDSpectrscopyFlat.py&#39;</span><span class="p">)</span>
        <span class="n">hdu3</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">add_history</span><span class="p">(</span><span class="s">&#39;at </span><span class="si">%s</span><span class="s"> UTC.&#39;</span> <span class="o">%</span> <span class="n">D</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">())</span>
        <span class="c">#checks that the header follows rules</span>
        <span class="n">hdu3</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="s">&#39;fix&#39;</span><span class="p">)</span>
        <span class="c">#appends to the HDUlist</span>
        <span class="n">ofd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hdu3</span><span class="p">)</span>

        <span class="c">#writes the file</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ofd</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">output</span> <span class="o">+</span> <span class="s">&#39;.fits&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;File </span><span class="si">%s</span><span class="s"> exists...&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">output</span> <span class="o">+</span> <span class="s">&#39;.fits&#39;</span><span class="p">)</span>
            <span class="k">print</span> <span class="s">&#39;Will write to </span><span class="si">%s</span><span class="s"> instead!&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">output</span> <span class="o">+</span> <span class="s">&#39;SMN.fits&#39;</span><span class="p">)</span>
            <span class="n">ofd</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">output</span> <span class="o">+</span> <span class="s">&#39;SMN.fits&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_doStats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Calculates and prints out some basic statistics from the given data.</span>
<span class="sd">        :param data: data array from which the statistics is being calculated.</span>
<span class="sd">        :param mode: a string related to the mode (L/M)s</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c">#whole data</span>
        <span class="n">std</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">mean</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span> <span class="o">-</span> <span class="mf">1.</span><span class="p">)</span>
        <span class="n">rms</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">std</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

        <span class="c">#100 x 100 pixels at the centre of the data array</span>
        <span class="n">sh</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">sh</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">sh</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">xmin</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="mi">50</span> <span class="k">if</span> <span class="n">x</span> <span class="o">-</span> <span class="mi">50</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">xmax</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">50</span> <span class="k">if</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">50</span> <span class="o">&lt;=</span> <span class="n">sh</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">else</span> <span class="n">sh</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ymin</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="mi">50</span> <span class="k">if</span> <span class="n">y</span> <span class="o">-</span> <span class="mi">50</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">ymax</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="mi">50</span> <span class="k">if</span> <span class="n">y</span> <span class="o">+</span> <span class="mi">50</span> <span class="o">&lt;=</span> <span class="n">sh</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">else</span> <span class="n">sh</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">ds</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">ymin</span><span class="p">:</span><span class="n">ymax</span><span class="p">,</span> <span class="n">xmin</span><span class="p">:</span><span class="n">xmax</span><span class="p">]</span>
        <span class="n">stds</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>
        <span class="n">means</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ds</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">rmss</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">means</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">stds</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

        <span class="k">print</span> <span class="s">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">15</span> <span class="o">+</span> <span class="s">&#39;Statistics of </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">mode</span> <span class="o">+</span> <span class="s">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">15</span>
        <span class="k">print</span> <span class="s">&#39;</span><span class="si">%15s</span><span class="s">&#39;</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">%</span> <span class="p">(</span><span class="s">&#39;ARRAY&#39;</span><span class="p">,</span> <span class="s">&#39;MEAN&#39;</span><span class="p">,</span> <span class="s">&#39;STDEV&#39;</span><span class="p">,</span> <span class="s">&#39;RMS Noise&#39;</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&#39;</span><span class="si">%15s%15.5f%16.6f%14.6f</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&#39;Full&#39;</span><span class="p">,</span> <span class="n">mean</span> <span class="o">+</span> <span class="mf">1.</span><span class="p">,</span> <span class="n">std</span><span class="p">,</span> <span class="n">rms</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&#39;</span><span class="si">%15s%15.5f%16.6f%14.6f</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&#39;Centre&#39;</span><span class="p">,</span> <span class="n">means</span> <span class="o">+</span> <span class="mf">1.</span><span class="p">,</span> <span class="n">stds</span><span class="p">,</span> <span class="n">rmss</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_fitflat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">nomed</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="s">&#39;name&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Creates spline fitted flat field array and masked image.</span>
<span class="sd">        Uses img for the data and nodes for the number of nodes.</span>
<span class="sd">        This function can be used to fit both column and row direction.</span>
<span class="sd">        This choice is controlled with the boolean col.</span>
<span class="sd">        :param hdr: header</span>
<span class="sd">        :param img: flat field image</span>
<span class="sd">        :param mask: mask that is being applied and updated</span>
<span class="sd">        :param nodes: number of nodes being used for the spline fits</span>
<span class="sd">        :param col: boolean, column (True) or row (False, default) fit</span>
<span class="sd">        :param nomed: boolean, median (True) or no median filtering (False, default)</span>
<span class="sd">        :param file: the name of the plot file </span>
<span class="sd">        :return: Spline fitted data, img / fit, mask</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">s</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="n">nx</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ny</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">det</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s">&#39;DETECTOR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="c">#set up positions of spline nodes</span>
        <span class="k">if</span> <span class="n">col</span><span class="p">:</span>
            <span class="n">xpx</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ny</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">xnod</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">ny</span> <span class="o">-</span> <span class="mf">1.</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">nodes</span> <span class="o">-</span> <span class="mf">1.</span><span class="p">)</span>   <span class="c"># spaced nodes incl ends</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">xpx</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">xnod</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">nx</span> <span class="o">-</span> <span class="mf">1.</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">nodes</span> <span class="o">-</span> <span class="mf">1.</span><span class="p">)</span>   <span class="c">#spaced nodes incl ends</span>

        <span class="c">#using array copy</span>
        <span class="n">fit</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c"># unfit lines will be unit flats</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c"># initialize for 1-d median filter</span>
        <span class="n">bad</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">fit</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">))</span>
        <span class="n">nbad</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bad</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nbad</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">fit</span><span class="p">[</span><span class="n">bad</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>               <span class="c">#to avoid 0/0 in img/fit for all bad row</span>

        <span class="k">if</span> <span class="n">col</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
            <span class="c">#add extra pt half way btwn first and last pts at ends</span>
            <span class="n">dl</span> <span class="o">=</span> <span class="n">xnod</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">xnod</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">xnod</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">xnod</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dl</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)</span>
            <span class="n">xnod</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">xnod</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">xnod</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">dl</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">nomed</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
                <span class="s">&#39;Print MEDIAN filtering for row fitting!&#39;</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">SS</span><span class="o">.</span><span class="n">medfilt2d</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span>  <span class="c"># default for CCDs</span>

        <span class="n">loop</span> <span class="o">=</span> <span class="n">ny</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">col</span><span class="p">:</span> <span class="n">loop</span> <span class="o">=</span> <span class="n">nx</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">lenfit</span> <span class="o">=</span> <span class="n">nx</span>
        <span class="k">if</span> <span class="n">col</span><span class="p">:</span>
            <span class="n">lenfit</span> <span class="o">=</span> <span class="n">ny</span>
        <span class="n">nskip</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">loop</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">col</span><span class="p">:</span> <span class="c">#column fitting</span>
                <span class="n">good</span> <span class="o">=</span> <span class="n">mask</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
                <span class="n">ngd</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask</span><span class="p">[</span><span class="n">good</span><span class="p">])</span>
                <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">ngd</span><span class="p">)</span> <span class="o">/</span> <span class="n">lenfit</span> <span class="o">&lt;</span> <span class="mf">0.55</span><span class="p">:</span>
                    <span class="n">mask</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="n">nskip</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">nomed</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
                    <span class="n">tmp</span><span class="p">[</span><span class="n">good</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">SS</span><span class="o">.</span><span class="n">medfilt</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="n">good</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="mi">13</span><span class="p">)</span>

                <span class="c">#this is significantly better initial guess than the one below</span>
                <span class="n">ynod</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">N</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="n">x</span> <span class="o">-</span> <span class="mi">5</span><span class="p">:</span><span class="n">x</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span> <span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xnod</span><span class="p">])</span>
                <span class="n">ynod</span><span class="p">[</span><span class="n">N</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ynod</span><span class="p">)]</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="n">good</span><span class="p">,</span> <span class="n">i</span><span class="p">])</span>
                <span class="c">#ynod = xnod*0 + N.mean(tmp[good, i])</span>

                <span class="n">fitynods</span><span class="p">,</span> <span class="n">_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_splinefitScipy</span><span class="p">(</span><span class="n">xpx</span><span class="p">[</span><span class="n">good</span><span class="p">],</span> <span class="n">tmp</span><span class="p">[</span><span class="n">good</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="n">ynod</span><span class="p">,</span> <span class="n">xnod</span><span class="p">)</span>
                <span class="n">fit</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cspline</span><span class="p">(</span><span class="n">xnod</span><span class="p">,</span> <span class="n">fitynods</span><span class="p">,</span> <span class="n">xpx</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">650</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plotFit</span><span class="p">(</span><span class="n">xpx</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">fit</span><span class="p">,</span> <span class="n">good</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">xnod</span><span class="p">,</span> <span class="n">ynod</span><span class="p">,</span> <span class="n">fitynods</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="nb">file</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span> <span class="c">#row fitting</span>
                <span class="n">good</span> <span class="o">=</span> <span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">&gt;</span> <span class="mi">0</span>
                <span class="n">ngd</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask</span><span class="p">[</span><span class="n">good</span><span class="p">])</span>
                <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">ngd</span><span class="p">)</span> <span class="o">/</span> <span class="n">lenfit</span> <span class="o">&lt;</span> <span class="mf">0.55</span><span class="p">:</span>
                    <span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="n">nskip</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">continue</span>

                <span class="c">#reallocate xnodes esp for STIS tung 52x2 w/ 1st 215 px ignored</span>
                <span class="n">xnod</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">xpx</span><span class="p">[</span><span class="n">good</span><span class="p">])</span> <span class="o">-</span> <span class="n">xpx</span><span class="p">[</span><span class="n">good</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">nodes</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">xpx</span><span class="p">[</span><span class="n">good</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">ynod</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">N</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="o">-</span> <span class="mi">5</span><span class="p">:</span><span class="n">x</span> <span class="o">+</span> <span class="mi">5</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xnod</span><span class="p">])</span>
                <span class="n">ynod</span><span class="p">[</span><span class="n">N</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ynod</span><span class="p">)]</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">good</span><span class="p">])</span>
                <span class="n">fitynods</span><span class="p">,</span> <span class="n">_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_splinefitScipy</span><span class="p">(</span><span class="n">xpx</span><span class="p">[</span><span class="n">good</span><span class="p">],</span> <span class="n">tmp</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">good</span><span class="p">],</span> <span class="n">ynod</span><span class="p">,</span> <span class="n">xnod</span><span class="p">)</span>
                <span class="n">fit</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cspline</span><span class="p">(</span><span class="n">xnod</span><span class="p">,</span> <span class="n">fitynods</span><span class="p">,</span> <span class="n">xpx</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">600</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plotFit</span><span class="p">(</span><span class="n">xpx</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">fit</span><span class="p">,</span> <span class="n">good</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">xnod</span><span class="p">,</span> <span class="n">ynod</span><span class="p">,</span> <span class="n">fitynods</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="nb">file</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="k">print</span> <span class="s">&#39;FITLAT with </span><span class="si">%i</span><span class="s"> NODES&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">xnod</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&#39;</span><span class="si">%i</span><span class="s"> fits were skipped...&#39;</span> <span class="o">%</span> <span class="n">nskip</span>

        <span class="n">bad</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">fit</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bad</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">bad</span>
            <span class="k">print</span> <span class="s">&#39;Problem at fit points, will replace with 1.0&#39;</span>
            <span class="n">fit</span><span class="p">[</span><span class="n">bad</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>            <span class="c">#to avoid 0/0 in img/fit</span>
        <span class="n">flat</span> <span class="o">=</span> <span class="n">img</span> <span class="o">/</span> <span class="n">fit</span>

        <span class="c">#self._plot50(flat, (0,0), (0,0), (0,0), &#39;foo&#39;)</span>

        <span class="k">return</span> <span class="n">fit</span><span class="p">,</span> <span class="n">flat</span><span class="p">,</span> <span class="n">mask</span>


<div class="viewcode-block" id="MakeFlat.crreject"><a class="viewcode-back" href="../../../SamPy.stis.html#SamPy.stis.STISCCDSpectroscopyFlat.MakeFlat.crreject">[docs]</a>    <span class="k">def</span> <span class="nf">crreject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filelist</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Runs CalSTIS for each file in the file list.</span>
<span class="sd">        Uses default settings.</span>
<span class="sd">        :param filelist: list of files being run through CalSTIS.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">for</span> <span class="nb">file</span> <span class="ow">in</span> <span class="n">filelist</span><span class="p">:</span>
            <span class="n">stis</span><span class="o">.</span><span class="n">calstis</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="MakeFlat.combine"><a class="viewcode-back" href="../../../SamPy.stis.html#SamPy.stis.STISCCDSpectroscopyFlat.MakeFlat.combine">[docs]</a>    <span class="k">def</span> <span class="nf">combine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filelist</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">crsigmas</span><span class="o">=</span><span class="s">&#39;20&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Combines all files in filelist using ocrreject PyRAF task.</span>
<span class="sd">        :param filelist: filelist being processed </span>
<span class="sd">        :param output:  output list</span>
<span class="sd">        :param crsigmas: cosmic ray rejection sigma clipping value</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">stis</span><span class="o">.</span><span class="n">ocrreject</span><span class="p">(</span><span class="n">filelist</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">output</span><span class="p">,</span> <span class="n">crsigmas</span><span class="o">=</span><span class="n">crsigmas</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="MakeFlat.make50CDD"><a class="viewcode-back" href="../../../SamPy.stis.html#SamPy.stis.STISCCDSpectroscopyFlat.MakeFlat.make50CDD">[docs]</a>    <span class="k">def</span> <span class="nf">make50CDD</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">colnodes</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">rownodes</span><span class="o">=</span><span class="mi">13</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Makes a flat field from all files that has been taken with clear</span>
<span class="sd">        aperture (50CCD). Each input file will write an output FITS file.</span>
<span class="sd">        Makes also plots out from the data that has been fitted and masked</span>
<span class="sd">        that can be used to check the results for any failed spline fits, etc.</span>
<span class="sd">        :param files: a list of file names that are being used </span>
<span class="sd">        :param colnodes: the number of nodes used of column fits (default = 25)</span>
<span class="sd">        :param rownodes: the number of nodes used for row fits (default = 13)  </span>
<span class="sd">        :summary: Creates a flat field</span>
<span class="sd">        :todo: rewrite away from IDL</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">+</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">files</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="nb">file</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">files</span><span class="p">):</span>
            <span class="c">#open file and pull out required information</span>
            <span class="n">fh</span> <span class="o">=</span> <span class="n">PF</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>
            <span class="n">dcr</span> <span class="o">=</span> <span class="n">fh</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
            <span class="n">err</span> <span class="o">=</span> <span class="n">fh</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
            <span class="n">eps</span> <span class="o">=</span> <span class="n">fh</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
            <span class="n">hdr0</span> <span class="o">=</span> <span class="n">fh</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
            <span class="n">hdr1</span> <span class="o">=</span> <span class="n">fh</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="n">lamp</span> <span class="o">=</span> <span class="n">hdr0</span><span class="p">[</span><span class="s">&#39;SCLAMP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">aper</span> <span class="o">=</span> <span class="n">hdr0</span><span class="p">[</span><span class="s">&#39;APERTURE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="n">hdr0</span><span class="p">[</span><span class="s">&#39;OPT_ELEM&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">gain</span> <span class="o">=</span> <span class="s">&#39;g&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">hdr0</span><span class="p">[</span><span class="s">&#39;CCDGAIN&#39;</span><span class="p">])</span>

            <span class="k">if</span> <span class="s">&#39;M&#39;</span> <span class="ow">in</span> <span class="n">mode</span><span class="p">:</span>
                <span class="n">mode</span> <span class="o">+=</span> <span class="s">&#39;-&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">hdr0</span><span class="p">[</span><span class="s">&#39;CENWAVE&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s">&#39;_&#39;</span>
            <span class="k">if</span> <span class="n">aper</span> <span class="o">==</span> <span class="s">&#39;50CCD&#39;</span><span class="p">:</span> <span class="n">mode</span> <span class="o">+=</span> <span class="s">&#39;50CCD&#39;</span>

            <span class="n">eps</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">*</span> <span class="n">eps</span>
            <span class="n">nused</span> <span class="o">=</span> <span class="n">hdr1</span><span class="p">[</span><span class="s">&#39;NCOMBINE&#39;</span><span class="p">]</span>
            <span class="n">sm</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">nused</span><span class="p">)</span>

            <span class="n">ny</span><span class="p">,</span> <span class="n">nx</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">dcr</span><span class="p">)</span>

            <span class="n">onemsk</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">N</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>          <span class="c">#mask of where flat = 1</span>
            <span class="n">ignmsk</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">N</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>          <span class="c">#mask of pts to keep, but ignore in flt</span>

            <span class="c">#bad spots to ignmsk</span>
            <span class="n">ignmsk</span><span class="p">,</span> <span class="n">xcen</span><span class="p">,</span> <span class="n">ycen</span><span class="p">,</span> <span class="n">rad</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_badspot</span><span class="p">(</span><span class="n">ignmsk</span><span class="p">,</span> <span class="n">hdr0</span><span class="p">[</span><span class="s">&#39;OPT_ELEM&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>

            <span class="n">onemsk</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>                   <span class="c"># general STIS bad 1st and last col</span>
            <span class="n">onemsk</span><span class="p">[:,</span> <span class="mi">1023</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">onemsk</span><span class="p">[</span><span class="mi">994</span><span class="p">:</span><span class="mi">1024</span><span class="p">,:]</span> <span class="o">=</span> <span class="mi">0</span>            <span class="c"># &quot;vignetted&quot; at top indep of slit pos.</span>
            <span class="n">onemsk</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">=</span> <span class="mi">0</span>                   <span class="c"># first row</span>
            <span class="n">onemsk</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span> <span class="mi">253</span><span class="p">:</span><span class="mi">259</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>           <span class="c"># 99feb4 hole made vert stripe at bott.</span>
            <span class="n">onemsk</span><span class="p">[</span><span class="mi">14</span><span class="p">:</span><span class="mi">16</span><span class="p">,</span> <span class="mi">768</span><span class="p">:</span><span class="mi">770</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>         <span class="c"># ... for D2 G230LB, 50CCD</span>

            <span class="k">if</span> <span class="n">aper</span> <span class="o">==</span> <span class="s">&#39;50CCD&#39;</span><span class="p">:</span>
                <span class="n">onemsk</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">15</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">cenlo</span> <span class="o">=</span> <span class="mi">280</span>
            <span class="n">cenhi</span> <span class="o">=</span> <span class="mi">742</span>                         <span class="c">#  orig fid centers</span>

            <span class="k">if</span> <span class="s">&#39;M&#39;</span> <span class="ow">in</span> <span class="n">mode</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">aper</span> <span class="o">==</span> <span class="s">&#39;50CCD&#39;</span><span class="p">:</span>
                    <span class="n">onemsk</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">38</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">onemsk</span><span class="p">[</span><span class="mi">975</span><span class="p">:</span><span class="mi">1024</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>     <span class="c"># top clipped</span>
                <span class="n">cenlo</span> <span class="o">=</span> <span class="mi">304</span>
                <span class="n">cenhi</span> <span class="o">=</span> <span class="mi">766</span>

            <span class="c">#fiducial masks</span>
            <span class="k">if</span> <span class="n">aper</span> <span class="o">!=</span> <span class="s">&#39;50CCD&#39;</span><span class="p">:</span>
                <span class="n">onemsk</span><span class="p">[</span><span class="n">cenlo</span> <span class="o">-</span> <span class="mi">14</span><span class="p">:</span><span class="n">cenlo</span> <span class="o">+</span> <span class="mi">15</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">onemsk</span><span class="p">[</span><span class="n">cenhi</span> <span class="o">-</span> <span class="mi">19</span><span class="p">:</span><span class="n">cenhi</span> <span class="o">+</span> <span class="mi">20</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">err</span><span class="p">[</span><span class="n">onemsk</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>               <span class="c"># err=0 means do not use data</span>
            <span class="n">eps</span><span class="p">[</span><span class="n">onemsk</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">512</span>             <span class="c"># all px rejected flag</span>
            <span class="n">onemsk</span><span class="p">[</span><span class="n">eps</span> <span class="o">&gt;</span> <span class="mi">150</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>              <span class="c"># keep warm px=150</span>

            <span class="c">#fit in col dir first because of glints along L&amp;R edges for 50ccd D2-5216</span>
            <span class="n">cmask</span> <span class="o">=</span> <span class="n">onemsk</span> <span class="o">*</span> <span class="n">ignmsk</span>
            <span class="n">PL</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">cmask</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s">&#39;lower&#39;</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
            <span class="n">PL</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="nb">file</span><span class="p">[:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39;_cmask.pdf&#39;</span><span class="p">)</span>
            <span class="n">PL</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="n">colfit</span><span class="p">,</span> <span class="n">flat</span><span class="p">,</span> <span class="n">cmask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fitflat</span><span class="p">(</span><span class="n">hdr0</span><span class="p">,</span> <span class="n">dcr</span><span class="p">,</span> <span class="n">cmask</span><span class="p">,</span> <span class="n">colnodes</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="nb">file</span><span class="p">[:</span><span class="o">-</span><span class="mi">5</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">lamp</span> <span class="o">==</span> <span class="s">&#39;TUNGSTEN&#39;</span> <span class="ow">and</span> <span class="n">aper</span> <span class="o">==</span> <span class="s">&#39;52X2&#39;</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&#39; Cannot do row fit for &#39;</span><span class="p">,</span> <span class="n">lamp</span><span class="p">,</span> <span class="n">aper</span>
                <span class="n">fit</span> <span class="o">=</span> <span class="n">colfit</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">rmask</span> <span class="o">=</span> <span class="n">cmask</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c">#iterate w/ row fits for no em lines</span>
                <span class="c">#ignmsk areas filled w/ the fits</span>
                <span class="n">rmask</span> <span class="o">=</span> <span class="n">onemsk</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s">&#39;G430M-5216_50CCD&#39;</span><span class="p">:</span>
                    <span class="k">print</span><span class="s">&#39;Omit rowfit at ends of &#39;</span><span class="p">,</span> <span class="n">mode</span>
                    <span class="n">rmask</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">61</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">rmask</span><span class="p">[:,</span> <span class="mi">930</span><span class="p">:</span><span class="mi">1024</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="n">fit</span><span class="p">,</span> <span class="n">flat</span><span class="p">,</span> <span class="n">rmask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fitflat</span><span class="p">(</span><span class="n">hdr0</span><span class="p">,</span> <span class="n">colfit</span><span class="p">,</span> <span class="n">rmask</span><span class="p">,</span> <span class="n">rownodes</span><span class="p">,</span> <span class="n">nomed</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="nb">file</span><span class="p">[:</span><span class="o">-</span><span class="mi">5</span><span class="p">])</span>

                <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s">&#39;G430M-5216_50CCD&#39;</span><span class="p">:</span>
                    <span class="n">fit</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">61</span><span class="p">]</span> <span class="o">=</span> <span class="n">colfit</span><span class="p">[:,</span>
                                   <span class="mi">0</span><span class="p">:</span><span class="mi">61</span><span class="p">]</span>      <span class="c"># bumps at ends of rows</span>
                    <span class="n">fit</span><span class="p">[:,</span> <span class="mi">930</span><span class="p">:</span><span class="mi">1024</span><span class="p">]</span> <span class="o">=</span> <span class="n">colfit</span><span class="p">[:,</span> <span class="mi">930</span><span class="p">:</span><span class="mi">1024</span><span class="p">]</span>

            <span class="n">flat</span> <span class="o">=</span> <span class="n">dcr</span> <span class="o">/</span> <span class="n">fit</span>

            <span class="n">indx</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">cmask</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">rmask</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>   <span class="c"># neither row or col fit</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">err</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>         <span class="c">#err=0 means do not use data </span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">eps</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">512</span>       <span class="c">#all px rejected flag</span>

            <span class="n">flat</span><span class="p">[</span><span class="n">onemsk</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">err</span> <span class="o">=</span> <span class="n">err</span> <span class="o">/</span> <span class="n">fit</span>                             <span class="c"># error in units of flat</span>

            <span class="c">#remove vertical ringing</span>
            <span class="n">yflat</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">iy</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1024</span><span class="p">):</span>
                <span class="n">inc</span> <span class="o">=</span> <span class="n">cmask</span><span class="p">[</span><span class="n">iy</span><span class="p">,</span> <span class="p">:]</span> <span class="o">==</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">flat</span><span class="p">[</span><span class="n">iy</span><span class="p">,</span> <span class="n">inc</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">yflat</span><span class="p">[</span><span class="n">iy</span><span class="p">]</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">flat</span><span class="p">[</span><span class="n">iy</span><span class="p">,</span> <span class="n">inc</span><span class="p">])</span>
            <span class="n">yflatm</span> <span class="o">=</span> <span class="n">SS</span><span class="o">.</span><span class="n">medfilt</span><span class="p">(</span><span class="n">yflat</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">iy</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1024</span><span class="p">):</span> <span class="n">flat</span><span class="p">[</span><span class="n">iy</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">flat</span><span class="p">[</span><span class="n">iy</span><span class="p">,</span> <span class="p">:]</span> <span class="o">/</span> <span class="n">yflatm</span><span class="p">[</span><span class="n">iy</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">flat</span><span class="p">[</span><span class="n">N</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">flat</span><span class="p">)])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&#39;ERROR: there are NaNs in the flat:&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="p">[</span><span class="n">N</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">flat</span><span class="p">)]</span>

            <span class="c">#make plot</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_plot50</span><span class="p">(</span><span class="n">flat</span><span class="p">,</span> <span class="n">xcen</span><span class="p">,</span> <span class="n">ycen</span><span class="p">,</span> <span class="n">rad</span><span class="p">,</span> <span class="nb">file</span><span class="p">[:</span><span class="o">-</span><span class="mi">5</span><span class="p">])</span>

            <span class="c">#create a FITS file</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;ppG430M_50CCD_gain</span><span class="si">%s</span><span class="s">_flat&#39;</span> <span class="o">%</span> <span class="n">gain</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="s">&#39;ppG430M_50CCD_gain</span><span class="si">%s</span><span class="s">_flat&#39;</span> <span class="o">%</span> <span class="n">gain</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_writeMakeFITS</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="n">flat</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">sm</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">fname</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</div>
<div class="viewcode-block" id="MakeFlat.make52X2"><a class="viewcode-back" href="../../../SamPy.stis.html#SamPy.stis.STISCCDSpectroscopyFlat.MakeFlat.make52X2">[docs]</a>    <span class="k">def</span> <span class="nf">make52X2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">slitpos</span><span class="p">,</span> <span class="n">colnodes</span><span class="o">=</span><span class="mi">13</span><span class="p">,</span> <span class="n">rownodes</span><span class="o">=</span><span class="mi">13</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Makes a flat field from all files that has been taken with a long slit</span>
<span class="sd">        in the light path (52x2). Each input file will write an output FITS file.</span>
<span class="sd">        Makes also plots out from the data that has been fitted and masked</span>
<span class="sd">        that can be used to check the results for any failed spline fits, etc.</span>

<span class="sd">        :param files: a list of file names that are being used</span>
<span class="sd">        :param slitpos: a list of slit positions that correspond to each file</span>
<span class="sd">        :param colnodes: the number of nodes used of column fits (default = 13)</span>
<span class="sd">        :param rownodes: the number of nodes used for row fits (default = 13)  </span>

<span class="sd">        :summary: Creates a flat field</span>

<span class="sd">        :todo: rewrite away from IDL. Get rid off the hard coded file names</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">+</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">files</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="nb">file</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">files</span><span class="p">):</span>
            <span class="c">#open file and pull out required information</span>
            <span class="n">fh</span> <span class="o">=</span> <span class="n">PF</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>
            <span class="n">dcr</span> <span class="o">=</span> <span class="n">fh</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
            <span class="n">err</span> <span class="o">=</span> <span class="n">fh</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
            <span class="n">eps</span> <span class="o">=</span> <span class="n">fh</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
            <span class="n">hdr0</span> <span class="o">=</span> <span class="n">fh</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
            <span class="n">hdr1</span> <span class="o">=</span> <span class="n">fh</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="n">lamp</span> <span class="o">=</span> <span class="n">hdr0</span><span class="p">[</span><span class="s">&#39;SCLAMP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">aper</span> <span class="o">=</span> <span class="n">hdr0</span><span class="p">[</span><span class="s">&#39;APERTURE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="n">hdr0</span><span class="p">[</span><span class="s">&#39;OPT_ELEM&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">gain</span> <span class="o">=</span> <span class="s">&#39;g&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">hdr0</span><span class="p">[</span><span class="s">&#39;CCDGAIN&#39;</span><span class="p">])</span>

            <span class="k">if</span> <span class="s">&#39;M&#39;</span> <span class="ow">in</span> <span class="n">mode</span><span class="p">:</span>
                <span class="n">mode</span> <span class="o">+=</span> <span class="s">&#39;-&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">hdr0</span><span class="p">[</span><span class="s">&#39;CENWAVE&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s">&#39;_&#39;</span>
            <span class="k">if</span> <span class="n">aper</span> <span class="o">==</span> <span class="s">&#39;50CCD&#39;</span><span class="p">:</span> <span class="n">mode</span> <span class="o">+=</span> <span class="s">&#39;50CCD&#39;</span>

            <span class="n">eps</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">*</span> <span class="n">eps</span>
            <span class="n">nused</span> <span class="o">=</span> <span class="n">hdr1</span><span class="p">[</span><span class="s">&#39;NCOMBINE&#39;</span><span class="p">]</span>
            <span class="c">#nused = hdr1[&#39;TOTIMG&#39;]</span>
            <span class="n">sm</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">nused</span><span class="p">)</span>
            <span class="nb">sum</span> <span class="o">=</span> <span class="s">&#39;sm</span><span class="si">%i</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sm</span><span class="p">)</span>
            <span class="k">print</span> <span class="s">&#39;Processing file </span><span class="si">%s</span><span class="s"> (</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="n">mode</span> <span class="o">+</span> <span class="n">gain</span> <span class="o">+</span> <span class="nb">sum</span><span class="p">)</span>

            <span class="n">ny</span><span class="p">,</span> <span class="n">nx</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">dcr</span><span class="p">)</span>

            <span class="n">onemsk</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">N</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>          <span class="c">#mask of where flat = 1</span>
            <span class="n">ignmsk</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">N</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>          <span class="c">#mask of pts to keep, but ignore in flt</span>

            <span class="c">#bad spots to ignmsk</span>
            <span class="n">ignmsk</span><span class="p">,</span> <span class="n">xcen</span><span class="p">,</span> <span class="n">ycen</span><span class="p">,</span> <span class="n">rad</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_badspot</span><span class="p">(</span><span class="n">ignmsk</span><span class="p">,</span> <span class="n">hdr0</span><span class="p">[</span><span class="s">&#39;OPT_ELEM&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>

            <span class="n">onemsk</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>                   <span class="c"># general STIS bad 1st and last col</span>
            <span class="n">onemsk</span><span class="p">[:,</span> <span class="mi">1023</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">onemsk</span><span class="p">[</span><span class="mi">1013</span><span class="p">:</span><span class="mi">1024</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>          <span class="c"># &quot;vignetted&quot; at top indep of slit pos.</span>
            <span class="n">onemsk</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>                   <span class="c"># first row</span>
            <span class="n">onemsk</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span> <span class="mi">253</span><span class="p">:</span><span class="mi">259</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>           <span class="c"># 99feb4 hole made vert stripe at bott.</span>
            <span class="n">onemsk</span><span class="p">[</span><span class="mi">14</span><span class="p">:</span><span class="mi">16</span><span class="p">,</span> <span class="mi">768</span><span class="p">:</span><span class="mi">770</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>         <span class="c"># ... for D2 G230LB, 50CCD</span>

            <span class="n">cenlo</span> <span class="o">=</span> <span class="mi">280</span> <span class="o">-</span> <span class="mf">0.0141</span> <span class="o">*</span> <span class="n">slitpos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">cenhi</span> <span class="o">=</span> <span class="mi">742</span> <span class="o">-</span> <span class="mf">0.0141</span> <span class="o">*</span> <span class="n">slitpos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>   <span class="c">#  orig fid centers</span>

            <span class="k">if</span> <span class="s">&#39;M&#39;</span> <span class="ow">in</span> <span class="n">mode</span><span class="p">:</span>
                <span class="n">cenlo</span> <span class="o">=</span> <span class="mi">286</span> <span class="o">-</span> <span class="mf">0.0141</span> <span class="o">*</span> <span class="n">slitpos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">cenhi</span> <span class="o">=</span> <span class="mi">748</span> <span class="o">-</span> <span class="mf">0.0141</span> <span class="o">*</span> <span class="n">slitpos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">botedge</span> <span class="o">=</span> <span class="mi">22</span> <span class="o">-</span> <span class="mf">0.0141</span> <span class="o">*</span> <span class="n">slitpos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">topedge</span> <span class="o">=</span> <span class="mi">1042</span> <span class="o">-</span> <span class="mf">0.0141</span> <span class="o">*</span> <span class="n">slitpos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">botedge</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span> <span class="n">botedge</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">topedge</span> <span class="o">&gt;</span> <span class="n">ny</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span> <span class="n">topedge</span> <span class="o">=</span> <span class="n">ny</span> <span class="o">-</span> <span class="mi">1</span>

                <span class="k">if</span> <span class="s">&#39;5126&#39;</span> <span class="ow">in</span> <span class="n">mode</span><span class="p">:</span>
                    <span class="n">onemsk</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">botedge</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>   <span class="c"># bad at bottom</span>
                    <span class="n">onemsk</span><span class="p">[</span><span class="n">topedge</span><span class="p">:</span><span class="n">ny</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">1</span>   <span class="c"># top OK</span>
                    <span class="n">cenlo</span> <span class="o">=</span> <span class="mi">304</span> <span class="o">-</span> <span class="mf">0.0141</span> <span class="o">*</span> <span class="n">slitpos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">cenhi</span> <span class="o">=</span> <span class="mi">766</span> <span class="o">-</span> <span class="mf">0.0141</span> <span class="o">*</span> <span class="n">slitpos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="s">&#39;6094&#39;</span> <span class="ow">in</span> <span class="n">mode</span><span class="p">:</span>
                    <span class="n">onemsk</span><span class="p">[</span><span class="mi">1013</span><span class="p">:</span><span class="mi">1024</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">cenlo</span> <span class="o">=</span> <span class="mi">259</span> <span class="o">-</span> <span class="mf">0.0141</span> <span class="o">*</span> <span class="n">slitpos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">cenhi</span> <span class="o">=</span> <span class="mi">721</span> <span class="o">-</span> <span class="mf">0.0141</span> <span class="o">*</span> <span class="n">slitpos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

            <span class="c">#print file, cenlo, cenhi</span>
            <span class="n">cenlo</span> <span class="o">+=</span> <span class="mf">18.</span>
            <span class="n">cenhi</span> <span class="o">+=</span> <span class="mf">18.</span>

            <span class="c">#fiducial masks</span>
            <span class="k">if</span> <span class="s">&#39;52&#39;</span> <span class="ow">in</span> <span class="n">aper</span><span class="p">:</span>
                <span class="n">onemsk</span><span class="p">[</span><span class="n">cenlo</span> <span class="o">-</span> <span class="mi">14</span><span class="p">:</span><span class="n">cenlo</span> <span class="o">+</span> <span class="mi">15</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">onemsk</span><span class="p">[</span><span class="n">cenhi</span> <span class="o">-</span> <span class="mi">19</span><span class="p">:</span><span class="n">cenhi</span> <span class="o">+</span> <span class="mi">20</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">onemsk</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">botedge</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">onemsk</span><span class="p">[</span><span class="n">topedge</span><span class="p">:</span><span class="n">ny</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">err</span><span class="p">[</span>
            <span class="n">onemsk</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>               <span class="c"># err=0 means do not use data</span>
            <span class="n">eps</span><span class="p">[</span>
            <span class="n">onemsk</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">512</span>             <span class="c"># all px rejected flag</span>
            <span class="n">onemsk</span><span class="p">[</span><span class="n">eps</span> <span class="o">&gt;</span> <span class="mi">150</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>              <span class="c"># keep warm px=150</span>

            <span class="c">#fit in col dir first because of glints along L&amp;R edges for 50ccd D2-5216</span>
            <span class="n">cmask</span> <span class="o">=</span> <span class="n">onemsk</span> <span class="o">*</span> <span class="n">ignmsk</span>
            <span class="n">PL</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">cmask</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s">&#39;lower&#39;</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
            <span class="n">PL</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="nb">file</span><span class="p">[:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39;_cmask.pdf&#39;</span><span class="p">)</span>
            <span class="n">PL</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="c">#PL.imshow(onemsk, origin=&#39;lower&#39;, interpolation = None)</span>
            <span class="c">#PL.savefig(file[:-5]+&#39;_onemask.pdf&#39;)</span>
            <span class="c">#PL.close()</span>
            <span class="c">#PL.imshow(ignmsk, origin=&#39;lower&#39;, interpolation = None)</span>
            <span class="c">#PL.savefig(file[:-5]+&#39;_ignmask.pdf&#39;)</span>
            <span class="c">#PL.close()</span>

            <span class="n">colfit</span><span class="p">,</span> <span class="n">flat</span><span class="p">,</span> <span class="n">cmask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fitflat</span><span class="p">(</span><span class="n">hdr0</span><span class="p">,</span> <span class="n">dcr</span><span class="p">,</span> <span class="n">cmask</span><span class="p">,</span> <span class="n">colnodes</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="nb">file</span><span class="p">[:</span><span class="o">-</span><span class="mi">5</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">lamp</span> <span class="o">==</span> <span class="s">&#39;TUNGSTEN&#39;</span> <span class="ow">and</span> <span class="n">aper</span> <span class="o">==</span> <span class="s">&#39;52X2&#39;</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&#39; Cannot do row fit for &#39;</span><span class="p">,</span> <span class="n">lamp</span><span class="p">,</span> <span class="n">aper</span>
                <span class="n">fit</span> <span class="o">=</span> <span class="n">colfit</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">rmask</span> <span class="o">=</span> <span class="n">cmask</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c">#iterate w/ row fits for no em lines</span>
                <span class="c">#ignmsk areas filled w/ the fits</span>
                <span class="n">rmask</span> <span class="o">=</span> <span class="n">onemsk</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s">&#39;G430M-5216_50CCD&#39;</span><span class="p">:</span>
                    <span class="k">print</span><span class="s">&#39;Omit rowfit at ends of &#39;</span><span class="p">,</span> <span class="n">mode</span>
                    <span class="n">rmask</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">61</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">rmask</span><span class="p">[:,</span> <span class="mi">930</span><span class="p">:</span><span class="mi">1024</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="n">fit</span><span class="p">,</span> <span class="n">flat</span><span class="p">,</span> <span class="n">rmask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fitflat</span><span class="p">(</span><span class="n">hdr0</span><span class="p">,</span> <span class="n">colfit</span><span class="p">,</span> <span class="n">rmask</span><span class="p">,</span> <span class="n">rownodes</span><span class="p">,</span> <span class="n">nomed</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="nb">file</span><span class="p">[:</span><span class="o">-</span><span class="mi">5</span><span class="p">])</span>

                <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s">&#39;G430M-5216_50CCD&#39;</span><span class="p">:</span>
                    <span class="n">fit</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">61</span><span class="p">]</span> <span class="o">=</span> <span class="n">colfit</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">61</span><span class="p">]</span>      <span class="c"># bumps at ends of rows</span>
                    <span class="n">fit</span><span class="p">[:,</span> <span class="mi">930</span><span class="p">:</span><span class="mi">1024</span><span class="p">]</span> <span class="o">=</span> <span class="n">colfit</span><span class="p">[:,</span> <span class="mi">930</span><span class="p">:</span><span class="mi">1024</span><span class="p">]</span>

                <span class="n">flat</span> <span class="o">=</span> <span class="n">dcr</span> <span class="o">/</span> <span class="n">fit</span>

            <span class="n">indx</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">cmask</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">rmask</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>   <span class="c"># neither row or col fit</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">err</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>         <span class="c">#err=0 means do not use data </span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">eps</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">512</span>       <span class="c">#all px rejected flag</span>

            <span class="n">flat</span><span class="p">[</span><span class="n">onemsk</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">err</span> <span class="o">=</span> <span class="n">err</span> <span class="o">/</span> <span class="n">fit</span>                             <span class="c"># error in units of flat</span>

            <span class="c">#remove vertical ringing</span>
            <span class="n">yflat</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">iy</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1024</span><span class="p">):</span>
                <span class="n">inc</span> <span class="o">=</span> <span class="n">cmask</span><span class="p">[</span><span class="n">iy</span><span class="p">,</span> <span class="p">:]</span> <span class="o">==</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">flat</span><span class="p">[</span><span class="n">iy</span><span class="p">,</span> <span class="n">inc</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">yflat</span><span class="p">[</span><span class="n">iy</span><span class="p">]</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">flat</span><span class="p">[</span><span class="n">iy</span><span class="p">,</span> <span class="n">inc</span><span class="p">])</span>
                    <span class="n">flat</span><span class="p">[</span><span class="n">iy</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">flat</span><span class="p">[</span><span class="n">iy</span><span class="p">,</span> <span class="p">:]</span> <span class="o">/</span> <span class="n">yflat</span><span class="p">[</span><span class="n">iy</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">flat</span><span class="p">[</span><span class="n">N</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">flat</span><span class="p">)])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&#39;ERROR: there are NaNs in the flat:&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="p">[</span><span class="n">N</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">flat</span><span class="p">)]</span>

            <span class="c">#make plot</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_plot50</span><span class="p">(</span><span class="n">flat</span><span class="p">,</span> <span class="n">xcen</span><span class="p">,</span> <span class="n">ycen</span><span class="p">,</span> <span class="n">rad</span><span class="p">,</span> <span class="nb">file</span><span class="p">[:</span><span class="o">-</span><span class="mi">5</span><span class="p">])</span>

            <span class="c">#create a FITS file</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;pG430M_52x2_gain4m7300_flat&#39;</span><span class="p">,</span> <span class="s">&#39;pG430M_52x2_gain4m3640_flat&#39;</span><span class="p">,</span>
                     <span class="s">&#39;pG430M_52x2_gain4p0000_flat&#39;</span><span class="p">,</span> <span class="s">&#39;pG430M_52x2_gain4p3640_flat&#39;</span><span class="p">,</span>
                     <span class="s">&#39;pG430M_52x2_gain4p7300_flat&#39;</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_writeMakeFITS</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="n">flat</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">sm</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">fname</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</div>
<div class="viewcode-block" id="MakeFlat.CombineFinalFlatS"><a class="viewcode-back" href="../../../SamPy.stis.html#SamPy.stis.STISCCDSpectroscopyFlat.MakeFlat.CombineFinalFlatS">[docs]</a>    <span class="k">def</span> <span class="nf">CombineFinalFlatS</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="n">headerl</span><span class="p">,</span> <span class="n">headerm</span><span class="p">,</span> <span class="n">raws</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Combines all idicidual images to form a single combined flat field for </span>
<span class="sd">        each given mode. Handles flux, error and data quality arrays. Images are</span>
<span class="sd">        combined using weights for each pixel that are calculated using the error</span>
<span class="sd">        arrays. Will take into account the only the pixels that has not been</span>
<span class="sd">        flagged in the data quality array.</span>
<span class="sd">        This function will also call other functions to calculate some basic</span>
<span class="sd">        statistics and to create some plots from the combined image.</span>
<span class="sd">        For L-modes the dust have to pasted from another file. Will use the one</span>
<span class="sd">        that is in the CDBS: /grp/hst/cdbs/oref/k2910262o_pfl.fits.</span>
<span class="sd">        :param list: a list of files to be combined</span>
<span class="sd">        :param headerl: a header for the l-mode combined image</span>
<span class="sd">        :param headerm: a header for the m-mode combined image</span>
<span class="sd">        :param raws: list of raw file names that were used to create the flat</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c">#hard coded value</span>
        <span class="n">siglim</span> <span class="o">=</span> <span class="mi">5</span>

        <span class="n">nimage</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

        <span class="c">#make zero arrays</span>
        <span class="n">added_flux</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">1024</span><span class="p">))</span>
        <span class="n">added_error</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">1024</span><span class="p">))</span>
        <span class="n">added_dq</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">1024</span><span class="p">))</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">1024</span><span class="p">))</span>

        <span class="n">fluxall</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="n">nimage</span><span class="p">))</span>
        <span class="n">errorall</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="n">nimage</span><span class="p">))</span>
        <span class="n">flagsall</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="n">nimage</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="nb">file</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>
            <span class="n">fh</span> <span class="o">=</span> <span class="n">PF</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>
            <span class="n">fluxin</span> <span class="o">=</span> <span class="n">fh</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
            <span class="n">errorin</span> <span class="o">=</span> <span class="n">fh</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
            <span class="n">flagsin</span> <span class="o">=</span> <span class="n">fh</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span> <span class="n">flagsin</span><span class="p">[</span><span class="mi">225</span><span class="p">:</span><span class="mi">801</span><span class="p">,</span> <span class="mi">180</span><span class="p">]</span> <span class="o">=</span> <span class="n">flagsin</span><span class="p">[</span><span class="mi">225</span><span class="p">:</span><span class="mi">801</span><span class="p">,</span> <span class="mi">180</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1024</span>

            <span class="n">fluxall</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">fluxin</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">errorall</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">errorin</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">flagsall</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">flagsin</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1024</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">iy</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1024</span><span class="p">):</span>
                <span class="n">added_dq</span><span class="p">[</span><span class="n">iy</span><span class="p">,</span> <span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">flagsall</span><span class="p">[</span><span class="n">iy</span><span class="p">,</span> <span class="n">ix</span><span class="p">,</span> <span class="p">:])</span>
                <span class="n">ig</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">flagsall</span><span class="p">[</span><span class="n">iy</span><span class="p">,</span> <span class="n">ix</span><span class="p">,</span> <span class="p">:]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">errorall</span><span class="p">[</span><span class="n">iy</span><span class="p">,</span> <span class="n">ix</span><span class="p">,</span> <span class="p">:]</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ig</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">added_flux</span><span class="p">[</span><span class="n">iy</span><span class="p">,</span> <span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
                    <span class="n">added_error</span><span class="p">[</span><span class="n">iy</span><span class="p">,</span> <span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.1</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">ig</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">added_flux</span><span class="p">[</span><span class="n">iy</span><span class="p">,</span> <span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">fluxall</span><span class="p">[</span><span class="n">iy</span><span class="p">,</span> <span class="n">ix</span><span class="p">,</span> <span class="n">ig</span><span class="p">]</span> <span class="o">/</span> <span class="n">errorall</span><span class="p">[</span><span class="n">iy</span><span class="p">,</span> <span class="n">ix</span><span class="p">,</span> <span class="n">ig</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">N</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                        <span class="mf">1.</span> <span class="o">/</span> <span class="n">errorall</span><span class="p">[</span><span class="n">iy</span><span class="p">,</span> <span class="n">ix</span><span class="p">,</span> <span class="n">ig</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="n">added_error</span><span class="p">[</span><span class="n">iy</span><span class="p">,</span> <span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.</span> <span class="o">/</span> <span class="n">N</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mf">1.</span> <span class="o">/</span> <span class="n">errorall</span><span class="p">[</span><span class="n">iy</span><span class="p">,</span> <span class="n">ix</span><span class="p">,</span> <span class="n">ig</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">center</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">fluxall</span><span class="p">[</span><span class="n">iy</span><span class="p">,</span> <span class="n">ix</span><span class="p">,</span> <span class="n">ig</span><span class="p">])</span>
                    <span class="n">std</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">errorall</span><span class="p">[</span><span class="n">iy</span><span class="p">,</span> <span class="n">ix</span><span class="p">,</span> <span class="n">ig</span><span class="p">])</span>
                    <span class="n">igg</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">fluxall</span><span class="p">[</span><span class="n">iy</span><span class="p">,</span> <span class="n">ix</span><span class="p">,</span> <span class="n">ig</span><span class="p">]</span> <span class="o">-</span> <span class="n">center</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">siglim</span> <span class="o">*</span> <span class="n">std</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">igg</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">cov</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">where</span><span class="p">(((</span><span class="n">flagsall</span><span class="p">[</span><span class="n">iy</span><span class="p">,</span> <span class="n">ix</span><span class="p">,</span> <span class="p">:]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">errorall</span><span class="p">[</span><span class="n">iy</span><span class="p">,</span> <span class="n">ix</span><span class="p">,</span> <span class="p">:]</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span>
                        <span class="n">N</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">fluxall</span><span class="p">[</span><span class="n">iy</span><span class="p">,</span> <span class="n">ix</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">center</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">siglim</span> <span class="o">*</span> <span class="n">std</span><span class="p">))</span>
                        <span class="n">added_flux</span><span class="p">[</span><span class="n">iy</span><span class="p">,</span> <span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">fluxall</span><span class="p">[</span><span class="n">iy</span><span class="p">,</span> <span class="n">ix</span><span class="p">,</span> <span class="n">cov</span><span class="p">]</span> <span class="o">/</span> <span class="n">errorall</span><span class="p">[</span><span class="n">iy</span><span class="p">,</span> <span class="n">ix</span><span class="p">,</span> <span class="n">cov</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">N</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                            <span class="mf">1.</span> <span class="o">/</span> <span class="n">errorall</span><span class="p">[</span><span class="n">iy</span><span class="p">,</span> <span class="n">ix</span><span class="p">,</span> <span class="n">cov</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
                        <span class="n">added_error</span><span class="p">[</span><span class="n">iy</span><span class="p">,</span> <span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.</span> <span class="o">/</span> <span class="n">N</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mf">1.</span> <span class="o">/</span> <span class="n">errorall</span><span class="p">[</span><span class="n">iy</span><span class="p">,</span> <span class="n">ix</span><span class="p">,</span> <span class="n">cov</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">added_flux</span><span class="p">[</span><span class="n">iy</span><span class="p">,</span> <span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">center</span>
                        <span class="n">added_error</span><span class="p">[</span><span class="n">iy</span><span class="p">,</span> <span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">std</span>

        <span class="c">#fix spurious errors</span>
        <span class="n">added_error</span><span class="p">[</span><span class="n">added_error</span> <span class="o">&gt;</span> <span class="mf">0.1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.1</span>
        <span class="n">added_flux</span><span class="p">[</span><span class="n">added_flux</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
        <span class="n">added_dq</span><span class="p">[</span><span class="n">added_flux</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1024</span>

        <span class="c">#low and med res copies</span>
        <span class="n">flat_l</span> <span class="o">=</span> <span class="n">added_flux</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">flat_m</span> <span class="o">=</span> <span class="n">added_flux</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">err_l</span> <span class="o">=</span> <span class="n">added_error</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">err_m</span> <span class="o">=</span> <span class="n">added_error</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">dq_l</span> <span class="o">=</span> <span class="n">added_dq</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">dq_m</span> <span class="o">=</span> <span class="n">added_dq</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c"># flag and patch dust motes (dq=1024)                                                                                                                                  </span>
        <span class="n">m_mote</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">1024</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">N</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
        <span class="n">l_mote</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">1024</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">N</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
        <span class="n">l_mote</span><span class="p">,</span> <span class="n">xlcen</span><span class="p">,</span> <span class="n">ylcen</span><span class="p">,</span> <span class="n">radl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_badspot</span><span class="p">(</span><span class="n">l_mote</span><span class="p">,</span> <span class="s">&#39;G430L&#39;</span><span class="p">)</span>
        <span class="n">m_mote</span><span class="p">,</span> <span class="n">xmcen</span><span class="p">,</span> <span class="n">ymcen</span><span class="p">,</span> <span class="n">radm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_badspot</span><span class="p">(</span><span class="n">m_mote</span><span class="p">,</span> <span class="s">&#39;G430M&#39;</span><span class="p">)</span>

        <span class="c"># since basic flats are from m mode data, have to also replace area covered by                                                                                         </span>
        <span class="c"># m-mode motes with &quot;good&quot; l mode data to produce l mode pflat.                                                                                                        </span>
        <span class="n">l_mote_ext</span> <span class="o">=</span> <span class="n">l_mote</span> <span class="o">*</span> <span class="n">m_mote</span>

        <span class="c"># flag dust motes with 1024                                                                                                                                            </span>
        <span class="n">dq_l</span><span class="p">[</span><span class="n">l_mote_ext</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dq_l</span><span class="p">[</span><span class="n">l_mote_ext</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1024</span>
        <span class="n">dq_m</span><span class="p">[</span><span class="n">m_mote</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dq_m</span><span class="p">[</span><span class="n">m_mote</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1024</span>

        <span class="c"># leave m-mode modes alone, but paste into l_mode motes from another file                                                                                                                                                                  </span>
        <span class="n">templ_f</span> <span class="o">=</span> <span class="n">PF</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s">&#39;/grp/hst/cdbs/oref/k2910262o_pfl.fits&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
        <span class="n">templ_e</span> <span class="o">=</span> <span class="n">PF</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s">&#39;/grp/hst/cdbs/oref/k2910262o_pfl.fits&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
        <span class="n">l_mote_loc</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">l_mote_ext</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">flat_l</span><span class="p">[</span><span class="n">l_mote_loc</span><span class="p">]</span> <span class="o">=</span> <span class="n">templ_f</span><span class="p">[</span><span class="n">l_mote_loc</span><span class="p">]</span>
        <span class="n">err_l</span><span class="p">[</span><span class="n">l_mote_loc</span><span class="p">]</span> <span class="o">=</span> <span class="n">templ_e</span><span class="p">[</span><span class="n">l_mote_loc</span><span class="p">]</span>

        <span class="c"># write individual extensions of low and high disp file</span>
        <span class="n">templ</span> <span class="o">=</span> <span class="s">&#39;/grp/hst/cdbs/oref/n491401ho_pfl.fits&#39;</span> <span class="c">#</span>
        <span class="n">tempm</span> <span class="o">=</span> <span class="s">&#39;/grp/hst/cdbs/oref/n491401ko_pfl.fits&#39;</span> <span class="c">#&#39;n491401eo_pfl.fits&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_writeCombinedFits</span><span class="p">(</span><span class="n">flat_l</span><span class="p">,</span> <span class="n">err_l</span><span class="p">,</span> <span class="n">dq_l</span><span class="p">,</span> <span class="n">headerl</span><span class="p">,</span> <span class="n">templ</span><span class="p">,</span> <span class="n">raws</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">+</span> <span class="s">&#39;coadd_comb_reject_l.fits&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_writeCombinedFits</span><span class="p">(</span><span class="n">flat_m</span><span class="p">,</span> <span class="n">err_m</span><span class="p">,</span> <span class="n">dq_m</span><span class="p">,</span> <span class="n">headerm</span><span class="p">,</span> <span class="n">tempm</span><span class="p">,</span> <span class="n">raws</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">+</span> <span class="s">&#39;coadd_comb_reject_m.fits&#39;</span><span class="p">)</span>

        <span class="c">#make some extra plots</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_plot50</span><span class="p">(</span><span class="n">flat_l</span><span class="p">,</span> <span class="n">xlcen</span><span class="p">,</span> <span class="n">ylcen</span><span class="p">,</span> <span class="n">radl</span><span class="p">,</span> <span class="s">&#39;coadd_comb_reject_l&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_plot50</span><span class="p">(</span><span class="n">flat_m</span><span class="p">,</span> <span class="n">xmcen</span><span class="p">,</span> <span class="n">ymcen</span><span class="p">,</span> <span class="n">radm</span><span class="p">,</span> <span class="s">&#39;coadd_comb_reject_m&#39;</span><span class="p">)</span>

        <span class="c">#print out some information</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_doStats</span><span class="p">(</span><span class="n">flat_l</span><span class="p">,</span> <span class="s">&#39;L-mode Flat&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_doStats</span><span class="p">(</span><span class="n">flat_m</span><span class="p">,</span> <span class="s">&#39;M-mode Flat&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="MakeFlat.MakeCopies"><a class="viewcode-back" href="../../../SamPy.stis.html#SamPy.stis.STISCCDSpectroscopyFlat.MakeFlat.MakeCopies">[docs]</a>    <span class="k">def</span> <span class="nf">MakeCopies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Copies newly created p-flat files over to a new directory and</span>
<span class="sd">        names the new files appropriately which are appropriate for CDBS</span>
<span class="sd">        delivery.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">outdir</span> <span class="o">=</span> <span class="s">&#39;./final/&#39;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">outdir</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;Final output directory exists&#39;</span>
            <span class="k">pass</span>

        <span class="c">#shutil.copy(src, dst)</span>

        <span class="n">l</span> <span class="o">=</span> <span class="s">&#39;./out/coadd_comb_reject_l.fits&#39;</span>
        <span class="n">m</span> <span class="o">=</span> <span class="s">&#39;./out/coadd_comb_reject_m.fits&#39;</span>

        <span class="n">mfiles</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;g230mb_new_pfl.fits&#39;</span><span class="p">,</span> <span class="s">&#39;g430m_new_pfl.fits&#39;</span><span class="p">,</span> <span class="s">&#39;g750m_new_pfl.fits&#39;</span><span class="p">]</span>
        <span class="n">lfiles</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;g230lb_new_pfl.fits&#39;</span><span class="p">,</span> <span class="s">&#39;g430l_new_pfl.fits&#39;</span><span class="p">,</span> <span class="s">&#39;g750l_new_pfl.fits&#39;</span><span class="p">]</span>

        <span class="k">for</span> <span class="nb">file</span> <span class="ow">in</span> <span class="n">mfiles</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">outdir</span> <span class="o">+</span> <span class="nb">file</span><span class="p">)</span>
            <span class="n">fh</span> <span class="o">=</span> <span class="n">PF</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">outdir</span> <span class="o">+</span> <span class="nb">file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;update&#39;</span><span class="p">)</span>
            <span class="n">hdr0</span> <span class="o">=</span> <span class="n">fh</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
            <span class="n">hdr0</span><span class="p">[</span><span class="s">&#39;FILENAME&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">file</span>
            <span class="n">hdr0</span><span class="p">[</span><span class="s">&#39;OPT_ELEM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">file</span><span class="p">[:</span><span class="nb">file</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">for</span> <span class="nb">file</span> <span class="ow">in</span> <span class="n">lfiles</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">outdir</span> <span class="o">+</span> <span class="nb">file</span><span class="p">)</span>
            <span class="n">fh</span> <span class="o">=</span> <span class="n">PF</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">outdir</span> <span class="o">+</span> <span class="nb">file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;update&#39;</span><span class="p">)</span>
            <span class="n">hdr0</span> <span class="o">=</span> <span class="n">fh</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
            <span class="n">hdr0</span><span class="p">[</span><span class="s">&#39;FILENAME&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">file</span>
            <span class="n">hdr0</span><span class="p">[</span><span class="s">&#39;OPT_ELEM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">file</span><span class="p">[:</span><span class="nb">file</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

</div></div>
<div class="viewcode-block" id="process_args"><a class="viewcode-back" href="../../../SamPy.stis.html#SamPy.stis.STISCCDSpectroscopyFlat.process_args">[docs]</a><span class="k">def</span> <span class="nf">process_args</span><span class="p">(</span><span class="n">just_print_help</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Processes and parses the command line arguments.</span>
<span class="sd">    Will also print help and the version of the script if requested.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="kn">from</span> <span class="nn">optparse</span> <span class="kn">import</span> <span class="n">OptionParser</span>

    <span class="n">usage</span> <span class="o">=</span> <span class="s">&#39;usage: %prog [options]&#39;</span>
    <span class="n">desc</span> <span class="o">=</span> <span class="s">&#39;This script can be used to generates STIS CCD spectroscopic flat field images.&#39;</span>

    <span class="n">parser</span> <span class="o">=</span> <span class="n">OptionParser</span><span class="p">(</span><span class="n">usage</span><span class="o">=</span><span class="n">usage</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="s">&#39;%prog &#39;</span> <span class="o">+</span> <span class="n">__version__</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">desc</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;-o&#39;</span><span class="p">,</span> <span class="s">&#39;--output&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;output&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s">&#39;Output directory. If not given, will use ./out/&#39;</span><span class="p">,</span>
                      <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;string&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;-i&#39;</span><span class="p">,</span> <span class="s">&#39;--input&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;input&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s">&#39;Input directory. If not given, will use ./obs/&#39;</span><span class="p">,</span>
                      <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;string&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;-f&#39;</span><span class="p">,</span> <span class="s">&#39;--filelists&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;filelist&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s">&#39;Will list each suitable crj file in a file list.&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;-c&#39;</span><span class="p">,</span> <span class="s">&#39;--crreject&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;crreject&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s">&#39;Will run CalSTIS for all raw files.&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;-b&#39;</span><span class="p">,</span> <span class="s">&#39;--combine&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;combine&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s">&#39;Will combine suitable images using ocrreject.&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;-5&#39;</span><span class="p">,</span> <span class="s">&#39;--50ccd&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;ccd&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s">&#39;Will generate flat field images from 50CCD observations.&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;-s&#39;</span><span class="p">,</span> <span class="s">&#39;--slit&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;slit&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s">&#39;Will generate flat field images from 52X2 observations.&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;-g&#39;</span><span class="p">,</span> <span class="s">&#39;--generate&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;generate&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s">&#39;Will generate the final flat field images.&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;-m&#39;</span><span class="p">,</span> <span class="s">&#39;--make&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;copy&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s">&#39;Will copy generated files to a new directory.&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;--stats&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;stats&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s">&#39;Calculates some statistics from coadd_*fits files.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">just_print_help</span><span class="p">:</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">print_help</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="checkZeroArguments"><a class="viewcode-back" href="../../../SamPy.stis.html#SamPy.stis.STISCCDSpectroscopyFlat.checkZeroArguments">[docs]</a><span class="k">def</span> <span class="nf">checkZeroArguments</span><span class="p">(</span><span class="n">opts</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Checks if no command line arguments were given.</span>
<span class="sd">    :param opts: option parser instance. </span>
<span class="sd">    :requires: True or False</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">opts</span><span class="o">.</span><span class="n">__dict__</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
    <span class="k">return</span> <span class="bp">False</span>
</div>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    The main program starts here.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c">#HARDCODED values:</span>
    <span class="n">slitpos</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">7300</span><span class="p">,</span> <span class="o">-</span><span class="mi">3640</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3640</span><span class="p">,</span> <span class="mi">7300</span><span class="p">]</span>     <span class="c">#slit wheel positions</span>

    <span class="c">#option parser</span>
    <span class="n">opts</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="n">process_args</span><span class="p">()</span>
    <span class="c">#process zero arguments</span>
    <span class="k">if</span> <span class="n">checkZeroArguments</span><span class="p">(</span><span class="n">opts</span><span class="p">)</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&#39;Will do all&#39;</span>
        <span class="n">opts</span><span class="o">.</span><span class="n">filelist</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">opts</span><span class="o">.</span><span class="n">crreject</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">opts</span><span class="o">.</span><span class="n">combine</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">opts</span><span class="o">.</span><span class="n">ccd</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">opts</span><span class="o">.</span><span class="n">slit</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">opts</span><span class="o">.</span><span class="n">generate</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">opts</span><span class="o">.</span><span class="n">copy</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">output</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">output</span> <span class="o">=</span> <span class="s">&#39;./out/&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">opts</span><span class="o">.</span><span class="n">output</span>
    <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">input</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="nb">input</span> <span class="o">=</span> <span class="s">&#39;./obs/&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">input</span> <span class="o">=</span> <span class="n">opts</span><span class="o">.</span><span class="n">input</span>

    <span class="c">#test that folders exists</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s">&#39;No valid input directory, please specify one!&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">output</span><span class="p">)</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>

    <span class="c">#objects</span>
    <span class="n">F</span> <span class="o">=</span> <span class="n">Findfiles</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">PrepareFiles</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">MakeFlat</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>

    <span class="c">#find all raws that match the obs mode</span>
    <span class="n">allRaws</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="nb">input</span> <span class="o">+</span> <span class="s">&#39;*_raw.fits&#39;</span><span class="p">)</span>
    <span class="n">raws</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">obsMode</span><span class="p">(</span><span class="n">allRaws</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">crreject</span><span class="p">:</span>
        <span class="c">#modify headers and run calstis</span>
        <span class="k">print</span> <span class="s">&#39;</span><span class="se">\n\n</span><span class="s">Modifying header keywords and running CalSTIS...&#39;</span>
        <span class="n">P</span><span class="o">.</span><span class="n">changeKeywords</span><span class="p">(</span><span class="n">raws</span><span class="p">)</span>
        <span class="n">M</span><span class="o">.</span><span class="n">crreject</span><span class="p">(</span><span class="n">raws</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">filelist</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&#39;</span><span class="se">\n\n</span><span class="s">Generating file lists...&#39;</span>
        <span class="c">#find all crj files</span>
        <span class="n">org</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
        <span class="n">allCrjs</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s">&#39;*_crj.fits&#39;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">org</span><span class="p">)</span>
        <span class="c">#50ccd</span>
        <span class="n">cr</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">apertureFilter</span><span class="p">(</span><span class="n">allCrjs</span><span class="p">,</span> <span class="n">aperture</span><span class="o">=</span><span class="s">&#39;50CCD&#39;</span><span class="p">,</span> <span class="nb">filter</span><span class="o">=</span><span class="s">&#39;Clear&#39;</span><span class="p">)</span>
        <span class="n">gain1</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">gain</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">gain4</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">gain</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gain1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">gain4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;Did not find find suitable 50CCD Clear files for one of the gain settings...&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">F</span><span class="o">.</span><span class="n">writeToASCIIFile</span><span class="p">(</span><span class="n">gain1</span><span class="p">,</span> <span class="s">&#39;g430m_50ccd_gain1_crj.txt&#39;</span><span class="p">)</span>
            <span class="n">F</span><span class="o">.</span><span class="n">writeToASCIIFile</span><span class="p">(</span><span class="n">gain4</span><span class="p">,</span> <span class="s">&#39;g430m_50ccd_gain4_crj.txt&#39;</span><span class="p">)</span>
            <span class="c">#52x2</span>
        <span class="n">nominal</span> <span class="o">=</span> <span class="mi">3242355</span>
        <span class="n">a52x2</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">apertureFilter</span><span class="p">(</span><span class="n">allCrjs</span><span class="p">,</span> <span class="n">aperture</span><span class="o">=</span><span class="s">&#39;52X2&#39;</span><span class="p">,</span> <span class="nb">filter</span><span class="o">=</span><span class="s">&#39;Clear&#39;</span><span class="p">)</span>
        <span class="n">poss</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">slitwheelPos</span><span class="p">(</span><span class="n">a52x2</span><span class="p">,</span> <span class="n">slitpos</span><span class="p">,</span> <span class="n">nominal</span><span class="p">,</span> <span class="n">tolerance</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">poss</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">F</span><span class="o">.</span><span class="n">writeToASCIIFile</span><span class="p">(</span><span class="n">poss</span><span class="p">[</span><span class="n">val</span><span class="p">],</span> <span class="s">&#39;g430m_52x2m</span><span class="si">%i</span><span class="s">_crj.txt&#39;</span> <span class="o">%</span> <span class="o">-</span><span class="n">val</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">val</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">F</span><span class="o">.</span><span class="n">writeToASCIIFile</span><span class="p">(</span><span class="n">poss</span><span class="p">[</span><span class="n">val</span><span class="p">],</span> <span class="s">&#39;g430m_52x2_crj.txt&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">F</span><span class="o">.</span><span class="n">writeToASCIIFile</span><span class="p">(</span><span class="n">poss</span><span class="p">[</span><span class="n">val</span><span class="p">],</span> <span class="s">&#39;g430m_52x2p</span><span class="si">%i</span><span class="s">_crj.txt&#39;</span> <span class="o">%</span> <span class="n">val</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">combine</span><span class="p">:</span>
        <span class="c">#combine similar images</span>
        <span class="n">org</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
        <span class="n">txts</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s">&#39;*.txt&#39;</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&#39;</span><span class="se">\n\n</span><span class="s">Combining individual images...&#39;</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">txts</span><span class="p">:</span>
            <span class="n">M</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="s">&#39;:&#39;</span> <span class="o">+</span> <span class="n">a</span><span class="p">,</span> <span class="n">a</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39;fits&#39;</span><span class="p">,</span> <span class="n">crsigmas</span><span class="o">=</span><span class="s">&#39;20&#39;</span><span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">a</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39;fits&#39;</span><span class="p">,</span> <span class="s">&#39;../&#39;</span> <span class="o">+</span> <span class="n">output</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">org</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">ccd</span><span class="p">:</span>
        <span class="c">#Make 50CCD flats</span>
        <span class="k">print</span> <span class="s">&#39;</span><span class="se">\n\n</span><span class="s">Creating 50CCD flats&#39;</span>
        <span class="n">ccdFiles</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;g430m_50ccd_gain1_crj.fits&#39;</span><span class="p">,</span> <span class="s">&#39;g430m_50ccd_gain4_crj.fits&#39;</span><span class="p">]</span>
        <span class="c">#M.make50CDD(ccdFiles, colnodes = 25, rownodes = 13)</span>
        <span class="n">M</span><span class="o">.</span><span class="n">make50CDD</span><span class="p">(</span><span class="n">ccdFiles</span><span class="p">,</span> <span class="n">colnodes</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">rownodes</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span> <span class="c">#colnodes = 20 seems to work better than 25</span>

    <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">slit</span><span class="p">:</span>
        <span class="c">#Make 52x2 flats</span>
        <span class="k">print</span> <span class="s">&#39;</span><span class="se">\n\n</span><span class="s">Creating 52x2 flats&#39;</span>
        <span class="n">Sfiles_tmp</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;g430m_52x2m7300&#39;</span><span class="p">,</span> <span class="s">&#39;g430m_52x2m3640&#39;</span><span class="p">,</span> <span class="s">&#39;g430m_52x2&#39;</span><span class="p">,</span> <span class="s">&#39;g430m_52x2p3640&#39;</span><span class="p">,</span> <span class="s">&#39;g430m_52x2p7300&#39;</span><span class="p">]</span>
        <span class="n">Sfiles</span> <span class="o">=</span> <span class="p">[</span><span class="nb">file</span> <span class="o">+</span> <span class="s">&#39;_crj.fits&#39;</span> <span class="k">for</span> <span class="nb">file</span> <span class="ow">in</span> <span class="n">Sfiles_tmp</span><span class="p">]</span>
        <span class="n">M</span><span class="o">.</span><span class="n">make52X2</span><span class="p">(</span><span class="n">Sfiles</span><span class="p">,</span> <span class="n">slitpos</span><span class="p">,</span> <span class="n">colnodes</span><span class="o">=</span><span class="mi">13</span><span class="p">,</span> <span class="n">rownodes</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">generate</span><span class="p">:</span>
        <span class="c">#Combine to a final flat</span>
        <span class="k">print</span> <span class="s">&#39;</span><span class="se">\n\n</span><span class="s">Combining flats&#39;</span>
        <span class="n">toCombine</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;ppG430M_50CCD_gain4_flat.fits&#39;</span><span class="p">,</span>
                     <span class="s">&#39;ppG430M_50CCD_gain1_flat.fits&#39;</span><span class="p">,</span>
                     <span class="s">&#39;pG430M_52x2_gain4m7300_flat.fits&#39;</span><span class="p">,</span>
                     <span class="s">&#39;pG430M_52x2_gain4m3640_flat.fits&#39;</span><span class="p">,</span>
                     <span class="s">&#39;pG430M_52x2_gain4p0000_flat.fits&#39;</span><span class="p">,</span>
                     <span class="s">&#39;pG430M_52x2_gain4p3640_flat.fits&#39;</span><span class="p">,</span>
                     <span class="s">&#39;pG430M_52x2_gain4p7300_flat.fits&#39;</span><span class="p">]</span>
        <span class="n">headerl</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;USEAFTER&#39;</span><span class="p">:</span> <span class="s">&#39;May 12 2009 00:00:00&#39;</span><span class="p">,</span>
                   <span class="s">&#39;DESCRIP&#39;</span><span class="p">:</span> <span class="s">&#39;REVISED ON-ORBIT STIS SPECTROSCOPIC CCD P-FLAT FOR L-MODES&#39;</span><span class="p">,</span>
                   <span class="s">&#39;PEDIGREE&#39;</span><span class="p">:</span> <span class="s">&#39;INFLIGHT 16/08/2009 15/12/2009&#39;</span><span class="p">}</span>
        <span class="n">headerm</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;USEAFTER&#39;</span><span class="p">:</span> <span class="s">&#39;May 12 2009 00:00:00&#39;</span><span class="p">,</span>
                   <span class="s">&#39;PEDIGREE&#39;</span><span class="p">:</span> <span class="s">&#39;INFLIGHT 16/08/2009 15/12/2009&#39;</span><span class="p">,</span>
                   <span class="s">&#39;DESCRIP&#39;</span><span class="p">:</span> <span class="s">&#39;REVISED ON-ORBIT STIS SPECTROSCOPIC CCD P-FLAT FOR M-MODES&#39;</span><span class="p">}</span>
        <span class="n">toCombine</span> <span class="o">=</span> <span class="p">[</span><span class="n">output</span> <span class="o">+</span> <span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">toCombine</span><span class="p">]</span>
        <span class="n">M</span><span class="o">.</span><span class="n">CombineFinalFlatS</span><span class="p">(</span><span class="n">toCombine</span><span class="p">,</span> <span class="n">headerl</span><span class="p">,</span> <span class="n">headerm</span><span class="p">,</span> <span class="n">raws</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">copy</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&#39;</span><span class="se">\n\n</span><span class="s">Making copies...&#39;</span>
        <span class="n">M</span><span class="o">.</span><span class="n">MakeCopies</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">stats</span><span class="p">:</span>
        <span class="n">M</span><span class="o">.</span><span class="n">_doStats</span><span class="p">(</span><span class="n">PF</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s">&#39;./out/coadd_comb_reject_l.fits&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="s">&#39;L&#39;</span><span class="p">)</span>
        <span class="n">M</span><span class="o">.</span><span class="n">_doStats</span><span class="p">(</span><span class="n">PF</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s">&#39;./out/coadd_comb_reject_m.fits&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="s">&#39;M&#39;</span><span class="p">)</span>

    <span class="k">print</span> <span class="s">&#39;</span><span class="se">\n\n</span><span class="s">Script Ends!&#39;</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">home</a>|&nbsp;</li>
        <li><a href="../../../search.html">search</a>|&nbsp;</li>

          <li><a href="../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2011, Sami-Matias Niemi.
    </div>
  </body>
</html>