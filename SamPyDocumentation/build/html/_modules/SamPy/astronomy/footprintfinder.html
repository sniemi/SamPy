

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>SamPy.astronomy.footprintfinder &mdash; SamPy v0.1 documentation</title>
    <link rel="stylesheet" href="../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="SamPy v0.1 documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body>

<div style="background-color: white; text-align: left; padding: 10px 10px 15px 15px">
</div>

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">home</a>|&nbsp;</li>
        <li><a href="../../../search.html">search</a>|&nbsp;</li>

          <li><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>

      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" size="18" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for SamPy.astronomy.footprintfinder</h1><div class="highlight"><pre>
<span class="c">#! /bin/env python</span>

<span class="c"># This program finds the footprint of the illuminated of a fits image on the sky. This </span>
<span class="c"># footprint is a polygon in pixel (and WCS) coordinates for each chip.</span>
<span class="c">#</span>
<span class="c"># The input fits images images can </span>
<span class="c">#   - be composed of multiple chips</span>
<span class="c">#   - be concave or convex</span>
<span class="c">#   - have non-straight outlines</span>
<span class="c">#   - have bad/masked pixels</span>
<span class="c">#   - have holes</span>
<span class="c">#   - holes with islands in them</span>
<span class="c"># </span>
<span class="c"># There is one main free parameter to the code:</span>
<span class="c">#   - -t/--tolerance specifies the maximum distance an illuminated pixel can have from the polygon </span>
<span class="c">#     footprint.</span>
<span class="c">#</span>
<span class="c"># Requirements: </span>
<span class="c">#   - pyfits</span>
<span class="c">#   - pylab (included in matplotlib. matplotlib requires numpy)</span>
<span class="c">#</span>
<span class="c"># Author: Felix Stoehr, ST-ECF, 2008</span>
<span class="c">#</span>
<span class="c"># Summary of the algorithm used:</span>
<span class="c">#   1) find pixels that are on the image border </span>
<span class="c">#   2) create a tree for fast searches and put the pixels from 1 in there (python dictionary)</span>
<span class="c">#   3) find groups of pixels (i.e. to separate different chips)</span>
<span class="c">#   4) for each group with more than a threshold number of pixels</span>
<span class="c">#      5) select the starting corner (lower left corner)</span>
<span class="c">#      6) get group pixels ordered clockwise by having &quot;the right hand on the wall&quot;</span>
<span class="c">#      7) fit a polygon to the border pixels given a tolerance threshold using Douglas&amp;Puecker</span>
<span class="c">#      8) identify if one footprint is in an other</span>
<span class="c">#      9) compute footprint heirarchy</span>
<span class="c">#     10) write output file and convert the polygon pixel values to sky coordinates</span>
<span class="c">#</span>

<span class="c"># ----------------------------------------------------------------------------------------</span>

<div class="viewcode-block" id="main"><a class="viewcode-back" href="../../../SamPy.astronomy.html#SamPy.astronomy.footprintfinder.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">arguments</span><span class="p">):</span>

<span class="c"># ----------------------------------------------------------------------------------------</span>
   <span class="sd">&#39;&#39;&#39; </span>
<span class="sd">      This is the main function doing the full loop.</span>
<span class="sd">      </span>
<span class="sd">      Note that pyfits reads y,x which is why all the plotting routines are using inverted coordinates.</span>
<span class="sd">      For the description of directions in the comments, we use this inverted notation (i.e. as plotted</span>
<span class="sd">      on the screen)</span>
<span class="sd">   &#39;&#39;&#39;</span>
   <span class="kn">import</span> <span class="nn">pylab</span><span class="o">,</span> <span class="nn">getopt</span><span class="o">,</span> <span class="nn">os</span>
   
   <span class="n">zerovalue</span>    <span class="o">=</span> <span class="mi">0</span>
   <span class="n">minlength</span>    <span class="o">=</span> <span class="mf">0.05</span>
   <span class="n">tolerance</span>    <span class="o">=</span> <span class="mi">5</span>
   <span class="n">extension</span>    <span class="o">=</span> <span class="bp">None</span>
   <span class="n">verbose</span>      <span class="o">=</span> <span class="bp">False</span>
   <span class="n">plotting</span>     <span class="o">=</span> <span class="bp">False</span>
   <span class="n">writepoints</span>  <span class="o">=</span> <span class="bp">False</span>
   <span class="n">returnstring</span> <span class="o">=</span> <span class="bp">False</span>
   <span class="n">ds9</span>          <span class="o">=</span> <span class="bp">False</span>
   <span class="n">date</span>         <span class="o">=</span> <span class="n">runtimestring</span><span class="p">()</span>
   <span class="n">datestring</span>   <span class="o">=</span> <span class="n">getdatetime</span><span class="p">()</span>
   <span class="n">colorlist</span>    <span class="o">=</span> <span class="p">[</span><span class="s">&#39;green&#39;</span><span class="p">,</span><span class="s">&#39;red&#39;</span><span class="p">,</span><span class="s">&#39;yellow&#39;</span><span class="p">,</span><span class="s">&#39;blue&#39;</span><span class="p">,</span><span class="s">&#39;magenta&#39;</span><span class="p">,</span><span class="s">&#39;cyan&#39;</span><span class="p">]</span>

   <span class="k">print</span> <span class="s">&quot;===================================================================================================&quot;</span>
   <span class="n">alert</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">Footprintfinder</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
   <span class="n">alert</span><span class="p">(</span><span class="s">&quot;Copyright (C) Felix Stoehr, 2008 Space Telescope European Coordinating Facility</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
   <span class="n">alert</span><span class="p">(</span><span class="n">date</span><span class="o">+</span><span class="s">&quot;</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">)</span>

   <span class="k">try</span><span class="p">:</span>
      <span class="n">opts</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="n">getopt</span><span class="o">.</span><span class="n">getopt</span><span class="p">(</span><span class="n">arguments</span><span class="o">.</span><span class="n">split</span><span class="p">(),</span> <span class="s">&quot;vpdwrt:z:m:e:h&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s">&quot;verbose&quot;</span><span class="p">,</span> <span class="s">&quot;plotting&quot;</span><span class="p">,</span> <span class="s">&quot;ds9&quot;</span><span class="p">,</span> <span class="s">&quot;writepoints&quot;</span><span class="p">,</span> <span class="s">&quot;returnstring&quot;</span><span class="p">,</span><span class="s">&quot;tolerance=&quot;</span><span class="p">,</span> <span class="s">&quot;zerovalue=&quot;</span><span class="p">,</span> <span class="s">&quot;minlength&quot;</span><span class="p">,</span> <span class="s">&quot;extension&quot;</span><span class="p">,</span> <span class="s">&quot;help&quot;</span><span class="p">])</span>
   <span class="k">except</span> <span class="n">getopt</span><span class="o">.</span><span class="n">GetoptError</span><span class="p">:</span>
      <span class="n">usage</span><span class="p">()</span>
      <span class="n">error</span><span class="p">(</span><span class="s">&quot;ERROR: Could not understand the options!</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">)</span>
      <span class="k">print</span> <span class="s">&quot;================================================================================================&quot;</span>
      <span class="k">return</span>

   <span class="k">for</span> <span class="n">o</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">opts</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">o</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&quot;-v&quot;</span><span class="p">,</span> <span class="s">&quot;--verbose&quot;</span><span class="p">):</span>
         <span class="n">verbose</span> <span class="o">=</span> <span class="bp">True</span>
         <span class="n">alert</span><span class="p">(</span><span class="n">whocalls</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;Verbose ON&quot;</span><span class="o">+</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">o</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&quot;-p&quot;</span><span class="p">,</span> <span class="s">&quot;--plotting&quot;</span><span class="p">):</span>
         <span class="n">plotting</span> <span class="o">=</span> <span class="bp">True</span>
         <span class="n">alert</span><span class="p">(</span><span class="n">whocalls</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;Plotting ON&quot;</span><span class="o">+</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">o</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&quot;-z&quot;</span><span class="p">,</span> <span class="s">&quot;--zerovalue&quot;</span><span class="p">):</span>
         <span class="n">zerovalue</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
         <span class="n">alert</span><span class="p">(</span><span class="n">whocalls</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;Zerovalue = </span><span class="si">%f</span><span class="s"> &quot;</span> <span class="o">%</span> <span class="n">zerovalue</span><span class="o">+</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">o</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&quot;-t&quot;</span><span class="p">,</span> <span class="s">&quot;--tolerance&quot;</span><span class="p">):</span>
         <span class="n">tolerance</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
         <span class="n">alert</span><span class="p">(</span><span class="n">whocalls</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;Tolerance = </span><span class="si">%f</span><span class="s"> &quot;</span> <span class="o">%</span> <span class="n">tolerance</span><span class="o">+</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">o</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&quot;-m&quot;</span><span class="p">,</span> <span class="s">&quot;--minlength&quot;</span><span class="p">):</span>
         <span class="n">minlength</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
         <span class="n">alert</span><span class="p">(</span><span class="n">whocalls</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;Minimal borderlength = </span><span class="si">%f</span><span class="s"> &quot;</span> <span class="o">%</span><span class="n">minlength</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">o</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&quot;-e&quot;</span><span class="p">,</span> <span class="s">&quot;--extension&quot;</span><span class="p">):</span>
         <span class="n">extension</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
         <span class="n">alert</span><span class="p">(</span><span class="n">whocalls</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;FITS file extension = </span><span class="si">%d</span><span class="s"> &quot;</span> <span class="o">%</span> <span class="n">extension</span><span class="o">+</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>        
      <span class="k">if</span> <span class="n">o</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&quot;-w&quot;</span><span class="p">,</span> <span class="s">&quot;--writepoints&quot;</span><span class="p">):</span>
         <span class="n">writepoints</span> <span class="o">=</span> <span class="bp">True</span>
         <span class="n">alert</span><span class="p">(</span><span class="n">whocalls</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;writepoints ON </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">o</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&quot;-r&quot;</span><span class="p">,</span> <span class="s">&quot;--returnstring&quot;</span><span class="p">):</span>
         <span class="n">returnstring</span> <span class="o">=</span> <span class="bp">True</span>
         <span class="n">alert</span><span class="p">(</span><span class="n">whocalls</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;Returnstring ON </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">o</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&quot;-d&quot;</span><span class="p">,</span> <span class="s">&quot;--ds9&quot;</span><span class="p">):</span>
         <span class="n">ds9</span> <span class="o">=</span> <span class="bp">True</span>
         <span class="n">alert</span><span class="p">(</span><span class="n">whocalls</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;ds9 output ON </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">o</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&quot;-h&quot;</span><span class="p">,</span> <span class="s">&quot;--help&quot;</span><span class="p">):</span>
         <span class="n">usage</span><span class="p">()</span>
         <span class="k">return</span> <span class="mi">0</span>

   <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span><span class="mi">1</span><span class="p">:</span>
      <span class="n">usage</span><span class="p">()</span>
      <span class="n">error</span><span class="p">(</span><span class="s">&quot;ERROR: No filename specified!</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">)</span>
      <span class="k">print</span> <span class="s">&quot;===================================================================================================&quot;</span>
      <span class="k">return</span>
   
   <span class="n">filename</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   
   
   <span class="n">borderpixels</span><span class="p">,</span> <span class="n">dimshape</span><span class="p">,</span> <span class="n">wcs</span> <span class="o">=</span> <span class="n">directborder</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">zerovalue</span><span class="p">,</span> <span class="n">extension</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
   
   <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
      <span class="c"># This loop is necessary to allow for the rejection of too-small chips (i.e. 1 or 2 corners)</span>
      <span class="c"># In that case, we will use the full chip. If there are only 1 or two pixels a border pixel</span>
      <span class="c"># in the first place, then no non-zero footprint can be computed anyway.</span>
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">borderpixels</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">:</span>
         <span class="n">warning</span><span class="p">(</span><span class="n">whocalls</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span> <span class="o">+</span><span class="s">&quot;WARNING: </span><span class="si">%d</span><span class="s"> borderpixel(s) found! That is not enough. Using the whole chip.</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">borderpixels</span><span class="p">))</span>
         <span class="n">borderpixels</span> <span class="o">=</span> <span class="p">[]</span>
         <span class="c"># We do create the rectangle surrounding the whole chip here</span>
         <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dimshape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">borderpixels</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">])</span>
            <span class="n">borderpixels</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">dimshape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">])</span>         
         <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">dimshape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">borderpixels</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
            <span class="n">borderpixels</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">i</span><span class="p">,</span> <span class="n">dimshape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
         <span class="n">borderpixels</span> <span class="o">=</span> <span class="n">pylab</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">borderpixels</span><span class="p">)</span>   
               
      <span class="n">borderdictionary</span>            <span class="o">=</span> <span class="n">getborderdictionary</span><span class="p">(</span><span class="n">borderpixels</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
   
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">borderdictionary</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">borderpixels</span><span class="p">):</span>
         <span class="k">raise</span> <span class="ne">Exception</span> <span class="p">(</span><span class="s">&#39;ERROR: Dictionary creation failed. Must stop here.&#39;</span><span class="p">)</span>
         
      <span class="n">groups</span><span class="p">,</span> <span class="n">grouplen</span><span class="p">,</span> <span class="n">groupid</span><span class="p">,</span> <span class="n">firstid</span><span class="p">,</span> <span class="n">nextid</span> <span class="o">=</span> <span class="n">getgroups</span><span class="p">(</span><span class="n">borderpixels</span><span class="p">,</span> <span class="n">borderdictionary</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
   
      <span class="c"># Note: find gives a wrong result if grouplen is a list instead of a pylab array!</span>
      <span class="n">chips</span> <span class="o">=</span> <span class="n">groups</span><span class="p">[</span><span class="n">pylab</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">pylab</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">grouplen</span><span class="p">)</span><span class="o">&gt;</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">borderpixels</span><span class="p">)</span><span class="o">*</span><span class="n">minlength</span><span class="p">))]</span>
      <span class="k">print</span> <span class="n">whocalls</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;Found </span><span class="si">%d</span><span class="s"> chips (out of </span><span class="si">%d</span><span class="s"> groups).&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">chips</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">groups</span><span class="p">))</span>
   
      <span class="n">footprintlist</span>       <span class="o">=</span> <span class="p">[]</span>
      <span class="n">simplefootprintlist</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="n">orderlist</span>           <span class="o">=</span> <span class="p">[]</span>   
      <span class="k">for</span> <span class="n">chip</span> <span class="ow">in</span> <span class="n">chips</span><span class="p">:</span> 
         <span class="k">print</span> <span class="n">whocalls</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;Doing chip </span><span class="si">%d</span><span class="s"> ....&quot;</span> <span class="o">%</span> <span class="n">pylab</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">pylab</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">chips</span><span class="p">)</span><span class="o">==</span><span class="n">chip</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
         <span class="n">order</span>           <span class="o">=</span> <span class="n">getpixelorder</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">borderpixels</span><span class="p">,</span> <span class="n">borderdictionary</span><span class="p">,</span> <span class="n">groupid</span><span class="p">,</span> <span class="n">grouplen</span><span class="p">,</span> <span class="n">firstid</span><span class="p">,</span> <span class="n">nextid</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>      
         <span class="n">thistolerance</span>   <span class="o">=</span> <span class="n">tolerance</span>
         <span class="n">simplefootprint</span> <span class="o">=</span> <span class="n">simplifyDP</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">borderpixels</span><span class="p">,</span> <span class="n">thistolerance</span><span class="p">)</span>
         <span class="k">print</span> <span class="n">whocalls</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;Footprint corners simplified:&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">simplefootprint</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
         
         <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">simplefootprint</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">:</span>
            <span class="c"># In some cases, the footprint would be so small, that it has only 1 or 2 corners.</span>
            <span class="c"># Although this might be real, it also could be that if a smaller tolerance value had</span>
            <span class="c"># been chosen, the footprint would be a &quot;real&quot; one. If the number of corners therefore is </span>
            <span class="c"># small, we force a small tolerance value.</span>
            <span class="n">thistolerance</span> <span class="o">=</span> <span class="mf">0.5</span>
            <span class="n">warning</span><span class="p">(</span><span class="n">whocalls</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span> <span class="o">+</span><span class="s">&quot;WARNING: Too few corners in this chip. Trying with tolerance=</span><span class="si">%f</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">thistolerance</span><span class="p">)</span>         
            <span class="n">simplefootprint</span> <span class="o">=</span> <span class="n">simplifyDP</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">borderpixels</span><span class="p">,</span> <span class="n">thistolerance</span><span class="p">)</span>
            <span class="n">warning</span><span class="p">(</span><span class="n">whocalls</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;WARNING: Footprint corners simplified: </span><span class="si">%d</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">simplefootprint</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
            
         <span class="c"># Now, if even this does not work, do not use this chip at all.</span>
         <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">simplefootprint</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">simplefootprintlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">simplefootprint</span><span class="p">)</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="n">warning</span><span class="p">(</span><span class="n">whocalls</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;WARNING: Still too few corners! This footprint will be skipped.</span><span class="se">\n</span><span class="s">&quot;</span> <span class="p">)</span>
   
      <span class="c"># In the very rare case, where NO chip is retained because ALL were skipped, we will use the full chip. For this, we do have to </span>
      <span class="c"># go back to the beginning and rerun the footprintfinder using the full exterior border.</span>
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">simplefootprintlist</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
         <span class="k">break</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="c"># This forces the use of the full chip.</span>
         <span class="n">warning</span><span class="p">(</span><span class="n">whocalls</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;WARNING: No footprint with more than 2 corners found.</span><span class="se">\n</span><span class="s">&quot;</span> <span class="p">)</span>
         <span class="n">borderpixels</span> <span class="o">=</span> <span class="p">[]</span>
         
   <span class="n">heirarchy</span> <span class="o">=</span> <span class="n">getheirarchy</span><span class="p">(</span><span class="n">simplefootprintlist</span><span class="p">,</span> <span class="n">borderpixels</span><span class="p">)</span>
   <span class="n">centroid</span>  <span class="o">=</span> <span class="n">getcentroid</span><span class="p">(</span><span class="n">simplefootprintlist</span><span class="p">,</span> <span class="n">borderpixels</span><span class="p">,</span> <span class="n">heirarchy</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
   
   <span class="n">writeoutput</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">simplefootprintlist</span><span class="p">,</span> <span class="n">borderpixels</span><span class="p">,</span> <span class="n">heirarchy</span><span class="p">,</span> <span class="n">wcs</span><span class="p">,</span> <span class="n">centroid</span><span class="p">,</span> <span class="n">arguments</span><span class="p">,</span> <span class="n">writepoints</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
   <span class="k">if</span> <span class="n">ds9</span><span class="p">:</span>
      <span class="n">writeds9output</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">simplefootprintlist</span><span class="p">,</span> <span class="n">borderpixels</span><span class="p">,</span> <span class="n">heirarchy</span><span class="p">,</span> <span class="n">wcs</span><span class="p">,</span> <span class="n">centroid</span><span class="p">,</span> <span class="n">colorlist</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>

   <span class="k">print</span> <span class="n">whocalls</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;Footprint generation finished successfully.&quot;</span>   

   <span class="k">if</span> <span class="n">plotting</span><span class="p">:</span>
      <span class="n">plotfootprints</span><span class="p">(</span><span class="n">simplefootprintlist</span><span class="p">,</span> <span class="n">borderpixels</span><span class="p">,</span> <span class="n">dimshape</span><span class="p">,</span> <span class="n">chips</span><span class="p">,</span> <span class="n">groupid</span><span class="p">,</span> <span class="n">firstid</span><span class="p">,</span> <span class="n">nextid</span><span class="p">,</span> <span class="n">grouplen</span><span class="p">,</span> <span class="n">heirarchy</span><span class="p">,</span> <span class="n">centroid</span><span class="p">,</span> <span class="n">colorlist</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
 
   <span class="n">alert</span><span class="p">(</span><span class="n">whocalls</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span> <span class="o">+</span> <span class="n">runtimestring</span><span class="p">(</span><span class="n">date</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
   <span class="k">print</span> <span class="s">&quot;===================================================================================================&quot;</span>            
   
   <span class="k">if</span> <span class="n">returnstring</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">getreturnstring</span><span class="p">(</span><span class="n">simplefootprintlist</span><span class="p">,</span> <span class="n">borderpixels</span><span class="p">,</span> <span class="n">heirarchy</span><span class="p">,</span> <span class="n">centroid</span><span class="p">,</span> <span class="n">wcs</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
   
<span class="c">#------------------------------------------------------------------------------------------------</span>
</div>
<div class="viewcode-block" id="usage"><a class="viewcode-back" href="../../../SamPy.astronomy.html#SamPy.astronomy.footprintfinder.usage">[docs]</a><span class="k">def</span> <span class="nf">usage</span><span class="p">():</span>   

<span class="c">#------------------------------------------------------------------------------------------------</span>
   <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">      Help.</span>
<span class="sd">   &#39;&#39;&#39;</span>
   <span class="k">print</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">usage:  footpritfinder.py [options] fitsfilename.fits</span>
<span class="s">output: fitsfilename_footprint.txt</span>

<span class="s">INTRODUCTION</span>
<span class="s">   </span>
<span class="s">   The footprintfinder reads a FITS file, identifies the footprint(s) of the illuminated pixels and</span>
<span class="s">   writes them into an ascii output file.</span>
<span class="s">   </span>
<span class="s">   This output file is written to the local directory and contains the number of footprints</span>
<span class="s">   detected and for each of them the number of footprint corners, information about the footprint</span>
<span class="s">   heirarchy (i.e holes/islands) and then the x y ra dec coordinates. Ra and Dec coordinates will </span>
<span class="s">   be only computed if the CTYPE1/CTYPE2 are &#39;RA---TAN/DEC--TAN&#39;.</span>
<span class="s">   </span>
<span class="s">OPTIONS:</span>

<span class="s">   Input:</span>
<span class="s">   -e, --extension      FITS file extension to use. Default=first extension with data. </span>

<span class="s">   Processing:</span>
<span class="s">   -t, --tolerance      Maximum tolerated distance of a pixel from a polygon line. Default=5.</span>
<span class="s">   -z, --zerovalue      Value of the pixels that should be identified as &#39;border&#39;. If a pixel value</span>
<span class="s">                        &#39;nan&#39;, it is replaced with the zerovalue, too.</span>
<span class="s">   -m, --minlength      Minimal length of a continous footprint border to be taken into account as</span>
<span class="s">                        a fraction of the total number of border pixels. Default=0.05.</span>
<span class="s">   Output:</span>
<span class="s">   -p, --plotting       Plots the footprint. Default=off.   </span>
<span class="s">   -d, --ds9            Writes output file(s) in ds9 region format. One file in image coordinates and </span>
<span class="s">                        if possible (i.e. projection is RA--TAN, DEC-TAN) a second one in WCS </span>
<span class="s">                        coordinates are produced. Default=off.</span>
<span class="s">   -w, --writepoints    Writes the polygon coordinates on the screen. Default=off.</span>
<span class="s">   -v, --verbose        Increase verbosity.</span>
<span class="s">   </span>
<span class="s">   Help:</span>
<span class="s">   -h,  --help          Print this help.</span>
<span class="s">   </span>
<span class="s">DETAILS</span>

<span class="s">   The footprintfinder takes .fits .fits.gz or .fits.fz files as input (i.e. using pyfits). If the </span>
<span class="s">   files are uncompressed, then the code can process the file line by line, which results in a very </span>
<span class="s">   low memory use. If the files are compressed, then pyfits uncompresses the whole file in memory </span>
<span class="s">   before reading it. For large compressed files, it may be therefore advantageous to uncompress</span>
<span class="s">   the whole file before running the footprintfinder on it. If not specified otherwise, the first </span>
<span class="s">   FITS extension that contains any data is used. </span>
<span class="s">      </span>
<span class="s">   In a first step, the border pixels are identified using a 8-connect border definition. Then a </span>
<span class="s">   groupfinder with a linking length of sqrt(2) pixel run over the border pixels and groups with </span>
<span class="s">   more than 5</span><span class="si">% o</span><span class="s">f all border pixels (can be overridden witm the -m option) are retained. In each</span>
<span class="s">   group, the pixels are ordered starting from the lower left corner using an algorithm that keeps </span>
<span class="s">   &#39;the-right-hand-on the wall&#39;. If a 90 degree left corner is detected, the normally discarded </span>
<span class="s">   cornerpixel is added to the list in oder to allow for exact concave footprint polygons. A </span>
<span class="s">   Douglas-Puecker algorithm is used to reduce the number of polygon corners. Finally, inclusion of</span>
<span class="s">   footprints in others in computed with a standard point-in-polygon algorithm.</span>
<span class="s">   </span>
<span class="s">   The algorithm is fast, robust, can deal with arbitrarily shaped footprints (i.e. concave </span>
<span class="s">   footprints and even one-pixel-wide lines are possible), returns the full footprint heirarchy and </span>
<span class="s">   has low memory usage if .fits files are treated. It uses uses only information from the fits </span>
<span class="s">   image itself.</span>

<span class="s">LICENCE</span>

<span class="s">   This program is free software: you can redistribute it and/or modify</span>
<span class="s">   it under the terms of the GNU General Public License as published by   </span>
<span class="s">   the Free Software Foundation, version 3 of the License.</span>

<span class="s">   This program is distributed in the hope that it will be useful,</span>
<span class="s">   but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="s">   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
<span class="s">   GNU General Public License for more details.</span>

<span class="s">   You should have received a copy of the GNU General Public License</span>
<span class="s">   along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="s">DOCUMENTATION</span>
<span class="s">   </span>
<span class="s">   A description of the footprintfinder is available in the issue #45 of the ST-ECF newsletter</span>
<span class="s">   </span>
<span class="s">   http://www.spacetelescope.org/about/further_information/newsletters/html/newsletter_45.html</span>

<span class="s">===================================================================================================</span>
<span class="s">   &quot;&quot;&quot;</span>
   
   

<span class="c">#------------------------------------------------------------------------------------------------</span>
</div>
<div class="viewcode-block" id="alert"><a class="viewcode-back" href="../../../SamPy.astronomy.html#SamPy.astronomy.footprintfinder.alert">[docs]</a><span class="k">def</span> <span class="nf">alert</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>

<span class="c">#------------------------------------------------------------------------------------------------</span>
   <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">      prints the string in blue.</span>
<span class="sd">   &#39;&#39;&#39;</span>
   <span class="kn">import</span> <span class="nn">sys</span>
   <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\033</span><span class="s">[39;34m&quot;</span> <span class="o">+</span> <span class="n">string</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\033</span><span class="s">[39;29m&quot;</span><span class="p">)</span>


<span class="c">#------------------------------------------------------------------------------------------------</span>
</div>
<div class="viewcode-block" id="error"><a class="viewcode-back" href="../../../SamPy.astronomy.html#SamPy.astronomy.footprintfinder.error">[docs]</a><span class="k">def</span> <span class="nf">error</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>

<span class="c">#------------------------------------------------------------------------------------------------</span>
   <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">      prints the string in red.</span>
<span class="sd">   &#39;&#39;&#39;</span>
   <span class="kn">import</span> <span class="nn">sys</span>
   <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\033</span><span class="s">[39;31m&quot;</span> <span class="o">+</span> <span class="n">string</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\033</span><span class="s">[39;29m&quot;</span><span class="p">)</span>


<span class="c">#------------------------------------------------------------------------------------------------</span>
</div>
<div class="viewcode-block" id="warning"><a class="viewcode-back" href="../../../SamPy.astronomy.html#SamPy.astronomy.footprintfinder.warning">[docs]</a><span class="k">def</span> <span class="nf">warning</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>

<span class="c">#------------------------------------------------------------------------------------------------</span>
   <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">      prints the string in orange.</span>
<span class="sd">   &#39;&#39;&#39;</span>
   <span class="kn">import</span> <span class="nn">sys</span>
   <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\033</span><span class="s">[39;33m&quot;</span> <span class="o">+</span> <span class="n">string</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\033</span><span class="s">[39;29m&quot;</span><span class="p">)</span>


<span class="c">#------------------------------------------------------------------------------------------------</span>
</div>
<div class="viewcode-block" id="runtimestring"><a class="viewcode-back" href="../../../SamPy.astronomy.html#SamPy.astronomy.footprintfinder.runtimestring">[docs]</a><span class="k">def</span> <span class="nf">runtimestring</span><span class="p">(</span><span class="n">date</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

<span class="c">#------------------------------------------------------------------------------------------------</span>
   <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">     returns a string of the current time and if a date is given, adds the running time from that</span>
<span class="sd">     date.</span>
<span class="sd">   &#39;&#39;&#39;</span>
   <span class="kn">import</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">datetime</span>

   <span class="k">if</span> <span class="n">date</span><span class="o">==</span><span class="bp">None</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%d</span><span class="s">/%m/%Y %H:%M:%S&quot;</span><span class="p">)</span>
   <span class="k">else</span><span class="p">:</span>

      <span class="n">thisdate</span>   <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
      <span class="n">difference</span> <span class="o">=</span> <span class="n">thisdate</span><span class="o">-</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="o">*</span><span class="n">time</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="s">&quot;</span><span class="si">%d</span><span class="s">/%m/%Y %H:%M:%S&quot;</span><span class="p">)[:</span><span class="mi">6</span><span class="p">])</span>

      <span class="n">minutes</span><span class="p">,</span> <span class="n">seconds</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">difference</span><span class="o">.</span><span class="n">seconds</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
      <span class="n">hours</span><span class="p">,</span> <span class="n">minutes</span>   <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">minutes</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
      <span class="n">hours</span>            <span class="o">=</span> <span class="n">hours</span> <span class="o">+</span> <span class="n">difference</span><span class="o">.</span><span class="n">days</span> <span class="o">*</span> <span class="mi">24</span>

   <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">thisdate</span><span class="p">,</span> <span class="s">&quot;</span><span class="si">%d</span><span class="s">/%m/%Y %H:%M:%S&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; (</span><span class="si">%d</span><span class="s">h </span><span class="si">%02d</span><span class="s">m </span><span class="si">%02d</span><span class="s">s)&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">hours</span><span class="p">,</span> <span class="n">minutes</span><span class="p">,</span> <span class="n">seconds</span><span class="p">)</span>


<span class="c">#------------------------------------------------------------------------------------------------</span>
</div>
<div class="viewcode-block" id="getdatetime"><a class="viewcode-back" href="../../../SamPy.astronomy.html#SamPy.astronomy.footprintfinder.getdatetime">[docs]</a><span class="k">def</span> <span class="nf">getdatetime</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

<span class="c">#------------------------------------------------------------------------------------------------</span>
   <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">      returns a SYBSE accepted datetime string. If no datetime object is given, it returns</span>
<span class="sd">      the (local) time.</span>
<span class="sd">   &#39;&#39;&#39;</span>
   <span class="kn">import</span> <span class="nn">datetime</span>

   <span class="k">if</span> <span class="n">time</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>

   <span class="k">return</span> <span class="s">&quot;</span><span class="si">%04d</span><span class="s">-</span><span class="si">%02d</span><span class="s">-</span><span class="si">%02d</span><span class="s"> </span><span class="si">%02d</span><span class="s">:</span><span class="si">%02d</span><span class="s">:</span><span class="si">%02d</span><span class="s">&quot;</span>  <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">day</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">minute</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">second</span><span class="p">)</span>


<span class="c">#------------------------------------------------------------------------------------------------</span>
</div>
<div class="viewcode-block" id="whocalls"><a class="viewcode-back" href="../../../SamPy.astronomy.html#SamPy.astronomy.footprintfinder.whocalls">[docs]</a><span class="k">def</span> <span class="nf">whocalls</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

<span class="c">#------------------------------------------------------------------------------------------------</span>
   <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">      This function returns the caller, the function and the line number.</span>
<span class="sd">   &#39;&#39;&#39;</span>
   <span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">sys</span>
   <span class="n">adjust</span> <span class="o">=</span> <span class="mi">48</span>
   <span class="n">x</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>
   <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
      <span class="k">return</span> <span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">|</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">:l=</span><span class="si">%d</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">getdatetime</span><span class="p">(),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_filename</span><span class="p">),</span> <span class="n">x</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">f_lineno</span><span class="p">))</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">adjust</span><span class="o">+</span><span class="mi">20</span><span class="p">)</span>
   <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">:l=</span><span class="si">%d</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_filename</span><span class="p">),</span> <span class="n">x</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">f_lineno</span><span class="p">))</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">adjust</span><span class="p">)</span>


<span class="c">#------------------------------------------------------------------------------------------------</span>
</div>
<div class="viewcode-block" id="showprogress"><a class="viewcode-back" href="../../../SamPy.astronomy.html#SamPy.astronomy.footprintfinder.showprogress">[docs]</a><span class="k">def</span> <span class="nf">showprogress</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">lastprogress</span><span class="p">):</span>

<span class="c">#------------------------------------------------------------------------------------------------</span>
   <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">      This function shows the progress of an iteration. i=current number, n=total number.</span>
<span class="sd">   &#39;&#39;&#39;</span>
   <span class="kn">import</span> <span class="nn">sys</span>
   <span class="n">progress</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">100.0</span> <span class="o">*</span> <span class="n">i</span><span class="o">/</span><span class="n">n</span><span class="p">)</span>
   <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
       <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;100%&quot;</span><span class="p">)</span>
   <span class="k">else</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">progress</span><span class="o">&gt;</span><span class="n">lastprogress</span><span class="p">:</span>
         <span class="n">lastprogress</span> <span class="o">=</span> <span class="n">progress</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">progress</span> <span class="o">%</span> <span class="mi">10</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%d%%</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">progress</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
         <span class="k">elif</span> <span class="p">(</span><span class="n">progress</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

   <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>

   <span class="k">return</span> <span class="n">i</span><span class="p">,</span> <span class="n">lastprogress</span>


<span class="c"># ----------------------------------------------------------------------------------------</span>
</div>
<div class="viewcode-block" id="xy2rd"><a class="viewcode-back" href="../../../SamPy.astronomy.html#SamPy.astronomy.footprintfinder.xy2rd">[docs]</a><span class="k">def</span> <span class="nf">xy2rd</span><span class="p">(</span><span class="n">wcs</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>

<span class="c"># ----------------------------------------------------------------------------------------</span>
   <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">      Code as in stsdas.imgtools.xy2rd</span>
<span class="sd">      Can not treat distorted images.</span>
<span class="sd">      </span>
<span class="sd">   &#39;&#39;&#39;</span>
   <span class="kn">import</span> <span class="nn">pylab</span>
   
   <span class="n">degtorad</span> <span class="o">=</span> <span class="mf">0.017453292519943295</span>
   <span class="n">radtodeg</span> <span class="o">=</span> <span class="mf">57.295779513082323</span>
        
   <span class="n">ra0</span>  <span class="o">=</span> <span class="n">wcs</span><span class="p">[</span><span class="s">&#39;CRVAL1&#39;</span><span class="p">]</span>
   <span class="n">dec0</span> <span class="o">=</span> <span class="n">wcs</span><span class="p">[</span><span class="s">&#39;CRVAL2&#39;</span><span class="p">]</span>

   <span class="c"># translate (x,y) to (ra, dec)</span>
   <span class="n">xi</span>  <span class="o">=</span> <span class="n">wcs</span><span class="p">[</span><span class="s">&#39;CD1_1&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">wcs</span><span class="p">[</span><span class="s">&#39;CRPIX1&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="n">wcs</span><span class="p">[</span><span class="s">&#39;CD1_2&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">wcs</span><span class="p">[</span><span class="s">&#39;CRPIX2&#39;</span><span class="p">])</span>
   <span class="n">eta</span> <span class="o">=</span> <span class="n">wcs</span><span class="p">[</span><span class="s">&#39;CD2_1&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">wcs</span><span class="p">[</span><span class="s">&#39;CRPIX1&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="n">wcs</span><span class="p">[</span><span class="s">&#39;CD2_2&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">wcs</span><span class="p">[</span><span class="s">&#39;CRPIX2&#39;</span><span class="p">])</span>

   <span class="n">xi</span>   <span class="o">=</span> <span class="n">degtorad</span> <span class="o">*</span> <span class="n">xi</span>
   <span class="n">eta</span>  <span class="o">=</span> <span class="n">degtorad</span> <span class="o">*</span> <span class="n">eta</span>
   <span class="n">ra0</span>  <span class="o">=</span> <span class="n">degtorad</span> <span class="o">*</span> <span class="n">ra0</span>
   <span class="n">dec0</span> <span class="o">=</span> <span class="n">degtorad</span> <span class="o">*</span> <span class="n">dec0</span>

   <span class="n">ra</span>  <span class="o">=</span> <span class="n">pylab</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">pylab</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dec0</span><span class="p">)</span> <span class="o">-</span> <span class="n">eta</span> <span class="o">*</span> <span class="n">pylab</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dec0</span><span class="p">))</span> <span class="o">+</span> <span class="n">ra0</span>
   <span class="n">dec</span> <span class="o">=</span> <span class="n">pylab</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">eta</span><span class="o">*</span><span class="n">pylab</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dec0</span><span class="p">)</span> <span class="o">+</span> <span class="n">pylab</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dec0</span><span class="p">),</span> \
                          <span class="n">pylab</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">pylab</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dec0</span><span class="p">)</span> <span class="o">-</span> <span class="n">eta</span> <span class="o">*</span> <span class="n">pylab</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dec0</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">xi</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>

   <span class="n">ra</span>  <span class="o">=</span> <span class="n">radtodeg</span> <span class="o">*</span> <span class="n">ra</span>
   <span class="n">dec</span> <span class="o">=</span> <span class="n">radtodeg</span> <span class="o">*</span> <span class="n">dec</span>
   
   <span class="n">ra</span>  <span class="o">=</span> <span class="n">ra</span> <span class="o">%</span> <span class="mf">360.0</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">ra</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">):</span>
       <span class="n">ra</span> <span class="o">=</span> <span class="n">ra</span> <span class="o">+</span> <span class="mf">360.0</span>
       
   <span class="k">return</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span>    


<span class="c"># ----------------------------------------------------------------------------------------</span>
</div>
<div class="viewcode-block" id="rd2xy"><a class="viewcode-back" href="../../../SamPy.astronomy.html#SamPy.astronomy.footprintfinder.rd2xy">[docs]</a><span class="k">def</span> <span class="nf">rd2xy</span><span class="p">(</span><span class="n">wcs</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">):</span>

<span class="c"># ----------------------------------------------------------------------------------------</span>
   <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">      Code as in stsdas.imgtools.xy2rd</span>
<span class="sd">      Can not treat distorted images.</span>
<span class="sd">      </span>
<span class="sd">      ra dec must be in degrees</span>
<span class="sd">   &#39;&#39;&#39;</span>
   <span class="kn">import</span> <span class="nn">pylab</span>
   
   <span class="n">degtorad</span> <span class="o">=</span> <span class="mf">0.017453292519943295</span>
   <span class="n">radtodeg</span> <span class="o">=</span> <span class="mf">57.295779513082323</span>
        
   <span class="n">ra0</span>  <span class="o">=</span> <span class="n">wcs</span><span class="p">[</span><span class="s">&#39;CRVAL1&#39;</span><span class="p">]</span>
   <span class="n">dec0</span> <span class="o">=</span> <span class="n">wcs</span><span class="p">[</span><span class="s">&#39;CRVAL2&#39;</span><span class="p">]</span>

   <span class="n">det</span> <span class="o">=</span> <span class="n">wcs</span><span class="p">[</span><span class="s">&#39;CD1_1&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">wcs</span><span class="p">[</span><span class="s">&#39;CD2_2&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">wcs</span><span class="p">[</span><span class="s">&#39;CD1_2&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">wcs</span><span class="p">[</span><span class="s">&#39;CD2_1&#39;</span><span class="p">]</span>
   
   <span class="k">if</span> <span class="n">det</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">Excption</span><span class="p">(</span><span class="s">&quot;Singular CD matrix!&quot;</span><span class="p">)</span>
      
   <span class="n">cdinv</span> <span class="o">=</span> <span class="n">pylab</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
   <span class="n">cdinv</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span>  <span class="n">wcs</span><span class="p">[</span><span class="s">&#39;CD2_2&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">det</span>
   <span class="n">cdinv</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">wcs</span><span class="p">[</span><span class="s">&#39;CD1_2&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">det</span>
   <span class="n">cdinv</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">wcs</span><span class="p">[</span><span class="s">&#39;CD2_1&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">det</span>
   <span class="n">cdinv</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span>  <span class="n">wcs</span><span class="p">[</span><span class="s">&#39;CD1_1&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">det</span>
   
   <span class="c"># translate (ra,dec) to (x,y)</span>
   
   
   <span class="n">ra0</span>  <span class="o">=</span> <span class="n">degtorad</span> <span class="o">*</span> <span class="n">ra0</span>
   <span class="n">dec0</span> <span class="o">=</span> <span class="n">degtorad</span> <span class="o">*</span> <span class="n">dec0</span>
   <span class="n">ra</span>   <span class="o">=</span> <span class="n">degtorad</span> <span class="o">*</span> <span class="n">ra</span>
   <span class="n">dec</span>  <span class="o">=</span> <span class="n">degtorad</span> <span class="o">*</span> <span class="n">dec</span>
   
   
   <span class="n">bottom</span> <span class="o">=</span> <span class="n">pylab</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dec</span><span class="p">)</span> <span class="o">*</span> <span class="n">pylab</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dec0</span><span class="p">)</span> <span class="o">+</span> <span class="n">pylab</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dec</span><span class="p">)</span> <span class="o">*</span> <span class="n">pylab</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dec0</span><span class="p">)</span> <span class="o">*</span> <span class="n">pylab</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">ra</span><span class="o">-</span><span class="n">ra0</span><span class="p">)</span>
   <span class="k">if</span> <span class="n">bottom</span> <span class="o">==</span><span class="mi">0</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;Unreasonable ra/dec range&quot;</span><span class="p">)</span>
      
   <span class="n">xi</span>  <span class="o">=</span> <span class="n">pylab</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dec</span><span class="p">)</span> <span class="o">*</span> <span class="n">pylab</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">ra</span><span class="o">-</span><span class="n">ra0</span><span class="p">)</span> <span class="o">/</span> <span class="n">bottom</span>
   <span class="n">eta</span> <span class="o">=</span> <span class="n">pylab</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dec</span><span class="p">)</span> <span class="o">*</span> <span class="n">pylab</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dec0</span><span class="p">)</span> <span class="o">-</span> <span class="n">pylab</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dec</span><span class="p">)</span> <span class="o">*</span> <span class="n">pylab</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dec0</span><span class="p">)</span> <span class="o">*</span> <span class="n">pylab</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">ra</span><span class="o">-</span><span class="n">ra0</span><span class="p">)</span> <span class="o">/</span> <span class="n">bottom</span>

   <span class="n">xi</span>  <span class="o">=</span> <span class="n">radtodeg</span> <span class="o">*</span> <span class="n">xi</span>
   <span class="n">eta</span> <span class="o">=</span> <span class="n">radtodeg</span> <span class="o">*</span> <span class="n">eta</span>
   
   <span class="n">x</span> <span class="o">=</span> <span class="n">cdinv</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">xi</span> <span class="o">+</span> <span class="n">cdinv</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">eta</span> <span class="o">+</span> <span class="n">wcs</span><span class="p">[</span><span class="s">&#39;CRPIX1&#39;</span><span class="p">]</span>
   <span class="n">y</span> <span class="o">=</span> <span class="n">cdinv</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">xi</span> <span class="o">+</span> <span class="n">cdinv</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">eta</span> <span class="o">+</span> <span class="n">wcs</span><span class="p">[</span><span class="s">&#39;CRPIX2&#39;</span><span class="p">]</span>
        
   <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span>    

<span class="c"># ----------------------------------------------------------------------------------------</span>
</div>
<div class="viewcode-block" id="directborder"><a class="viewcode-back" href="../../../SamPy.astronomy.html#SamPy.astronomy.footprintfinder.directborder">[docs]</a><span class="k">def</span> <span class="nf">directborder</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">zerovalue</span><span class="p">,</span> <span class="n">extension</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

<span class="c"># ----------------------------------------------------------------------------------------</span>
   <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">      This function reads the data in slices (for low memory usage), cleans it an then</span>
<span class="sd">      identifies the borderpixels. Pyfits only allows this kind of access for non-scaled data!</span>
<span class="sd">      </span>
<span class="sd">      The crval, crpix amd cdmatrix are read from the file, too.</span>
<span class="sd">   &#39;&#39;&#39;</span>
   <span class="kn">import</span> <span class="nn">pyfits</span><span class="o">,</span> <span class="nn">pylab</span><span class="o">,</span> <span class="nn">numpy</span>
      
   <span class="k">print</span> <span class="n">whocalls</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;Reading fits file </span><span class="si">%s</span><span class="s"> ...&quot;</span> <span class="o">%</span> <span class="n">filename</span>

   <span class="k">try</span><span class="p">:</span>
      <span class="n">hdulist</span> <span class="o">=</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
   <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
      <span class="n">error</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">+</span><span class="n">whocalls</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;ERROR: the file could not be opened!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
      <span class="k">print</span> <span class="s">&quot;===================================================================================================&quot;</span>               
      <span class="kn">import</span> <span class="nn">sys</span>
      <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
   
   <span class="n">hdu</span> <span class="o">=</span> <span class="mi">0</span>
   <span class="k">if</span> <span class="n">extension</span><span class="o">==</span><span class="bp">None</span><span class="p">:</span>
      <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
         <span class="n">dshape</span> <span class="o">=</span> <span class="p">[]</span>
         <span class="k">try</span><span class="p">:</span>
            <span class="n">dshape</span> <span class="o">=</span> <span class="n">hdulist</span><span class="p">[</span><span class="n">hdu</span><span class="p">]</span><span class="o">.</span><span class="n">_dimShape</span><span class="p">()</span>
         <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="n">error</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">+</span><span class="n">whocalls</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;ERROR: Cannot read file. Is this really a fits file?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="k">print</span> <span class="s">&quot;===================================================================================================&quot;</span>               
            <span class="kn">import</span> <span class="nn">sys</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
      
         <span class="k">if</span> <span class="nb">list</span><span class="p">(</span><span class="n">dshape</span><span class="p">)</span> <span class="o">==</span> <span class="p">[]:</span>
            <span class="n">hdu</span> <span class="o">+=</span> <span class="mi">1</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="k">break</span>   
   <span class="k">else</span><span class="p">:</span>
      <span class="n">hdu</span> <span class="o">=</span> <span class="n">extension</span>
   <span class="n">n</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">hdulist</span><span class="p">[</span><span class="n">hdu</span><span class="p">]</span><span class="o">.</span><span class="n">_dimShape</span><span class="p">())</span>   
      
   <span class="k">print</span> <span class="n">whocalls</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;Found data with </span><span class="si">%s</span><span class="s"> in hdu </span><span class="si">%d</span><span class="s"> ...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="n">hdu</span><span class="p">)</span>
   
   <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
      <span class="k">print</span> <span class="n">whocalls</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;Fits header of this extension:&quot;</span>
      <span class="k">print</span> <span class="n">hdulist</span><span class="p">[</span><span class="n">hdu</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
   
   <span class="c"># reading the WCS information from the header</span>
   <span class="n">wcs</span> <span class="o">=</span> <span class="p">{}</span> 
   <span class="n">wcs</span><span class="p">[</span><span class="s">&#39;CRPIX1&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">hdulist</span><span class="p">[</span><span class="n">hdu</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s">&#39;CRPIX1&#39;</span><span class="p">]</span>
   <span class="n">wcs</span><span class="p">[</span><span class="s">&#39;CRPIX2&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">hdulist</span><span class="p">[</span><span class="n">hdu</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s">&#39;CRPIX2&#39;</span><span class="p">]</span>
   <span class="n">wcs</span><span class="p">[</span><span class="s">&#39;CRVAL1&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">hdulist</span><span class="p">[</span><span class="n">hdu</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s">&#39;CRVAL1&#39;</span><span class="p">]</span>
   <span class="n">wcs</span><span class="p">[</span><span class="s">&#39;CRVAL2&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">hdulist</span><span class="p">[</span><span class="n">hdu</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s">&#39;CRVAL2&#39;</span><span class="p">]</span>
   <span class="n">wcs</span><span class="p">[</span><span class="s">&#39;CD1_1&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">hdulist</span><span class="p">[</span><span class="n">hdu</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s">&#39;CD1_1&#39;</span><span class="p">]</span>
   <span class="n">wcs</span><span class="p">[</span><span class="s">&#39;CD1_2&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">hdulist</span><span class="p">[</span><span class="n">hdu</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s">&#39;CD1_2&#39;</span><span class="p">]</span>
   <span class="n">wcs</span><span class="p">[</span><span class="s">&#39;CD2_1&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">hdulist</span><span class="p">[</span><span class="n">hdu</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s">&#39;CD2_1&#39;</span><span class="p">]</span>
   <span class="n">wcs</span><span class="p">[</span><span class="s">&#39;CD2_2&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">hdulist</span><span class="p">[</span><span class="n">hdu</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s">&#39;CD2_2&#39;</span><span class="p">]</span>
   <span class="n">wcs</span><span class="p">[</span><span class="s">&#39;CTYPE1&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">hdulist</span><span class="p">[</span><span class="n">hdu</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s">&#39;CTYPE1&#39;</span><span class="p">]</span>
   <span class="n">wcs</span><span class="p">[</span><span class="s">&#39;CTYPE2&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">hdulist</span><span class="p">[</span><span class="n">hdu</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s">&#39;CTYPE2&#39;</span><span class="p">]</span>
   
   <span class="k">if</span> <span class="p">(</span><span class="n">wcs</span><span class="p">[</span><span class="s">&#39;CTYPE1&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;RA---TAN&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">wcs</span><span class="p">[</span><span class="s">&#39;CTYPE2&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;DEC--TAN&quot;</span><span class="p">):</span>
      <span class="n">wcs</span><span class="p">[</span><span class="s">&#39;wcs_is_possible&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
   <span class="k">else</span><span class="p">:</span>
      <span class="n">warning</span><span class="p">(</span><span class="n">whocalls</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;WARNING: WCS CTYPE1/CTYPE2 are not RA--TAN/DEC---TAN but </span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">.</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">wcs</span><span class="p">[</span><span class="s">&#39;CTYPE1&#39;</span><span class="p">],</span> <span class="n">wcs</span><span class="p">[</span><span class="s">&#39;CTYPE2&#39;</span><span class="p">]))</span>
      <span class="n">warning</span><span class="p">(</span><span class="n">whocalls</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;WARNING: Only the pixelpositions of the footprints will be available!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
      <span class="n">wcs</span><span class="p">[</span><span class="s">&#39;wcs_is_possible&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
    
   <span class="k">print</span> <span class="n">whocalls</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;Cleaning and finding borderpixels ...&quot;</span>
   <span class="k">print</span> <span class="n">whocalls</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span> <span class="p">,</span> 
   
   <span class="n">count</span>          <span class="o">=</span> <span class="mi">0</span>
   <span class="n">lastprogress</span>   <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
   <span class="n">borderpixels</span>   <span class="o">=</span> <span class="p">[]</span>
   <span class="n">data</span>           <span class="o">=</span> <span class="n">pylab</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">n</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="s">&#39;float32&#39;</span><span class="p">)</span>
   <span class="n">intdata</span>        <span class="o">=</span> <span class="n">pylab</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">n</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="s">&#39;Int8&#39;</span><span class="p">)</span>
   <span class="n">thisarray</span>      <span class="o">=</span> <span class="n">pylab</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&#39;Int8&#39;</span><span class="p">)</span>
   <span class="n">thatarray</span>      <span class="o">=</span> <span class="n">pylab</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&#39;Int8&#39;</span><span class="p">)</span>
   
   <span class="c"># now go row by row and find the broderpixels</span>
   <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
      <span class="n">data</span><span class="p">[:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">zerovalue</span>
      <span class="n">x1</span>        <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
      <span class="n">x2</span>        <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
      <span class="n">data</span><span class="p">[</span><span class="n">x1</span><span class="o">-</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span><span class="n">x2</span><span class="o">-</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">hdulist</span><span class="p">[</span><span class="n">hdu</span><span class="p">]</span><span class="o">.</span><span class="n">section</span><span class="p">[</span><span class="n">x1</span><span class="p">:</span><span class="n">x2</span><span class="p">,</span> <span class="p">:]</span>
      <span class="n">data</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data</span><span class="p">)]</span> <span class="o">=</span> <span class="n">zerovalue</span>
   
      <span class="c"># cleaning the lines</span>
      <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>   
         <span class="n">index</span> <span class="o">=</span> <span class="n">pylab</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="p">:]</span><span class="o">-</span><span class="n">zerovalue</span><span class="p">)</span><span class="o">&lt;</span><span class="n">epsilon</span><span class="p">)</span>
         <span class="n">intdata</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="p">:]</span>     <span class="o">=</span> <span class="mi">1</span>
         <span class="n">intdata</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
         <span class="n">index</span> <span class="o">=</span> <span class="bp">None</span>

      <span class="n">thisarray</span><span class="p">[:]</span>    <span class="o">=</span> <span class="mi">0</span>
      <span class="n">thisarray</span>      <span class="o">+=</span> <span class="n">intdata</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
      <span class="n">thisarray</span>      <span class="o">+=</span> <span class="n">intdata</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span>
      <span class="n">thisarray</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>  <span class="o">+=</span> <span class="n">intdata</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
      <span class="n">thisarray</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">intdata</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span>
      
      <span class="n">thisarray</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">intdata</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span>
      <span class="n">thisarray</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">intdata</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span>
      <span class="n">thisarray</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>  <span class="o">+=</span> <span class="n">intdata</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
      <span class="n">thisarray</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>  <span class="o">+=</span> <span class="n">intdata</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
      
      <span class="n">thisarray</span>      <span class="o">*=</span> <span class="n">intdata</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
       
      <span class="n">index</span> <span class="o">=</span> <span class="n">pylab</span><span class="o">.</span><span class="n">find</span><span class="p">(((</span><span class="n">thisarray</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">thisarray</span><span class="o">==</span><span class="mi">8</span><span class="p">))</span><span class="o">.</span><span class="n">__neg__</span><span class="p">())</span>

      <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">index</span><span class="p">)):</span>
         <span class="n">borderpixels</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">i</span><span class="p">,</span> <span class="n">index</span><span class="p">[</span><span class="n">j</span><span class="p">]])</span>
      
      <span class="n">index</span> <span class="o">=</span> <span class="bp">None</span>   
      <span class="n">count</span><span class="p">,</span> <span class="n">lastprogress</span> <span class="o">=</span> <span class="n">showprogress</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lastprogress</span><span class="p">)</span>

   <span class="k">print</span>   
   <span class="k">return</span> <span class="n">pylab</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">borderpixels</span><span class="p">),</span> <span class="n">n</span><span class="p">,</span> <span class="n">wcs</span>


<span class="c"># ----------------------------------------------------------------------------------------</span>
</div>
<div class="viewcode-block" id="getborderdictionary"><a class="viewcode-back" href="../../../SamPy.astronomy.html#SamPy.astronomy.footprintfinder.getborderdictionary">[docs]</a><span class="k">def</span> <span class="nf">getborderdictionary</span><span class="p">(</span><span class="n">borderpixels</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

<span class="c"># ----------------------------------------------------------------------------------------</span>
   <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">      Gets a dictionary of the borderpixels.</span>
<span class="sd">   &#39;&#39;&#39;</span>
   <span class="n">borderdictionary</span> <span class="o">=</span> <span class="p">{}</span>
   <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">borderpixels</span><span class="p">)):</span>
      <span class="n">borderdictionary</span><span class="p">[</span><span class="s">&quot;</span><span class="si">%d</span><span class="s">_</span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">borderpixels</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">borderpixels</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">])]</span> <span class="o">=</span> <span class="n">i</span>
      
   <span class="k">return</span> <span class="n">borderdictionary</span>


<span class="c"># ------------------------------------------------------------------------------------------------------------------------</span>
   </div>
<div class="viewcode-block" id="getcloseparticles"><a class="viewcode-back" href="../../../SamPy.astronomy.html#SamPy.astronomy.footprintfinder.getcloseparticles">[docs]</a><span class="k">def</span> <span class="nf">getcloseparticles</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">borderpixels</span><span class="p">,</span> <span class="n">borderdictionary</span><span class="p">):</span>

<span class="c"># ------------------------------------------------------------------------------------------------------------------------</span>
   <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">      returns a list of borderpixel ids that are close to the given pixel.</span>
<span class="sd">   &#39;&#39;&#39;</span>
   <span class="n">closeparticles</span> <span class="o">=</span> <span class="p">[]</span>
   <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">borderpixels</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">borderpixels</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="p">):</span>
     <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">borderpixels</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">borderpixels</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="p">):</span>
        <span class="c">#print &quot;closep:&quot;, i, borderpixels[i][0], borderpixels[i][1]</span>
        <span class="c">#print &quot;j, k   &quot; ,j, k, &quot;%d_%d&quot; % (j,k), borderdictionary.has_key(&quot;%d_%d&quot; % (j,k))</span>
        
        <span class="k">if</span> <span class="n">borderdictionary</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%d</span><span class="s">_</span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)):</span>
           <span class="n">closeparticles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">borderdictionary</span><span class="p">[</span><span class="s">&quot;</span><span class="si">%d</span><span class="s">_</span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)])</span>
   
   <span class="k">return</span> <span class="n">closeparticles</span>
   
   
<span class="c"># ------------------------------------------------------------------------------------------------------------------------</span>
   </div>
<div class="viewcode-block" id="getgroups"><a class="viewcode-back" href="../../../SamPy.astronomy.html#SamPy.astronomy.footprintfinder.getgroups">[docs]</a><span class="k">def</span> <span class="nf">getgroups</span><span class="p">(</span><span class="n">borderpixels</span><span class="p">,</span> <span class="n">borderdictionary</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

<span class="c"># ------------------------------------------------------------------------------------------------------------------------</span>
   <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">      This function finds groups of borderpixels using the bordertree. It is a classical groupfinder.</span>
<span class="sd">   &#39;&#39;&#39;</span>
   <span class="kn">import</span> <span class="nn">pylab</span><span class="o">,</span> <span class="nn">sys</span>
   
   <span class="n">nextid</span>     <span class="o">=</span> <span class="n">pylab</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">borderpixels</span><span class="p">)],</span> <span class="s">&#39;Int32&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span>
   <span class="n">groupid</span>    <span class="o">=</span> <span class="n">pylab</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">borderpixels</span><span class="p">)],</span> <span class="s">&#39;Int32&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span>
   <span class="n">groupcount</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>   

   <span class="k">print</span> <span class="n">whocalls</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;Group finding ...&quot;</span>
   <span class="k">print</span> <span class="n">whocalls</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span> <span class="p">,</span> 
   <span class="n">n</span>            <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">borderpixels</span><span class="p">)</span>   
   <span class="n">count</span>        <span class="o">=</span> <span class="mi">0</span>
   <span class="n">lastprogress</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
   <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>           
      <span class="n">count</span><span class="p">,</span> <span class="n">lastprogress</span> <span class="o">=</span> <span class="n">showprogress</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">lastprogress</span><span class="p">)</span>    
      <span class="k">if</span> <span class="n">groupid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
         <span class="c"># If it is not -1, we already have treated it</span>
         <span class="n">closeparticles</span> <span class="o">=</span> <span class="n">getcloseparticles</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">borderpixels</span><span class="p">,</span> <span class="n">borderdictionary</span><span class="p">)</span>   
         <span class="n">groups</span>         <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">groupid</span><span class="p">[</span><span class="n">closeparticles</span><span class="p">]))</span>

         <span class="k">if</span> <span class="n">groups</span> <span class="o">==</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="c"># a new group has to be created</span>
            <span class="n">groupcount</span> <span class="o">=</span> <span class="n">groupcount</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">groupid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">groupcount</span>
            <span class="n">nextid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>  <span class="o">=</span> <span class="n">i</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
               <span class="n">groups</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
               <span class="k">pass</span>
                  
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
               <span class="c"># an already existing group, but only one single group for all particles</span>
               <span class="n">thisgroup</span>   <span class="o">=</span> <span class="n">pylab</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">groupid</span><span class="p">[</span><span class="n">closeparticles</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
               <span class="n">savepointer</span> <span class="o">=</span> <span class="n">nextid</span><span class="p">[</span><span class="n">closeparticles</span><span class="p">[</span><span class="n">thisgroup</span><span class="p">]]</span>
               <span class="n">nextid</span><span class="p">[</span><span class="n">closeparticles</span><span class="p">[</span><span class="n">thisgroup</span><span class="p">]]</span> <span class="o">=</span> <span class="n">i</span>
               <span class="n">nextid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>   <span class="o">=</span> <span class="n">savepointer</span>      
               <span class="n">groupid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>  <span class="o">=</span> <span class="n">groups</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
               
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
               <span class="c"># Groups of close by particles (not uniquified nor -1 removed)              </span>
               <span class="n">thisgroups</span> <span class="o">=</span> <span class="n">groupid</span><span class="p">[</span><span class="n">closeparticles</span><span class="p">]</span>
               <span class="n">groupdict</span>  <span class="o">=</span> <span class="p">{}</span>
               <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">thisgroups</span><span class="p">)):</span>
                  <span class="k">if</span> <span class="n">thisgroups</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                     <span class="n">groupdict</span><span class="p">[</span><span class="n">thisgroups</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span> <span class="o">=</span> <span class="n">j</span>
               <span class="n">grouplist</span> <span class="o">=</span> <span class="p">[]</span>
               <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">groupdict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                  <span class="n">grouplist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                
               <span class="n">thisgroups</span>         <span class="o">=</span> <span class="n">thisgroups</span><span class="p">[</span><span class="n">grouplist</span><span class="p">]</span>
               <span class="n">thiscloseparticles</span> <span class="o">=</span> <span class="n">pylab</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">closeparticles</span><span class="p">)[</span><span class="n">grouplist</span><span class="p">]</span> 
               
               <span class="n">savepointer</span> <span class="o">=</span> <span class="n">nextid</span><span class="p">[</span><span class="n">thiscloseparticles</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
               <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">thiscloseparticles</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                  <span class="n">nextid</span><span class="p">[</span><span class="n">thiscloseparticles</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span> <span class="o">=</span> <span class="n">nextid</span><span class="p">[</span><span class="n">thiscloseparticles</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]]</span>
               <span class="n">nextid</span><span class="p">[</span><span class="n">thiscloseparticles</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">i</span>
               <span class="n">nextid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">savepointer</span>
                  
               <span class="n">newgroupid</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">thisgroups</span><span class="p">)</span>   
               <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">thisgroups</span><span class="p">:</span>   
                 <span class="n">groupid</span><span class="p">[</span><span class="n">pylab</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">groupid</span><span class="o">==</span><span class="n">g</span><span class="p">)]</span> <span class="o">=</span> <span class="n">newgroupid</span>                                 
               <span class="n">groupid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">newgroupid</span>  
        
   <span class="k">print</span> <span class="s">&quot;&quot;</span>
   <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
   
   <span class="c"># rename the groups to continuous indices               </span>
   <span class="n">newgroups</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pylab</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">groupid</span><span class="p">))))</span>      
   <span class="n">firstid</span>   <span class="o">=</span> <span class="p">[]</span>
   <span class="n">grouplen</span>  <span class="o">=</span> <span class="p">[]</span>
   <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">newgroups</span><span class="p">)):</span>      
      <span class="n">index</span> <span class="o">=</span> <span class="n">pylab</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">groupid</span><span class="o">==</span><span class="n">newgroups</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">j</span><span class="o">==</span><span class="n">newgroups</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
         <span class="n">groupid</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">j</span>
      <span class="n">firstid</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pylab</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">groupid</span><span class="o">==</span><span class="n">j</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
      <span class="n">grouplen</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
   
   <span class="k">return</span> <span class="n">pylab</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">newgroups</span><span class="p">)),</span> <span class="n">pylab</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">grouplen</span><span class="p">),</span> <span class="n">pylab</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">groupid</span><span class="p">),</span> <span class="n">pylab</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">firstid</span><span class="p">),</span> <span class="n">pylab</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nextid</span><span class="p">)</span>


<span class="c"># ------------------------------------------------------------------------------------------------------------------------</span>
   </div>
<div class="viewcode-block" id="getpixelorder"><a class="viewcode-back" href="../../../SamPy.astronomy.html#SamPy.astronomy.footprintfinder.getpixelorder">[docs]</a><span class="k">def</span> <span class="nf">getpixelorder</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">borderpixels</span><span class="p">,</span> <span class="n">borderdictionary</span><span class="p">,</span> <span class="n">groupid</span><span class="p">,</span> <span class="n">grouplen</span><span class="p">,</span> <span class="n">firstid</span><span class="p">,</span> <span class="n">nextid</span><span class="p">,</span> <span class="n">verbose</span><span class="p">):</span>

<span class="c"># ------------------------------------------------------------------------------------------------------------------------</span>
   <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">      This function finds the order of the pixels going round the chip. The array of borderpixelids is returned.</span>
<span class="sd">      The orientation is clockwise.</span>
<span class="sd">   &#39;&#39;&#39;</span>
   <span class="kn">import</span> <span class="nn">pylab</span><span class="o">,</span> <span class="nn">sys</span>
   <span class="k">print</span> <span class="n">whocalls</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;Ordering borderpixels ...&quot;</span>

   <span class="c"># pixelorder to check</span>
   <span class="c"># 5 6 7       (inverted coordinates:    1 0 7</span>
   <span class="c"># 4   0                                 2   6</span>
   <span class="c"># 3 2 1                                 3 4 5)</span>
   <span class="c">#</span>
   <span class="c">#             0     1      2      3       4      5      6     7</span>
   <span class="n">nextcheck</span>  <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>
   
   <span class="c"># repeat for nonwrap search</span>
   <span class="n">nextcheck</span> <span class="o">=</span> <span class="n">nextcheck</span> <span class="o">+</span> <span class="n">nextcheck</span>
  
   <span class="n">minpixnumber</span> <span class="o">=</span> <span class="mi">4</span>

   <span class="c"># get starting pixel, lower left corner</span>
   <span class="n">maxpix</span>     <span class="o">=</span> <span class="mi">100000</span>
   <span class="n">mindist</span>    <span class="o">=</span> <span class="mi">100000</span>
   <span class="n">pos</span>        <span class="o">=</span> <span class="n">firstid</span><span class="p">[</span><span class="n">chip</span><span class="p">]</span>

   <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">grouplen</span><span class="p">[</span><span class="n">chip</span><span class="p">]):</span>      
      <span class="k">if</span> <span class="p">(</span><span class="n">borderpixels</span><span class="p">[</span><span class="n">pos</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">borderpixels</span><span class="p">[</span><span class="n">pos</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">mindist</span><span class="p">):</span>
         <span class="n">maxpix</span> <span class="o">=</span> <span class="n">pos</span>
         <span class="n">mindist</span> <span class="o">=</span> <span class="n">borderpixels</span><span class="p">[</span><span class="n">pos</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">borderpixels</span><span class="p">[</span><span class="n">pos</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
      <span class="n">pos</span> <span class="o">=</span> <span class="n">nextid</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span>      
     
   <span class="c"># Get order starting from maxpix:</span>
   <span class="c"># get direction to the north east (i.e. it checks first south east and east which are both not possible because </span>
   <span class="c"># of the choice of the starting point).</span>
   <span class="c"># Vector is the last direction: it points from the centre to the corner (e.g. vector=6 points north)</span>
   <span class="n">pos</span>    <span class="o">=</span> <span class="n">maxpix</span>   
   <span class="n">vector</span> <span class="o">=</span> <span class="mi">5</span>
   
   <span class="n">closeparticles</span> <span class="o">=</span> <span class="n">getcloseparticles</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">borderpixels</span><span class="p">,</span> <span class="n">borderdictionary</span><span class="p">)</span>  
   <span class="n">order</span>  <span class="o">=</span> <span class="p">[</span><span class="n">pos</span><span class="p">]</span>
   <span class="k">while</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">order</span><span class="p">)</span><span class="o">&lt;</span><span class="n">minpixnumber</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">pos</span> <span class="o">!=</span><span class="n">maxpix</span><span class="p">):</span>
      <span class="c"># see what the next borderpixel is that is in clockwise direction</span>
      <span class="c"># the first pixel can&#39;t be a border pixel, otherwise it would have been </span>
      <span class="c"># taken already in the last step.</span>
      <span class="n">vector</span> <span class="o">=</span> <span class="n">vector</span> <span class="o">-</span> <span class="mi">2</span>

      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">borderdictionary</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">borderpixels</span><span class="p">[</span><span class="n">pos</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">nextcheck</span><span class="p">[</span><span class="n">vector</span><span class="o">+</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="s">&quot;_&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">borderpixels</span><span class="p">[</span><span class="n">pos</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">nextcheck</span><span class="p">[</span><span class="n">vector</span><span class="o">+</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]))):</span>
            <span class="k">break</span>

      <span class="n">iisoneandborder</span> <span class="o">=</span> <span class="bp">False</span>                 
      <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
         <span class="c"># Check if this is a convex corner</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">borderdictionary</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">borderpixels</span><span class="p">[</span><span class="n">pos</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">nextcheck</span><span class="p">[</span><span class="n">vector</span><span class="o">+</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="s">&quot;_&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">borderpixels</span><span class="p">[</span><span class="n">pos</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">nextcheck</span><span class="p">[</span><span class="n">vector</span><span class="o">+</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]))):</span>
            <span class="c"># If so, add the corner point to the list, too. This is to make sure that the algorithm really gets the exact convex</span>
            <span class="c"># corners. </span>
            <span class="n">iisoneandborder</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">p</span>               <span class="o">=</span> <span class="n">borderdictionary</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">borderpixels</span><span class="p">[</span><span class="n">pos</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">nextcheck</span><span class="p">[</span><span class="n">vector</span><span class="o">+</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="s">&quot;_&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">borderpixels</span><span class="p">[</span><span class="n">pos</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">nextcheck</span><span class="p">[</span><span class="n">vector</span><span class="o">+</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])]</span>
            <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

      <span class="n">pos</span>  <span class="o">=</span> <span class="n">borderdictionary</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">borderpixels</span><span class="p">[</span><span class="n">pos</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">nextcheck</span><span class="p">[</span><span class="n">vector</span><span class="o">+</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="s">&quot;_&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">borderpixels</span><span class="p">[</span><span class="n">pos</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">nextcheck</span><span class="p">[</span><span class="n">vector</span><span class="o">+</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">])]</span>      
      <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
      
      <span class="c"># Get the next direction, which was the original direction plus where the next border pixel has been found</span>
      <span class="k">if</span> <span class="n">iisoneandborder</span><span class="p">:</span>
         <span class="c"># If we just have added a convex corner point, use that (i.e -1 corresponds to +7) as the new direction</span>
         <span class="n">vector</span> <span class="o">=</span> <span class="p">(</span><span class="n">vector</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">%</span> <span class="mi">8</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="n">vector</span> <span class="o">=</span> <span class="p">(</span><span class="n">vector</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">%</span> <span class="mi">8</span>
      
   <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
   <span class="k">return</span> <span class="n">order</span>  


<span class="c"># ------------------------------------------------------------------------------------------------------------------------</span>
</div>
<div class="viewcode-block" id="simplifyDP"><a class="viewcode-back" href="../../../SamPy.astronomy.html#SamPy.astronomy.footprintfinder.simplifyDP">[docs]</a><span class="k">def</span> <span class="nf">simplifyDP</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">borderpixels</span><span class="p">,</span> <span class="n">tolerance</span><span class="p">):</span>

<span class="c"># ------------------------------------------------------------------------------------------------------------------------</span>

   <span class="kn">import</span> <span class="nn">pylab</span>
   <span class="n">iscorner</span> <span class="o">=</span> <span class="n">pylab</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">order</span><span class="p">))</span>
   <span class="n">iscorner</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
   <span class="n">simplify</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">borderpixels</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">order</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">tolerance</span><span class="p">,</span> <span class="n">iscorner</span><span class="p">)</span>
   <span class="n">iscorner</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
   <span class="k">return</span> <span class="n">pylab</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">order</span><span class="p">)[</span><span class="n">pylab</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">iscorner</span><span class="o">==</span><span class="mi">1</span><span class="p">)]</span>


<span class="c"># ------------------------------------------------------------------------------------------------------------------------</span>
</div>
<div class="viewcode-block" id="simplify"><a class="viewcode-back" href="../../../SamPy.astronomy.html#SamPy.astronomy.footprintfinder.simplify">[docs]</a><span class="k">def</span> <span class="nf">simplify</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">borderpixels</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">tolerance</span><span class="p">,</span> <span class="n">iscorner</span><span class="p">):</span>

<span class="c"># ------------------------------------------------------------------------------------------------------------------------</span>

   <span class="k">if</span> <span class="n">a</span><span class="o">&gt;</span><span class="n">b</span><span class="p">:</span>
      <span class="k">return</span>

   <span class="n">maxd2</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
   <span class="n">maxi</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> 
   <span class="n">tolerance2</span> <span class="o">=</span> <span class="n">tolerance</span> <span class="o">*</span> <span class="n">tolerance</span>
   
   <span class="n">lenab2</span> <span class="o">=</span> <span class="p">(</span><span class="n">borderpixels</span><span class="p">[</span><span class="n">order</span><span class="p">[</span><span class="n">b</span><span class="p">],</span> <span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">borderpixels</span><span class="p">[</span><span class="n">order</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">borderpixels</span><span class="p">[</span><span class="n">order</span><span class="p">[</span><span class="n">b</span><span class="p">],</span> <span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">borderpixels</span><span class="p">[</span><span class="n">order</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span> <span class="o">+</span> \
                 <span class="p">(</span><span class="n">borderpixels</span><span class="p">[</span><span class="n">order</span><span class="p">[</span><span class="n">b</span><span class="p">],</span> <span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">borderpixels</span><span class="p">[</span><span class="n">order</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">borderpixels</span><span class="p">[</span><span class="n">order</span><span class="p">[</span><span class="n">b</span><span class="p">],</span> <span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">borderpixels</span><span class="p">[</span><span class="n">order</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="mi">1</span><span class="p">])</span>
               
   <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
      <span class="n">lenionab2</span> <span class="o">=</span> <span class="p">((</span><span class="n">borderpixels</span><span class="p">[</span><span class="n">order</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">borderpixels</span><span class="p">[</span><span class="n">order</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">borderpixels</span><span class="p">[</span><span class="n">order</span><span class="p">[</span><span class="n">b</span><span class="p">],</span> <span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">borderpixels</span><span class="p">[</span><span class="n">order</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="mi">0</span><span class="p">]))</span> <span class="o">+</span> \
                         <span class="p">((</span><span class="n">borderpixels</span><span class="p">[</span><span class="n">order</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">borderpixels</span><span class="p">[</span><span class="n">order</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">borderpixels</span><span class="p">[</span><span class="n">order</span><span class="p">[</span><span class="n">b</span><span class="p">],</span> <span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">borderpixels</span><span class="p">[</span><span class="n">order</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="mi">1</span><span class="p">]))</span> 
      
      <span class="k">if</span> <span class="n">lenionab2</span><span class="o">&lt;=</span><span class="mi">0</span><span class="p">:</span>
          <span class="n">d2</span> <span class="o">=</span> <span class="p">(</span><span class="n">borderpixels</span><span class="p">[</span><span class="n">order</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">borderpixels</span><span class="p">[</span><span class="n">order</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">borderpixels</span><span class="p">[</span><span class="n">order</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">borderpixels</span><span class="p">[</span><span class="n">order</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span> <span class="o">+</span> \
                  <span class="p">(</span><span class="n">borderpixels</span><span class="p">[</span><span class="n">order</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">borderpixels</span><span class="p">[</span><span class="n">order</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">borderpixels</span><span class="p">[</span><span class="n">order</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">borderpixels</span><span class="p">[</span><span class="n">order</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="mi">1</span><span class="p">])</span>
      <span class="k">elif</span> <span class="n">lenionab2</span><span class="o">&gt;</span><span class="n">lenab2</span><span class="p">:</span>
          <span class="n">d2</span> <span class="o">=</span> <span class="p">(</span><span class="n">borderpixels</span><span class="p">[</span><span class="n">order</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">borderpixels</span><span class="p">[</span><span class="n">order</span><span class="p">[</span><span class="n">b</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">borderpixels</span><span class="p">[</span><span class="n">order</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">borderpixels</span><span class="p">[</span><span class="n">order</span><span class="p">[</span><span class="n">b</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span> <span class="o">+</span> \
                  <span class="p">(</span><span class="n">borderpixels</span><span class="p">[</span><span class="n">order</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">borderpixels</span><span class="p">[</span><span class="n">order</span><span class="p">[</span><span class="n">b</span><span class="p">],</span> <span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">borderpixels</span><span class="p">[</span><span class="n">order</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">borderpixels</span><span class="p">[</span><span class="n">order</span><span class="p">[</span><span class="n">b</span><span class="p">],</span> <span class="mi">1</span><span class="p">])</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="n">factor</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">lenionab2</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">lenab2</span><span class="p">)</span>
         <span class="n">d2</span> <span class="o">=</span>   <span class="p">(</span><span class="n">borderpixels</span><span class="p">[</span><span class="n">order</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="p">(</span><span class="n">borderpixels</span><span class="p">[</span><span class="n">order</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">factor</span> <span class="o">*</span> <span class="p">(</span><span class="n">borderpixels</span><span class="p">[</span><span class="n">order</span><span class="p">[</span><span class="n">b</span><span class="p">],</span> <span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">borderpixels</span><span class="p">[</span><span class="n">order</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="mi">0</span><span class="p">])))</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> \
                   <span class="p">(</span><span class="n">borderpixels</span><span class="p">[</span><span class="n">order</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="p">(</span><span class="n">borderpixels</span><span class="p">[</span><span class="n">order</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">factor</span> <span class="o">*</span> <span class="p">(</span><span class="n">borderpixels</span><span class="p">[</span><span class="n">order</span><span class="p">[</span><span class="n">b</span><span class="p">],</span> <span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">borderpixels</span><span class="p">[</span><span class="n">order</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="mi">1</span><span class="p">])))</span><span class="o">**</span><span class="mi">2</span>
      
      <span class="k">if</span> <span class="p">(</span><span class="n">d2</span><span class="o">&gt;</span><span class="n">maxd2</span><span class="p">):</span>
         <span class="n">maxd2</span> <span class="o">=</span> <span class="n">d2</span>
         <span class="n">maxi</span>    <span class="o">=</span> <span class="n">i</span>
         
   <span class="k">if</span> <span class="n">maxd2</span><span class="o">&lt;</span><span class="n">tolerance2</span><span class="p">:</span>
      <span class="k">return</span>
   <span class="k">else</span><span class="p">:</span>
      <span class="n">iscorner</span><span class="p">[</span><span class="n">maxi</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
      <span class="n">simplify</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">borderpixels</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">maxi</span><span class="p">,</span> <span class="n">tolerance</span><span class="p">,</span> <span class="n">iscorner</span><span class="p">)</span>
      <span class="n">simplify</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">borderpixels</span><span class="p">,</span> <span class="n">maxi</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">tolerance</span><span class="p">,</span> <span class="n">iscorner</span><span class="p">)</span>
      
      
<span class="c"># ------------------------------------------------------------------------------------------------------------------------</span>
</div>
<div class="viewcode-block" id="pointinpolygon"><a class="viewcode-back" href="../../../SamPy.astronomy.html#SamPy.astronomy.footprintfinder.pointinpolygon">[docs]</a><span class="k">def</span> <span class="nf">pointinpolygon</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">footprint</span><span class="p">,</span> <span class="n">borderpixels</span><span class="p">):</span>      

<span class="c"># ------------------------------------------------------------------------------------------------------------------------   </span>
   <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">      This function checks weather the point x,y is contained in the polygon given by footprint.</span>
<span class="sd">      It is assumed that the first point and the last point are identical!</span>
<span class="sd">   &#39;&#39;&#39;</span>
   <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">footprint</span><span class="p">)</span>
   <span class="n">inside</span> <span class="o">=</span> <span class="bp">False</span>

   <span class="n">p1</span> <span class="o">=</span> <span class="n">borderpixels</span><span class="p">[</span><span class="n">footprint</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
   <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
       <span class="n">p2</span> <span class="o">=</span> <span class="n">borderpixels</span><span class="p">[</span><span class="n">footprint</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
       <span class="k">if</span> <span class="n">y</span> <span class="o">&gt;</span> <span class="nb">min</span><span class="p">(</span><span class="n">p1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">p2</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
           <span class="k">if</span> <span class="n">y</span> <span class="o">&lt;=</span> <span class="nb">max</span><span class="p">(</span><span class="n">p1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">p2</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
               <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="nb">max</span><span class="p">(</span><span class="n">p1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p2</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                   <span class="k">if</span> <span class="n">p1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">p2</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                       <span class="n">xint</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="n">p1</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">p2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">p1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">p2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">p1</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="n">p1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                   <span class="k">if</span> <span class="p">(</span><span class="n">p1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">p2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">or</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;=</span> <span class="n">xint</span><span class="p">):</span>
                       <span class="n">inside</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">inside</span>
       <span class="n">p1</span> <span class="o">=</span> <span class="n">p2</span>

   <span class="k">return</span> <span class="n">inside</span>
   
   
<span class="c"># ------------------------------------------------------------------------------------------------------------------------</span>
</div>
<div class="viewcode-block" id="getheirarchy"><a class="viewcode-back" href="../../../SamPy.astronomy.html#SamPy.astronomy.footprintfinder.getheirarchy">[docs]</a><span class="k">def</span> <span class="nf">getheirarchy</span><span class="p">(</span><span class="n">footprintlist</span><span class="p">,</span> <span class="n">borderpixels</span><span class="p">):</span>

<span class="c"># ------------------------------------------------------------------------------------------------------------------------</span>
   <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">      This function checks whether one footprint is contained in an other one.</span>
<span class="sd">   &#39;&#39;&#39;</span>
   <span class="kn">import</span> <span class="nn">pylab</span>
   <span class="n">insidelist</span> <span class="o">=</span> <span class="p">[]</span>
   <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">footprintlist</span><span class="p">)):</span>
      <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">footprintlist</span><span class="p">)):</span>
         <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">j</span><span class="p">:</span>
            <span class="n">inside</span> <span class="o">=</span> <span class="n">pointinpolygon</span><span class="p">(</span><span class="n">borderpixels</span><span class="p">[</span><span class="n">footprintlist</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">],</span> <span class="n">borderpixels</span><span class="p">[</span><span class="n">footprintlist</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">],</span> \
                                      <span class="n">footprintlist</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">borderpixels</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">inside</span><span class="p">:</span>                  
               <span class="c"># pylygon i is inside polygon j      </span>
               <span class="n">insidelist</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span>
   
   <span class="n">heirarchy</span>  <span class="o">=</span> <span class="p">[</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">footprintlist</span><span class="p">)),</span> <span class="nb">len</span><span class="p">(</span><span class="n">footprintlist</span><span class="p">)</span><span class="o">*</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="mi">0</span><span class="p">)],</span> <span class="nb">len</span><span class="p">(</span><span class="n">footprintlist</span><span class="p">)</span><span class="o">*</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="mi">0</span><span class="p">)]]</span>

   <span class="c"># count the number of occurrences of this footprint in others</span>
   <span class="n">occurrence</span> <span class="o">=</span> <span class="n">pylab</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">footprintlist</span><span class="p">))</span>
   <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">insidelist</span><span class="p">)):</span>
      <span class="n">occurrence</span><span class="p">[</span><span class="n">insidelist</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+=</span> <span class="mi">1</span>
      
   <span class="c"># if a given element occurs exactly one time more than an other</span>
   <span class="c"># and that other is a parent of this one, than that other is the</span>
   <span class="c"># direct parent of the current element. All other inside relations are ignored.   </span>
   <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">insidelist</span><span class="p">)):</span>
      <span class="k">if</span> <span class="n">occurrence</span><span class="p">[</span><span class="n">insidelist</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">occurrence</span><span class="p">[</span><span class="n">insidelist</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]]:</span>
         <span class="n">heirarchy</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">insidelist</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">insidelist</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
         <span class="n">heirarchy</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">insidelist</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">occurrence</span><span class="p">[</span><span class="n">insidelist</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span>
         <span class="n">heirarchy</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">insidelist</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>
   <span class="k">return</span> <span class="n">heirarchy</span>


<span class="c"># ------------------------------------------------------------------------------------------------------------------------</span>
</div>
<div class="viewcode-block" id="getcentroid"><a class="viewcode-back" href="../../../SamPy.astronomy.html#SamPy.astronomy.footprintfinder.getcentroid">[docs]</a><span class="k">def</span> <span class="nf">getcentroid</span><span class="p">(</span><span class="n">simplefootprintlist</span><span class="p">,</span> <span class="n">borderpixels</span><span class="p">,</span> <span class="n">heirarchy</span><span class="p">,</span> <span class="n">verbose</span><span class="p">):</span>

<span class="c"># ------------------------------------------------------------------------------------------------------------------------</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      computes the centroid (=barycenter) and area for each polygon as well as the barycenter for the entire set.</span>
<span class="sd">      Holes have negative areas, computations are done in pixel space. It is assumed that the scalefactor is 1, i.e.</span>
<span class="sd">      that pixels are square.</span>
<span class="sd">   &quot;&quot;&quot;</span>
   <span class="n">centroid</span> <span class="o">=</span> <span class="p">{}</span>
   <span class="n">totalarea</span>    <span class="o">=</span> <span class="mf">0.0</span>
   <span class="n">totalcx</span>      <span class="o">=</span> <span class="mf">0.0</span>
   <span class="n">totalcy</span>      <span class="o">=</span> <span class="mf">0.0</span>
   
   <span class="k">for</span> <span class="n">fp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">simplefootprintlist</span><span class="p">)):</span>   
      <span class="n">area</span>   <span class="o">=</span> <span class="mf">0.0</span>
      <span class="n">cx</span>     <span class="o">=</span> <span class="mf">0.0</span>
      <span class="n">cy</span>     <span class="o">=</span> <span class="mf">0.0</span>
      <span class="n">cxzero</span> <span class="o">=</span> <span class="mf">0.0</span>
      <span class="n">cyzero</span> <span class="o">=</span> <span class="mf">0.0</span>
      <span class="c"># The last point is indeed a copy of the first point.</span>
      <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">simplefootprintlist</span><span class="p">[</span><span class="n">fp</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span>
      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
         <span class="n">j</span>  <span class="o">=</span> <span class="n">i</span>
         <span class="n">j1</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
         <span class="c"># If the footprint is a chip or an island, we have to reverse the order to get</span>
         <span class="c"># the points ordered mathematically positively. This will then also give the </span>
         <span class="c"># correct sign for the area computation</span>
         <span class="k">if</span> <span class="n">heirarchy</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">fp</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">j</span>  <span class="o">=</span> <span class="n">n</span> <span class="o">-</span> <span class="n">i</span>         
            <span class="n">j1</span> <span class="o">=</span> <span class="n">j</span> <span class="o">-</span> <span class="mi">1</span>
         
         <span class="c"># Note that the x,y pixel definition in fits files runs from 1..n (actually, the</span>
         <span class="c"># only really reasonable choice!) and not from 0..n-1 as it is in python.   </span>
         <span class="n">x</span>  <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">borderpixels</span><span class="p">[</span><span class="n">simplefootprintlist</span><span class="p">[</span><span class="n">fp</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="mi">1</span><span class="p">]</span>  <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
         <span class="n">y</span>  <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">borderpixels</span><span class="p">[</span><span class="n">simplefootprintlist</span><span class="p">[</span><span class="n">fp</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="mi">0</span><span class="p">]</span>  <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
         <span class="n">x1</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">borderpixels</span><span class="p">[</span><span class="n">simplefootprintlist</span><span class="p">[</span><span class="n">fp</span><span class="p">][</span><span class="n">j1</span><span class="p">],</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
         <span class="n">y1</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">borderpixels</span><span class="p">[</span><span class="n">simplefootprintlist</span><span class="p">[</span><span class="n">fp</span><span class="p">][</span><span class="n">j1</span><span class="p">],</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                  
         <span class="n">area</span>   <span class="o">=</span> <span class="n">area</span>   <span class="o">+</span>            <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">y1</span> <span class="o">-</span> <span class="n">x1</span> <span class="o">*</span> <span class="n">y</span><span class="p">)</span>
         <span class="n">cx</span>     <span class="o">=</span> <span class="n">cx</span>     <span class="o">+</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">x1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">y1</span> <span class="o">-</span> <span class="n">x1</span> <span class="o">*</span> <span class="n">y</span><span class="p">)</span>
         <span class="n">cy</span>     <span class="o">=</span> <span class="n">cy</span>     <span class="o">+</span> <span class="p">(</span><span class="n">y</span> <span class="o">+</span> <span class="n">y1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">y1</span> <span class="o">-</span> <span class="n">x1</span> <span class="o">*</span> <span class="n">y</span><span class="p">)</span>
         <span class="n">cxzero</span> <span class="o">=</span> <span class="n">cxzero</span> <span class="o">+</span> <span class="n">x</span>
         <span class="n">cyzero</span> <span class="o">=</span> <span class="n">cyzero</span> <span class="o">+</span> <span class="n">y</span>
      
      <span class="c"># Prevent crashes for footprints with exactly zero area. area is set to a tiny value</span>
      <span class="c"># for the unlikely case that _no_ footprint has a non-zero area.</span>
      <span class="k">if</span> <span class="n">area</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
         <span class="n">area</span> <span class="o">=</span> <span class="n">area</span> <span class="o">*</span> <span class="mf">0.5</span>      
         <span class="n">cx</span>   <span class="o">=</span> <span class="n">cx</span> <span class="o">/</span><span class="p">(</span><span class="mf">6.0</span><span class="o">*</span><span class="n">area</span><span class="p">)</span>    
         <span class="n">cy</span>   <span class="o">=</span> <span class="n">cy</span> <span class="o">/</span><span class="p">(</span><span class="mf">6.0</span><span class="o">*</span><span class="n">area</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="n">area</span> <span class="o">=</span> <span class="mf">1e-10</span>
         <span class="n">cx</span>   <span class="o">=</span> <span class="n">cxzero</span> <span class="o">/</span> <span class="n">n</span>
         <span class="n">cy</span>   <span class="o">=</span> <span class="n">cyzero</span> <span class="o">/</span> <span class="n">n</span>
                  
      <span class="n">totalarea</span> <span class="o">=</span> <span class="n">totalarea</span> <span class="o">+</span> <span class="n">area</span>
      <span class="n">totalcx</span>   <span class="o">=</span> <span class="n">totalcx</span>   <span class="o">+</span> <span class="n">cx</span> <span class="o">*</span> <span class="n">area</span>
      <span class="n">totalcy</span>   <span class="o">=</span> <span class="n">totalcy</span>   <span class="o">+</span> <span class="n">cy</span> <span class="o">*</span> <span class="n">area</span>
      
      <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
         <span class="k">print</span> <span class="n">whocalls</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;Footprint </span><span class="si">%d</span><span class="s">: area=</span><span class="si">%f</span><span class="s">, </span><span class="si">%f</span><span class="s">, </span><span class="si">%f</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">area</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">)</span>
      <span class="n">centroid</span><span class="p">[</span><span class="n">fp</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">area</span><span class="p">,</span><span class="n">cx</span><span class="p">,</span><span class="n">cy</span><span class="p">]</span>   
   
   <span class="n">totalcx</span> <span class="o">=</span> <span class="n">totalcx</span> <span class="o">/</span> <span class="n">totalarea</span>
   <span class="n">totalcy</span> <span class="o">=</span> <span class="n">totalcy</span> <span class="o">/</span> <span class="n">totalarea</span>
            
   <span class="n">centroid</span><span class="p">[</span><span class="s">&#39;total&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">totalarea</span><span class="p">,</span> <span class="n">totalcx</span><span class="p">,</span> <span class="n">totalcy</span><span class="p">]</span>
   
   <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
      <span class="k">print</span> <span class="n">whocalls</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;Total: area=</span><span class="si">%f</span><span class="s">, </span><span class="si">%f</span><span class="s">, </span><span class="si">%f</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">area</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">)</span>
   
   <span class="k">return</span> <span class="n">centroid</span>

<span class="c"># ------------------------------------------------------------------------------------------------------------------------</span>
         </div>
<div class="viewcode-block" id="writeoutput"><a class="viewcode-back" href="../../../SamPy.astronomy.html#SamPy.astronomy.footprintfinder.writeoutput">[docs]</a><span class="k">def</span> <span class="nf">writeoutput</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">simplefootprintlist</span><span class="p">,</span> <span class="n">borderpixels</span><span class="p">,</span> <span class="n">heirarchy</span><span class="p">,</span> <span class="n">wcs</span><span class="p">,</span> <span class="n">centroid</span><span class="p">,</span> <span class="n">arguments</span><span class="p">,</span> <span class="n">writepoints</span><span class="p">,</span> <span class="n">verbose</span><span class="p">):</span>
   
<span class="c"># ------------------------------------------------------------------------------------------------------------------------</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      write the footprints to the output file. This file contains all information (including heirarchy) and is </span>
<span class="sd">      always produced.</span>
<span class="sd">   &quot;&quot;&quot;</span>
   <span class="kn">import</span> <span class="nn">pylab</span>
   <span class="kn">import</span> <span class="nn">os</span>
   <span class="n">outputfilename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">filename</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;.fits&quot;</span><span class="p">)])</span><span class="o">+</span><span class="s">&quot;_footprint.txt&quot;</span>
   <span class="n">outputfile</span>     <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">outputfilename</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span>
   <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">outputfile</span><span class="p">,</span> <span class="s">&#39;# Footprint Finder&#39;</span>
   <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">outputfile</span><span class="p">,</span> <span class="s">&#39;# ================&#39;</span>
   <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">outputfile</span><span class="p">,</span> <span class="s">&#39;#&#39;</span>
   <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">outputfile</span><span class="p">,</span> <span class="s">&#39;# footprint-file for &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
   <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">outputfile</span><span class="p">,</span> <span class="s">&#39;# &#39;</span>
   <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">outputfile</span><span class="p">,</span> <span class="s">&#39;# Arguments: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">arguments</span> 
   <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">outputfile</span><span class="p">,</span> <span class="s">&#39;# &#39;</span>
   <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">outputfile</span><span class="p">,</span> <span class="s">&#39;# Number of chips found, global area [pixel^2], global x_barycenter, global y_barycenter, global ra_barycenter, global dec_barycenter&#39;</span>
   <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">outputfile</span><span class="p">,</span> <span class="s">&#39;# Chipnumber, number of footprint points, parent chip, is chip/island=0 or hole=1, has interior chip/island/hole=1 or not=0, area [pixel^2], y_barycenter, ra_barycenter, dec_barycenter&#39;</span>
   <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">outputfile</span><span class="p">,</span> <span class="s">&#39;#    x, y, ra, dec&#39;</span>
   
   <span class="n">centroid_ra</span>  <span class="o">=</span> <span class="n">pylab</span><span class="o">.</span><span class="n">nan</span>
   <span class="n">centroid_dec</span> <span class="o">=</span> <span class="n">pylab</span><span class="o">.</span><span class="n">nan</span>
   <span class="k">if</span> <span class="n">wcs</span><span class="p">[</span><span class="s">&#39;wcs_is_possible&#39;</span><span class="p">]:</span>
      <span class="n">centroid_ra</span><span class="p">,</span> <span class="n">centroid_dec</span>  <span class="o">=</span> <span class="n">xy2rd</span><span class="p">(</span><span class="n">wcs</span><span class="p">,</span> <span class="n">centroid</span><span class="p">[</span><span class="s">&#39;total&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">centroid</span><span class="p">[</span><span class="s">&#39;total&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>
   <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">outputfile</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">simplefootprintlist</span><span class="p">),</span> <span class="n">centroid</span><span class="p">[</span><span class="s">&#39;total&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">centroid</span><span class="p">[</span><span class="s">&#39;total&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">centroid</span><span class="p">[</span><span class="s">&#39;total&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="n">centroid_ra</span><span class="p">,</span> <span class="n">centroid_dec</span>
   <span class="k">for</span> <span class="n">fp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">simplefootprintlist</span><span class="p">)):</span>   
      
      <span class="n">centroid_ra</span>  <span class="o">=</span> <span class="n">pylab</span><span class="o">.</span><span class="n">nan</span>
      <span class="n">centroid_dec</span> <span class="o">=</span> <span class="n">pylab</span><span class="o">.</span><span class="n">nan</span>
      <span class="k">if</span> <span class="n">wcs</span><span class="p">[</span><span class="s">&#39;wcs_is_possible&#39;</span><span class="p">]:</span>
         <span class="n">centroid_ra</span><span class="p">,</span> <span class="n">centroid_dec</span>  <span class="o">=</span> <span class="n">xy2rd</span><span class="p">(</span><span class="n">wcs</span><span class="p">,</span> <span class="n">centroid</span><span class="p">[</span><span class="n">fp</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">centroid</span><span class="p">[</span><span class="n">fp</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>
      
      <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">outputfile</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">simplefootprintlist</span><span class="p">[</span><span class="n">fp</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">heirarchy</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">fp</span><span class="p">],</span> <span class="n">heirarchy</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">fp</span><span class="p">],</span> <span class="n">heirarchy</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">fp</span><span class="p">],</span> <span class="n">centroid</span><span class="p">[</span><span class="n">fp</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">centroid</span><span class="p">[</span><span class="n">fp</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">centroid</span><span class="p">[</span><span class="n">fp</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="n">centroid_ra</span><span class="p">,</span> <span class="n">centroid_dec</span> 

      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">simplefootprintlist</span><span class="p">[</span><span class="n">fp</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
         <span class="n">j</span> <span class="o">=</span> <span class="n">i</span>
         <span class="k">if</span> <span class="n">heirarchy</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">fp</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">j</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">simplefootprintlist</span><span class="p">[</span><span class="n">fp</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">i</span>
         
         <span class="c"># Note that the x,y pixel definition in fits files runs from 1..n (actually, the</span>
         <span class="c"># only really reasonable choice!) and not from 0..n-1 as it is in python.   </span>
         <span class="n">x</span> <span class="o">=</span> <span class="n">borderpixels</span><span class="p">[</span><span class="n">simplefootprintlist</span><span class="p">[</span><span class="n">fp</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
         <span class="n">y</span> <span class="o">=</span> <span class="n">borderpixels</span><span class="p">[</span><span class="n">simplefootprintlist</span><span class="p">[</span><span class="n">fp</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
         <span class="k">if</span> <span class="n">wcs</span><span class="p">[</span><span class="s">&#39;wcs_is_possible&#39;</span><span class="p">]:</span>
            <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span> <span class="o">=</span> <span class="n">xy2rd</span><span class="p">(</span><span class="n">wcs</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span> <span class="o">=</span> <span class="p">(</span><span class="n">pylab</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">pylab</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
         <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">outputfile</span><span class="p">,</span> <span class="s">&quot;   </span><span class="si">%5d</span><span class="s"> </span><span class="si">%5d</span><span class="s"> </span><span class="si">%11f</span><span class="s"> </span><span class="si">%11f</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">)</span>
         <span class="k">if</span> <span class="n">writepoints</span><span class="p">:</span> 
            <span class="k">print</span> <span class="s">&quot;writepoints = </span><span class="si">%5d</span><span class="s"> </span><span class="si">%5d</span><span class="s">    </span><span class="si">%f</span><span class="s"> </span><span class="si">%f</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">)</span>
         
   <span class="n">outputfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
   <span class="k">print</span> <span class="n">whocalls</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;Written to </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">outputfilename</span>


<span class="c"># ------------------------------------------------------------------------------------------------------------------------</span>
         </div>
<div class="viewcode-block" id="writeds9output"><a class="viewcode-back" href="../../../SamPy.astronomy.html#SamPy.astronomy.footprintfinder.writeds9output">[docs]</a><span class="k">def</span> <span class="nf">writeds9output</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">simplefootprintlist</span><span class="p">,</span> <span class="n">borderpixels</span><span class="p">,</span> <span class="n">heirarchy</span><span class="p">,</span> <span class="n">wcs</span><span class="p">,</span> <span class="n">centroid</span><span class="p">,</span> <span class="n">colorlist</span><span class="p">,</span> <span class="n">verbose</span><span class="p">):</span>
   
<span class="c"># ------------------------------------------------------------------------------------------------------------------------</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      writing ds9 region file(s). One file with the image coordinates, and if possible (i.e. of the projection</span>
<span class="sd">      is RA-TAN/DEC-TAN) also a ds9 WCS file.</span>
<span class="sd">   &quot;&quot;&quot;</span>
   <span class="kn">import</span> <span class="nn">os</span>
   
   <span class="n">linear</span>     <span class="o">=</span> <span class="bp">False</span>
   <span class="k">if</span> <span class="n">wcs</span><span class="p">[</span><span class="s">&#39;wcs_is_possible&#39;</span><span class="p">]:</span>
      <span class="n">linear</span> <span class="o">=</span> <span class="bp">True</span>
         
   <span class="n">outputfilename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">filename</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;.fits&quot;</span><span class="p">)])</span><span class="o">+</span><span class="s">&quot;_footprint_ds9_image.reg&quot;</span>
   <span class="n">outputfile</span>     <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">outputfilename</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span>
   <span class="k">if</span> <span class="n">linear</span><span class="p">:</span>
      <span class="n">outputfilename_linear</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">filename</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;.fits&quot;</span><span class="p">)])</span><span class="o">+</span><span class="s">&quot;_footprint_ds9_linear.reg&quot;</span>
      <span class="n">outputfile_linear</span>     <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">outputfilename_linear</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span>
      
   <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">outputfile</span><span class="p">,</span> <span class="s">&quot;# Region file format: DS9 version 4.0&quot;</span>
   <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">outputfile</span><span class="p">,</span> <span class="s">&quot;# Filename: </span><span class="si">%s</span><span class="s"> &quot;</span> <span class="o">%</span> <span class="n">filename</span> 
   <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">outputfile</span><span class="p">,</span> <span class="s">&#39;# global color=green font=&quot;helvetica 12 bold&quot; select=1 highlite=1 edit=1 move=1 delete=1 include=1 fixed=0 source&#39;</span>
   <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">outputfile</span><span class="p">,</span> <span class="s">&quot;image&quot;</span>

   <span class="k">if</span> <span class="n">linear</span><span class="p">:</span>
      <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">outputfile_linear</span><span class="p">,</span> <span class="s">&quot;# Region file format: DS9 version 4.0&quot;</span>
      <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">outputfile_linear</span><span class="p">,</span> <span class="s">&quot;# Filename: </span><span class="si">%s</span><span class="s"> &quot;</span> <span class="o">%</span> <span class="n">filename</span> 
      <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">outputfile_linear</span><span class="p">,</span> <span class="s">&#39;# global color=green font=&quot;helvetica 12 bold&quot; select=1 highlite=1 edit=1 move=1 delete=1 include=1 fixed=0 source&#39;</span>
      <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">outputfile_linear</span><span class="p">,</span> <span class="s">&quot;linear&quot;</span>

   <span class="k">for</span> <span class="n">fp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">simplefootprintlist</span><span class="p">)):</span>   
      <span class="n">coordinatestring</span>          <span class="o">=</span> <span class="s">&quot;&quot;</span>
      <span class="n">coordinatestring_linear</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>

      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">simplefootprintlist</span><span class="p">[</span><span class="n">fp</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
         <span class="n">j</span> <span class="o">=</span> <span class="n">i</span>
         <span class="k">if</span> <span class="n">heirarchy</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">fp</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">j</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">simplefootprintlist</span><span class="p">[</span><span class="n">fp</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">i</span>
         
         <span class="c"># Note that the x,y pixel definition in fits files runs from 1..n (actually, the</span>
         <span class="c"># only really reasonable choice!) and not from 0..n-1 as it is in python.   </span>
         <span class="n">x</span> <span class="o">=</span> <span class="n">borderpixels</span><span class="p">[</span><span class="n">simplefootprintlist</span><span class="p">[</span><span class="n">fp</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
         <span class="n">y</span> <span class="o">=</span> <span class="n">borderpixels</span><span class="p">[</span><span class="n">simplefootprintlist</span><span class="p">[</span><span class="n">fp</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
         <span class="n">coordinatestring</span> <span class="o">=</span> <span class="n">coordinatestring</span> <span class="o">+</span> <span class="s">&quot;</span><span class="si">%d</span><span class="s">,</span><span class="si">%d</span><span class="s">,&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
         <span class="k">if</span> <span class="n">linear</span><span class="p">:</span>            
            <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span> <span class="o">=</span> <span class="n">xy2rd</span><span class="p">(</span><span class="n">wcs</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
            <span class="n">coordinatestring_linear</span> <span class="o">=</span> <span class="n">coordinatestring_linear</span> <span class="o">+</span> <span class="s">&quot;</span><span class="si">%.6f</span><span class="s">,</span><span class="si">%.6f</span><span class="s">,&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">)</span>

      <span class="n">color</span> <span class="o">=</span> <span class="n">colorlist</span><span class="p">[</span><span class="n">fp</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">colorlist</span><span class="p">))]</span>
      
      <span class="n">numberstring</span> <span class="o">=</span> <span class="s">&quot;(&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;)&quot;</span>
      <span class="k">if</span> <span class="n">heirarchy</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">fp</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
         <span class="n">numberstring</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
   
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">simplefootprintlist</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
         <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">outputfile</span><span class="p">,</span><span class="s">&#39;text </span><span class="si">%d</span><span class="s"> </span><span class="si">%d</span><span class="s"> # text={</span><span class="si">%s</span><span class="s">} color=</span><span class="si">%s</span><span class="s"> font=&quot;helvetica 12 bold&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">centroid</span><span class="p">[</span><span class="n">fp</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">centroid</span><span class="p">[</span><span class="n">fp</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="n">numberstring</span><span class="p">,</span> <span class="n">color</span><span class="p">)</span>
         <span class="k">if</span> <span class="n">linear</span><span class="p">:</span>
            <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span> <span class="o">=</span> <span class="n">xy2rd</span><span class="p">(</span><span class="n">wcs</span><span class="p">,</span> <span class="n">centroid</span><span class="p">[</span><span class="n">fp</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">centroid</span><span class="p">[</span><span class="n">fp</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>         
            <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">outputfile_linear</span><span class="p">,</span> <span class="s">&#39;text </span><span class="si">%.6f</span><span class="s"> </span><span class="si">%.6f</span><span class="s"> # text={</span><span class="si">%s</span><span class="s">} color=</span><span class="si">%s</span><span class="s"> font=&quot;helvetica 12 bold&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">numberstring</span><span class="p">,</span> <span class="n">color</span><span class="p">)</span>
                     
      <span class="n">coordinatestring</span> <span class="o">=</span> <span class="s">&quot;polygon(&quot;</span><span class="o">+</span><span class="n">coordinatestring</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot;) # color=</span><span class="si">%s</span><span class="s"> width=2&quot;</span> <span class="o">%</span> <span class="n">color</span>
      <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">outputfile</span><span class="p">,</span> <span class="n">coordinatestring</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
      <span class="k">if</span> <span class="n">linear</span><span class="p">:</span>
         <span class="n">coordinatestring_linear</span> <span class="o">=</span> <span class="s">&quot;polygon(&quot;</span><span class="o">+</span><span class="n">coordinatestring_linear</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot;) # color=</span><span class="si">%s</span><span class="s"> width=2&quot;</span> <span class="o">%</span> <span class="n">color</span>
         <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">outputfile_linear</span><span class="p">,</span> <span class="n">coordinatestring_linear</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
         
   <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">outputfile</span><span class="p">,</span><span class="s">&#39;point </span><span class="si">%.6f</span><span class="s"> </span><span class="si">%.6f</span><span class="s"> # point=x color=</span><span class="si">%s</span><span class="s"> &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">centroid</span><span class="p">[</span><span class="s">&#39;total&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">centroid</span><span class="p">[</span><span class="s">&#39;total&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="s">&#39;red&#39;</span><span class="p">)</span>
   <span class="k">if</span> <span class="n">linear</span><span class="p">:</span>
      <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span> <span class="o">=</span> <span class="n">xy2rd</span><span class="p">(</span><span class="n">wcs</span><span class="p">,</span> <span class="n">centroid</span><span class="p">[</span><span class="s">&#39;total&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">centroid</span><span class="p">[</span><span class="s">&#39;total&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>         
      <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">outputfile_linear</span><span class="p">,</span> <span class="s">&#39;point </span><span class="si">%.6f</span><span class="s"> </span><span class="si">%.6f</span><span class="s"> # point=x color=</span><span class="si">%s</span><span class="s"> &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="s">&#39;red&#39;</span><span class="p">)</span>

   <span class="n">outputfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
   <span class="k">print</span> <span class="n">whocalls</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;Written to </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">outputfilename</span>
   <span class="k">if</span> <span class="n">linear</span><span class="p">:</span>
      <span class="n">outputfile_linear</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
      <span class="k">print</span> <span class="n">whocalls</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;Written to </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">outputfilename_linear</span>
         

<span class="c"># ------------------------------------------------------------------------------------------------------------------------</span>
</div>
<div class="viewcode-block" id="plotfootprints"><a class="viewcode-back" href="../../../SamPy.astronomy.html#SamPy.astronomy.footprintfinder.plotfootprints">[docs]</a><span class="k">def</span> <span class="nf">plotfootprints</span><span class="p">(</span><span class="n">simplefootprintlist</span><span class="p">,</span> <span class="n">borderpixels</span><span class="p">,</span> <span class="n">dimshape</span><span class="p">,</span> <span class="n">chips</span><span class="p">,</span> <span class="n">groupid</span><span class="p">,</span> <span class="n">firstid</span><span class="p">,</span> <span class="n">nextid</span><span class="p">,</span> <span class="n">grouplen</span><span class="p">,</span> <span class="n">heirarchy</span><span class="p">,</span> <span class="n">centroid</span><span class="p">,</span> <span class="n">colorlist</span><span class="p">,</span> <span class="n">verbose</span><span class="p">):</span>

<span class="c"># ------------------------------------------------------------------------------------------------------------------------</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      This function plots the footprints using matplotlib</span>
<span class="sd">   &quot;&quot;&quot;</span>
   <span class="kn">import</span> <span class="nn">matplotlib</span>
   <span class="n">matplotlib</span><span class="o">.</span><span class="n">interactive</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
   
   <span class="kn">import</span> <span class="nn">pylab</span>
   
   <span class="k">print</span> <span class="n">whocalls</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;Plotting ...&quot;</span>
   <span class="n">pylab</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
   <span class="n">pylab</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>   
   <span class="n">pylab</span><span class="o">.</span><span class="n">hold</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
   <span class="n">pylab</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>  
   <span class="n">pylab</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">dimshape</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="p">[</span><span class="n">dimshape</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> 
   <span class="n">ax</span> <span class="o">=</span> <span class="n">pylab</span><span class="o">.</span><span class="n">axes</span><span class="p">()</span>
   <span class="n">ax</span><span class="o">.</span><span class="n">set_autoscale_on</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
   <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s">&#39;equal&#39;</span><span class="p">,</span> <span class="s">&#39;box&#39;</span><span class="p">,</span> <span class="s">&#39;C&#39;</span><span class="p">)</span>
   <span class="n">pylab</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">dimshape</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
   <span class="n">pylab</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">dimshape</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
   
   <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">chips</span><span class="p">:</span>
      <span class="n">index</span> <span class="o">=</span> <span class="n">pylab</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">groupid</span><span class="o">==</span><span class="n">g</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
         <span class="n">pylab</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">borderpixels</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">borderpixels</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s">&#39;.&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">colorlist</span><span class="p">[(</span><span class="n">g</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">colorlist</span><span class="p">)][</span><span class="mi">0</span><span class="p">])</span>
      <span class="n">pos</span> <span class="o">=</span> <span class="n">firstid</span><span class="p">[</span><span class="n">g</span><span class="p">]</span>
      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">grouplen</span><span class="p">[</span><span class="n">g</span><span class="p">]):</span>
        <span class="c">#pylab.text(borderpixels[pos,1],borderpixels[pos,0],str(pos))</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">nextid</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span>

   <span class="k">for</span> <span class="n">fp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">simplefootprintlist</span><span class="p">)):</span>
      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">simplefootprintlist</span><span class="p">[</span><span class="n">fp</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span> 
         <span class="n">j</span>  <span class="o">=</span> <span class="n">i</span>
         <span class="n">dj</span> <span class="o">=</span> <span class="mi">1</span>
         <span class="n">numbertext</span> <span class="o">=</span> <span class="s">&quot;(&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;)&quot;</span>
         <span class="n">linestyle</span> <span class="o">=</span> <span class="s">&quot;:&quot;</span>
         <span class="k">if</span> <span class="n">heirarchy</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">fp</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">j</span>  <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">simplefootprintlist</span><span class="p">[</span><span class="n">fp</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">i</span>
            <span class="n">dj</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">numbertext</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
            <span class="n">linestyle</span> <span class="o">=</span> <span class="s">&quot;-&quot;</span>

         <span class="n">pylab</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">borderpixels</span><span class="p">[</span><span class="n">simplefootprintlist</span><span class="p">[</span><span class="n">fp</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="mi">1</span><span class="p">],</span> <span class="n">borderpixels</span><span class="p">[</span><span class="n">simplefootprintlist</span><span class="p">[</span><span class="n">fp</span><span class="p">][</span><span class="n">j</span><span class="o">+</span><span class="n">dj</span><span class="p">],</span> <span class="mi">1</span><span class="p">]],</span> \
                     <span class="p">[</span><span class="n">borderpixels</span><span class="p">[</span><span class="n">simplefootprintlist</span><span class="p">[</span><span class="n">fp</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="mi">0</span><span class="p">],</span> <span class="n">borderpixels</span><span class="p">[</span><span class="n">simplefootprintlist</span><span class="p">[</span><span class="n">fp</span><span class="p">][</span><span class="n">j</span><span class="o">+</span><span class="n">dj</span><span class="p">],</span> <span class="mi">0</span><span class="p">]],</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">linestyle</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colorlist</span><span class="p">[</span><span class="n">fp</span><span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">colorlist</span><span class="p">)][</span><span class="mi">0</span><span class="p">])</span>
         <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>                 
            <span class="n">pylab</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">borderpixels</span><span class="p">[</span><span class="n">simplefootprintlist</span><span class="p">[</span><span class="n">fp</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="mi">1</span><span class="p">]],</span> \
                        <span class="p">[</span><span class="n">borderpixels</span><span class="p">[</span><span class="n">simplefootprintlist</span><span class="p">[</span><span class="n">fp</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="mi">0</span><span class="p">]],</span> <span class="s">&#39;ko&#39;</span><span class="p">)</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="n">pylab</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">borderpixels</span><span class="p">[</span><span class="n">simplefootprintlist</span><span class="p">[</span><span class="n">fp</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="mi">1</span><span class="p">]],</span> \
                        <span class="p">[</span><span class="n">borderpixels</span><span class="p">[</span><span class="n">simplefootprintlist</span><span class="p">[</span><span class="n">fp</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="mi">0</span><span class="p">]],</span> <span class="s">&#39;k.&#39;</span><span class="p">)</span>
      
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">simplefootprintlist</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
         <span class="n">pylab</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">centroid</span><span class="p">[</span><span class="n">fp</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">centroid</span><span class="p">[</span><span class="n">fp</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="n">numbertext</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s">&quot;center&quot;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s">&quot;center&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colorlist</span><span class="p">[</span><span class="n">fp</span><span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">colorlist</span><span class="p">)][</span><span class="mi">0</span><span class="p">])</span>             
   
   <span class="n">pylab</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">centroid</span><span class="p">[</span><span class="s">&#39;total&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]],[</span><span class="n">centroid</span><span class="p">[</span><span class="s">&#39;total&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]],</span><span class="s">&#39;rx&#39;</span><span class="p">)</span>
   <span class="n">r</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
   <span class="n">r</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">(</span><span class="s">&quot;Hit return to quit &quot;</span><span class="p">)</span>
      

<span class="c"># ------------------------------------------------------------------------------------------------------------------------</span>
      </div>
<div class="viewcode-block" id="getreturnstring"><a class="viewcode-back" href="../../../SamPy.astronomy.html#SamPy.astronomy.footprintfinder.getreturnstring">[docs]</a><span class="k">def</span> <span class="nf">getreturnstring</span><span class="p">(</span><span class="n">simplefootprintlist</span><span class="p">,</span> <span class="n">borderpixels</span><span class="p">,</span> <span class="n">heirarchy</span><span class="p">,</span> <span class="n">centroid</span><span class="p">,</span> <span class="n">wcs</span><span class="p">,</span> <span class="n">verbose</span><span class="p">):</span>
   
<span class="c"># ------------------------------------------------------------------------------------------------------------------------   </span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      returns a simplified version of the footprint information that can be stored in the database</span>
<span class="sd">     </span>
<span class="sd">      x, y, ra, dec</span>
<span class="sd">      x0,y0,x1,y1,x2,y2,...; x0,y0,x1,y1,x2,y2,...;...</span>
<span class="sd">      The points are ordered anti-clickwise (chip) or clockwise (hole)</span>
<span class="sd">      </span>
<span class="sd">   &quot;&quot;&quot;</span>
   <span class="n">returnstring</span>  <span class="o">=</span> <span class="s">&quot;&quot;</span>
   <span class="k">for</span> <span class="n">fp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">simplefootprintlist</span><span class="p">)):</span>   
      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">simplefootprintlist</span><span class="p">[</span><span class="n">fp</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
         <span class="n">j</span> <span class="o">=</span> <span class="n">i</span>
         <span class="k">if</span> <span class="n">heirarchy</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">fp</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">j</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">simplefootprintlist</span><span class="p">[</span><span class="n">fp</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">i</span>
         
         <span class="c"># Note that the x,y pixel definition in fits files runs from 1..n (actually, the</span>
         <span class="c"># only really reasonable choice!) and not from 0..n-1 as it is in python.   </span>
         <span class="n">x</span> <span class="o">=</span> <span class="n">borderpixels</span><span class="p">[</span><span class="n">simplefootprintlist</span><span class="p">[</span><span class="n">fp</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
         <span class="n">y</span> <span class="o">=</span> <span class="n">borderpixels</span><span class="p">[</span><span class="n">simplefootprintlist</span><span class="p">[</span><span class="n">fp</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
         <span class="n">returnstring</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="si">%d</span><span class="s">,</span><span class="si">%d</span><span class="s">,&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
         
      <span class="n">returnstring</span> <span class="o">=</span> <span class="n">returnstring</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s">&quot;;&quot;</span>
         
   <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span> <span class="o">=</span> <span class="n">xy2rd</span><span class="p">(</span><span class="n">wcs</span><span class="p">,</span> <span class="n">centroid</span><span class="p">[</span><span class="s">&#39;total&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">centroid</span><span class="p">[</span><span class="s">&#39;total&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>        
   <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
      <span class="k">print</span> <span class="n">whocalls</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;Returning &#39;</span><span class="si">%d</span><span class="s">, </span><span class="si">%d</span><span class="s">, </span><span class="si">%f</span><span class="s">, </span><span class="si">%f</span><span class="s">, </span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">centroid</span><span class="p">[</span><span class="s">&#39;total&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">centroid</span><span class="p">[</span><span class="s">&#39;total&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">returnstring</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

   <span class="k">return</span> <span class="n">centroid</span><span class="p">[</span><span class="s">&#39;total&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">centroid</span><span class="p">[</span><span class="s">&#39;total&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">centroid</span><span class="p">[</span><span class="s">&#39;total&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">returnstring</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
         
      
<span class="c"># ------------------------------------------------------------------------------------------------------------------------</span></div>
<span class="k">if</span> <span class="n">__name__</span><span class="o">==</span><span class="s">&#39;__main__&#39;</span><span class="p">:</span>
   <span class="kn">import</span> <span class="nn">sys</span>
   <span class="n">main</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>    
</pre></div>

          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">home</a>|&nbsp;</li>
        <li><a href="../../../search.html">search</a>|&nbsp;</li>

          <li><a href="../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2011, Sami-Matias Niemi.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.0.7.
    </div>
  </body>
</html>